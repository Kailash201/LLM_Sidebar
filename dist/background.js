/*! For license information please see background.js.LICENSE.txt */
(()=>{var e={6445:(e,t)=>{"use strict";const n=["user","model","function","system"];var r,a,s,i,o,l,c,u;t.DE=void 0,(r=t.DE||(t.DE={})).HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",r.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",r.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",r.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",r.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",t.vk=void 0,(a=t.vk||(t.vk={})).HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",a.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",a.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",a.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",a.BLOCK_NONE="BLOCK_NONE",t.uR=void 0,(s=t.uR||(t.uR={})).HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",s.NEGLIGIBLE="NEGLIGIBLE",s.LOW="LOW",s.MEDIUM="MEDIUM",s.HIGH="HIGH",t.Cr=void 0,(i=t.Cr||(t.Cr={})).BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",i.SAFETY="SAFETY",i.OTHER="OTHER",t.eD=void 0,(o=t.eD||(t.eD={})).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",o.STOP="STOP",o.MAX_TOKENS="MAX_TOKENS",o.SAFETY="SAFETY",o.RECITATION="RECITATION",o.OTHER="OTHER",t.wP=void 0,(l=t.wP||(t.wP={})).TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",l.RETRIEVAL_QUERY="RETRIEVAL_QUERY",l.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",l.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",l.CLASSIFICATION="CLASSIFICATION",l.CLUSTERING="CLUSTERING",t.m0=void 0,(c=t.m0||(t.m0={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",c.AUTO="AUTO",c.ANY="ANY",c.NONE="NONE",t.wl=void 0,(u=t.wl||(t.wl={})).STRING="STRING",u.NUMBER="NUMBER",u.INTEGER="INTEGER",u.BOOLEAN="BOOLEAN",u.ARRAY="ARRAY",u.OBJECT="OBJECT";class d extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class h extends d{constructor(e,t){super(e),this.response=t}}class p extends d{constructor(e,t,n,r){super(e),this.status=t,this.statusText=n,this.errorDetails=r}}class f extends d{}const m="0.11.4",g="genai-js";var y;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(y||(y={}));class b{constructor(e,t,n,r,a){this.model=e,this.task=t,this.apiKey=n,this.stream=r,this.requestOptions=a}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let r=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}async function _(e){const t=new Headers;t.append("Content-Type","application/json"),t.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push(`${g}/${m}`),t.join(" ")}(e.requestOptions)),t.append("x-goog-api-key",e.apiKey);let n=e.requestOptions.customHeaders;if(n){if(!(n instanceof Headers))try{n=new Headers(n)}catch(e){throw new f(`unable to convert customHeaders value ${JSON.stringify(n)} to Headers: ${e.message}`)}for(const[e,r]of n.entries()){if("x-goog-api-key"===e)throw new f(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new f(`Header name ${e} can only be set using the apiClient field`);t.append(e,r)}}return t}async function w(e,t,n,r,a,s){return async function(e,t,n,r,a,s,i=fetch){const o=new b(e,t,n,r,s);let l;try{const c=await async function(e,t,n,r,a,s){const i=new b(e,t,n,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},v(s)),{method:"POST",headers:await _(i),body:a})}}(e,t,n,r,a,s);if(l=await i(c.url,c.fetchOptions),!l.ok){let e,t="";try{const n=await l.json();t=n.error.message,n.error.details&&(t+=` ${JSON.stringify(n.error.details)}`,e=n.error.details)}catch(e){}throw new p(`Error fetching from ${o.toString()}: [${l.status} ${l.statusText}] ${t}`,l.status,l.statusText,e)}}catch(e){let t=e;throw e instanceof p||e instanceof f||(t=new d(`Error fetching from ${o.toString()}: ${e.message}`),t.stack=e.stack),t}return l}(e,t,n,r,a,s,fetch)}function v(e){const t={};if((null==e?void 0:e.timeout)>=0){const n=new AbortController,r=n.signal;setTimeout((()=>n.abort()),e.timeout),t.signal=r}return t}function k(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),x(e.candidates[0]))throw new h(`${A(e)}`,e);return function(e){var t,n,r,a;const s=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===a?void 0:a.parts)t.text&&s.push(t.text);return s.length>0?s.join(""):""}(e)}if(e.promptFeedback)throw new h(`Text not available. ${A(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),x(e.candidates[0]))throw new h(`${A(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),O(e)[0]}if(e.promptFeedback)throw new h(`Function call not available. ${A(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),x(e.candidates[0]))throw new h(`${A(e)}`,e);return O(e)}if(e.promptFeedback)throw new h(`Function call not available. ${A(e)}`,e)},e}function O(e){var t,n,r,a;const s=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===a?void 0:a.parts)t.functionCall&&s.push(t.functionCall);return s.length>0?s:void 0}const E=[t.eD.RECITATION,t.eD.SAFETY];function x(e){return!!e.finishReason&&E.includes(e.finishReason)}function A(e){var t,n,r;let a="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(r=e.candidates)||void 0===r?void 0:r[0]){const t=e.candidates[0];x(t)&&(a+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(a+=`: ${t.finishMessage}`))}}else a+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(a+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(a+=`: ${e.promptFeedback.blockReasonMessage}`);return a}function S(e){return this instanceof S?(this.v=e,this):new S(e)}"function"==typeof SuppressedError&&SuppressedError;const I=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function T(e){const t=[],n=e.getReader();for(;;){const{done:e,value:r}=await n.read();if(e)return k(C(t));t.push(r)}}function P(e){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,a=n.apply(e,t||[]),s=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){a[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||o(e,t)}))})}function o(e,t){try{(n=a[e](t)).value instanceof S?Promise.resolve(n.value.v).then(l,c):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function l(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),s.shift(),s.length&&o(s[0][0],s[0][1])}}(this,arguments,(function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield S(t.read());if(n)break;yield yield S(k(e))}}))}function C(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e)if(t.candidates)for(const e of t.candidates){const t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});const r={};for(const a of e.content.parts)a.text&&(r.text=a.text),a.functionCall&&(r.functionCall=a.functionCall),0===Object.keys(r).length&&(r.text=""),n.candidates[t].content.parts.push(r)}}return n}async function R(e,t,n,r){return function(e){const t=function(e){const t=e.getReader();return new ReadableStream({start(e){let n="";return function r(){return t.read().then((({value:t,done:a})=>{if(a)return n.trim()?void e.error(new d("Failed to parse stream")):void e.close();n+=t;let s,i=n.match(I);for(;i;){try{s=JSON.parse(i[1])}catch(t){return void e.error(new d(`Error parsing JSON response: "${i[1]}"`))}e.enqueue(s),n=n.substring(i[0].length),i=n.match(I)}return r()}))}()}})}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,r]=t.tee();return{stream:P(n),response:T(r)}}(await w(t,y.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),r))}async function N(e,t,n,r){const a=await w(t,y.GENERATE_CONTENT,e,!1,JSON.stringify(n),r);return{response:k(await a.json())}}function j(e){if(null!=e)return"string"==typeof e?{role:"system",parts:[{text:e}]}:e.text?{role:"system",parts:[e]}:e.parts?e.role?e:{role:"system",parts:e.parts}:void 0}function $(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,a=!1;for(const s of e)"functionResponse"in s?(n.parts.push(s),a=!0):(t.parts.push(s),r=!0);if(r&&a)throw new d("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new d("No content is provided for sending chat message.");return r?t:n}(t)}function M(e){let t;return t=e.contents?e:{contents:[$(e)]},e.systemInstruction&&(t.systemInstruction=j(e.systemInstruction)),t}const L=["text","inlineData","functionCall","functionResponse"],D={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},U="SILENT_ERROR";class F{constructor(e,t,r,a){this.model=t,this.params=r,this.requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==r?void 0:r.history)&&(function(e){let t=!1;for(const r of e){const{role:e,parts:a}=r;if(!t&&"user"!==e)throw new d(`First content should be with role 'user', got ${e}`);if(!n.includes(e))throw new d(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(n)}`);if(!Array.isArray(a))throw new d("Content should have 'parts' property with an array of Parts");if(0===a.length)throw new d("Each Content should have at least one part");const s={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0};for(const e of a)for(const t of L)t in e&&(s[t]+=1);const i=D[e];for(const t of L)if(!i.includes(t)&&s[t]>0)throw new d(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(r.history),this._history=r.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,n,r,a,s;await this._sendPromise;const i=$(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(a=this.params)||void 0===a?void 0:a.toolConfig,systemInstruction:null===(s=this.params)||void 0===s?void 0:s.systemInstruction,contents:[...this._history,i]};let l;return this._sendPromise=this._sendPromise.then((()=>N(this._apiKey,this.model,o,this.requestOptions))).then((e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(i);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{const t=A(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e})),await this._sendPromise,l}async sendMessageStream(e){var t,n,r,a,s;await this._sendPromise;const i=$(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(a=this.params)||void 0===a?void 0:a.toolConfig,systemInstruction:null===(s=this.params)||void 0===s?void 0:s.systemInstruction,contents:[...this._history,i]},l=R(this._apiKey,this.model,o,this.requestOptions);return this._sendPromise=this._sendPromise.then((()=>l)).catch((e=>{throw new Error(U)})).then((e=>e.response)).then((e=>{if(e.candidates&&e.candidates.length>0){this._history.push(i);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=A(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}})).catch((e=>{e.message!==U&&console.error(e)})),l}}class z{constructor(e,t,n){this.apiKey=e,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=j(t.systemInstruction),this.requestOptions=n||{}}async generateContent(e){const t=M(e);return N(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(e){const t=M(e);return R(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(e){return new F(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},e),this.requestOptions)}async countTokens(e){const t=M(e);return async function(e,t,n,r){return(await w(t,y.COUNT_TOKENS,e,!1,JSON.stringify(Object.assign(Object.assign({},n),{model:t})),r)).json()}(this.apiKey,this.model,t,this.requestOptions)}async embedContent(e){const t="string"==typeof(n=e)||Array.isArray(n)?{content:$(n)}:n;var n;return async function(e,t,n,r){return(await w(t,y.EMBED_CONTENT,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(e){return async function(e,t,n,r){const a=n.requests.map((e=>Object.assign(Object.assign({},e),{model:t})));return(await w(t,y.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:a}),r)).json()}(this.apiKey,this.model,e,this.requestOptions)}}t.ij=class{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new d("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new z(this.apiKey,e,t)}}},9418:(e,t,n)=>{"use strict";e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,a]of Object.entries(r))t[n]={open:`[${a[0]}m`,close:`[${a[1]}m`},r[n]=t[n],e.set(a[0],a[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=a(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},9120:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});const r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var a,s=new Uint8Array(16);function i(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(s)}for(var o=[],l=0;l<256;++l)o.push((l+256).toString(16).slice(1));const c=function(e,t,n){if(r.randomUUID&&!t&&!e)return r.randomUUID();var a=(e=e||{}).random||(e.rng||i)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){n=n||0;for(var s=0;s<16;++s)t[n+s]=a[s];return t}return function(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}(a)}},7526:(e,t)=>{"use strict";t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,s=o(e),i=s[0],l=s[1],c=new a(function(e,t,n){return 3*(t+n)/4-n}(0,i,l)),u=0,d=l>0?i-4:i;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===l&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,c[u++]=255&t),1===l&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c},t.fromByteArray=function(e){for(var t,r=e.length,a=r%3,s=[],i=16383,o=0,c=r-a;o<c;o+=i)s.push(l(e,o,o+i>c?c:o+i));return 1===a?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),s.join("")};for(var n=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0;i<64;++i)n[i]=s[i],r[s.charCodeAt(i)]=i;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,r){for(var a,s,i=[],o=t;o<r;o+=3)a=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(n[(s=a)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return i.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},2729:e=>{"use strict";const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),o=new RegExp(s.source+a.source,"gu"),l=new RegExp("\\d+"+a.source,"gu"),c=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const s=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),c=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?c(e):s(e):(e!==s(e)&&(e=((e,r,a)=>{let s=!1,i=!1,o=!1;for(let l=0;l<e.length;l++){const c=e[l];s&&t.test(c)?(e=e.slice(0,l)+"-"+e.slice(l),s=!1,o=i,i=!0,l++):i&&o&&n.test(c)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=i,i=!1,s=!0):(s=r(c)===c&&a(c)!==c,o=i,i=a(c)===c&&r(c)!==c)}return e})(e,s,c)),e=e.replace(i,""),e=a.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,(e=>t(e)))))(e,s):s(e),a.pascalCase&&(e=c(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,l.lastIndex=0,e.replace(o,((e,n)=>t(n))).replace(l,(e=>t(e)))))(e,c))};e.exports=c,e.exports.default=c},9478:e=>{"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function a(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,r,s,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new a(r,s||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,a=[];if(0===this._eventsCount)return a;for(r in e=this._events)t.call(e,r)&&a.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,a,s,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,a);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,a){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return i(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||a&&!o.once||r&&o.context!==r||i(this,s);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||a&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[s]=1===c.length?c[0]:c:i(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},5230:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});const r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var a,s=new Uint8Array(16);function i(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(s)}for(var o=[],l=0;l<256;++l)o.push((l+256).toString(16).slice(1));const c=function(e,t,n){if(r.randomUUID&&!t&&!e)return r.randomUUID();var a=(e=e||{}).random||(e.rng||i)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){n=n||0;for(var s=0;s<16;++s)t[n+s]=a[s];return t}return function(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}(a)}},4617:e=>{"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))))},3290:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(228),a=n(6641),s=n(4774),i=()=>{},o=new a.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=i,this._resolveIdle=i,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:s.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=i,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=i,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},9998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,a=e.length;for(;a>0;){const s=a/2|0;let i=r+s;n(e[i],t)<=0?(r=++i,a-=s+1):a=s}return r}},4774:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const a=r.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(a,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}},4116:(e,t,n)=>{"use strict";const r=n(5617),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const i=(e,t)=>new Promise(((n,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=r.operation(t);o.attempt((async r=>{try{n(await e(r))}catch(e){if(!(e instanceof Error))return void i(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)o.stop(),i(e.originalError);else if(e instanceof TypeError&&(l=e.message,!a.includes(l)))o.stop(),i(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,r,t);try{await t.onFailedAttempt(e)}catch(e){return void i(e)}o.retry(e)||i(o.mainError())}}var l}))}));e.exports=i,e.exports.default=i,e.exports.AbortError=s},6641:(e,t,n)=>{"use strict";const r=n(4617);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const s=(e,t,n)=>new Promise(((s,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void s(e);const o=setTimeout((()=>{if("function"==typeof n){try{s(n())}catch(e){i(e)}return}const r=n instanceof Error?n:new a("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(r)}),t);r(e.then(s,i),(()=>{clearTimeout(o)}))}));e.exports=s,e.exports.default=s,e.exports.TimeoutError=a},5617:(e,t,n)=>{e.exports=n(8303)},8303:(e,t,n)=>{var r=n(3961);t.operation=function(e){var n=t.timeouts(e);return new r(n,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<t.retries;a++)r.push(this.createTimeout(a,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(a,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var a in r=[],e)"function"==typeof e[a]&&r.push(a);for(var s=0;s<r.length;s++){var i=r[s],o=e[i];e[i]=function(r){var a=t.operation(n),s=Array.prototype.slice.call(arguments,1),i=s.pop();s.push((function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),i.apply(this,arguments))})),a.attempt((function(){r.apply(e,s)}))}.bind(e,o),e[i].options=n}}},3961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(e[s]||0)+1;e[s]=i,i>=n&&(t=a,n=i)}return t}},3904:(e,t,n)=>{const r=Symbol("SemVer ANY");class a{static get ANY(){return r}constructor(e,t){if(t=s(t),e instanceof a){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),c("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===r?this.value="":this.value=this.operator+this.semver.version,c("comp",this)}parse(e){const t=this.options.loose?i[o.COMPARATORLOOSE]:i[o.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==n[1]?n[1]:"","="===this.operator&&(this.operator=""),n[2]?this.semver=new u(n[2],this.options.loose):this.semver=r}toString(){return this.value}test(e){if(c("Comparator.test",e,this.options.loose),this.semver===r||e===r)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return l(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=s(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(l(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(l(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=a;const s=n(8587),{safeRe:i,t:o}=n(9718),l=n(2111),c=n(7272),u=n(3908),d=n(8311)},8311:(e,t,n)=>{const r=/\s+/g;class a{constructor(e,t){if(t=i(t),e instanceof a)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new a(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(r," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!y(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&b(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,n=s.get(t);if(n)return n;const r=this.options.loose,a=r?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(a,P(this.options.includePrerelease)),l("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],h),l("comparator trim",e),e=e.replace(u[d.TILDETRIM],p),l("tilde trim",e),e=e.replace(u[d.CARETTRIM],f),l("caret trim",e);let i=e.split(" ").map((e=>w(e,this.options))).join(" ").split(/\s+/).map((e=>T(e,this.options)));r&&(i=i.filter((e=>(l("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE]))))),l("range list",i);const c=new Map,b=i.map((e=>new o(e,this.options)));for(const e of b){if(y(e))return[e];c.set(e.value,e)}c.size>1&&c.has("")&&c.delete("");const _=[...c.values()];return s.set(t,_),_}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Range is required");return this.set.some((n=>_(n,t)&&e.set.some((e=>_(e,t)&&n.every((n=>e.every((e=>n.intersects(e,t)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new c(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(C(this.set[t],e,this.options))return!0;return!1}}e.exports=a;const s=new(n(8794)),i=n(8587),o=n(3904),l=n(7272),c=n(3908),{safeRe:u,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=n(9718),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=n(6874),y=e=>"<0.0.0-0"===e.value,b=e=>""===e.value,_=(e,t)=>{let n=!0;const r=e.slice();let a=r.pop();for(;n&&r.length;)n=r.every((e=>a.intersects(e,t))),a=r.pop();return n},w=(e,t)=>(l("comp",e,t),e=E(e,t),l("caret",e),e=k(e,t),l("tildes",e),e=A(e,t),l("xrange",e),e=I(e,t),l("stars",e),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,k=(e,t)=>e.trim().split(/\s+/).map((e=>O(e,t))).join(" "),O=(e,t)=>{const n=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(n,((t,n,r,a,s)=>{let i;return l("tilde",e,t,n,r,a,s),v(n)?i="":v(r)?i=`>=${n}.0.0 <${+n+1}.0.0-0`:v(a)?i=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:s?(l("replaceTilde pr",s),i=`>=${n}.${r}.${a}-${s} <${n}.${+r+1}.0-0`):i=`>=${n}.${r}.${a} <${n}.${+r+1}.0-0`,l("tilde return",i),i}))},E=(e,t)=>e.trim().split(/\s+/).map((e=>x(e,t))).join(" "),x=(e,t)=>{l("caret",e,t);const n=t.loose?u[d.CARETLOOSE]:u[d.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,((t,n,a,s,i)=>{let o;return l("caret",e,t,n,a,s,i),v(n)?o="":v(a)?o=`>=${n}.0.0${r} <${+n+1}.0.0-0`:v(s)?o="0"===n?`>=${n}.${a}.0${r} <${n}.${+a+1}.0-0`:`>=${n}.${a}.0${r} <${+n+1}.0.0-0`:i?(l("replaceCaret pr",i),o="0"===n?"0"===a?`>=${n}.${a}.${s}-${i} <${n}.${a}.${+s+1}-0`:`>=${n}.${a}.${s}-${i} <${n}.${+a+1}.0-0`:`>=${n}.${a}.${s}-${i} <${+n+1}.0.0-0`):(l("no pr"),o="0"===n?"0"===a?`>=${n}.${a}.${s}${r} <${n}.${a}.${+s+1}-0`:`>=${n}.${a}.${s}${r} <${n}.${+a+1}.0-0`:`>=${n}.${a}.${s} <${+n+1}.0.0-0`),l("caret return",o),o}))},A=(e,t)=>(l("replaceXRanges",e,t),e.split(/\s+/).map((e=>S(e,t))).join(" ")),S=(e,t)=>{e=e.trim();const n=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(n,((n,r,a,s,i,o)=>{l("xRange",e,n,r,a,s,i,o);const c=v(a),u=c||v(s),d=u||v(i),h=d;return"="===r&&h&&(r=""),o=t.includePrerelease?"-0":"",c?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&h?(u&&(s=0),i=0,">"===r?(r=">=",u?(a=+a+1,s=0,i=0):(s=+s+1,i=0)):"<="===r&&(r="<",u?a=+a+1:s=+s+1),"<"===r&&(o="-0"),n=`${r+a}.${s}.${i}${o}`):u?n=`>=${a}.0.0${o} <${+a+1}.0.0-0`:d&&(n=`>=${a}.${s}.0${o} <${a}.${+s+1}.0-0`),l("xRange return",n),n}))},I=(e,t)=>(l("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),T=(e,t)=>(l("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),P=e=>(t,n,r,a,s,i,o,l,c,u,d,h)=>`${n=v(r)?"":v(a)?`>=${r}.0.0${e?"-0":""}`:v(s)?`>=${r}.${a}.0${e?"-0":""}`:i?`>=${n}`:`>=${n}${e?"-0":""}`} ${l=v(c)?"":v(u)?`<${+c+1}.0.0-0`:v(d)?`<${c}.${+u+1}.0-0`:h?`<=${c}.${u}.${d}-${h}`:e?`<${c}.${u}.${+d+1}-0`:`<=${l}`}`.trim(),C=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(l(e[n].semver),e[n].semver!==o.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0}},3908:(e,t,n)=>{const r=n(7272),{MAX_LENGTH:a,MAX_SAFE_INTEGER:s}=n(6874),{safeRe:i,t:o}=n(9718),l=n(8587),{compareIdentifiers:c}=n(1123);class u{constructor(e,t){if(t=l(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>a)throw new TypeError(`version is longer than ${a} characters`);r("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const n=e.trim().match(t.loose?i[o.LOOSE]:i[o.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>s||this.major<0)throw new TypeError("Invalid major version");if(this.minor>s||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>s||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<s)return t}return e})):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(r("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),c(this.major,e.major)||c(this.minor,e.minor)||c(this.patch,e.patch)}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const n=this.prerelease[t],a=e.prerelease[t];if(r("prerelease compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return c(n,a)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const n=this.build[t],a=e.build[t];if(r("build compare",t,n,a),void 0===n&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===n)return-1;if(n!==a)return c(n,a)}while(++t)}inc(e,t,n){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===c(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},7414:(e,t,n)=>{const r=n(144);e.exports=(e,t)=>{const n=r(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null}},2111:(e,t,n)=>{const r=n(4641),a=n(3999),s=n(5580),i=n(4089),o=n(7059),l=n(5200);e.exports=(e,t,n,c)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return r(e,n,c);case"!=":return a(e,n,c);case">":return s(e,n,c);case">=":return i(e,n,c);case"<":return o(e,n,c);case"<=":return l(e,n,c);default:throw new TypeError(`Invalid operator: ${t}`)}}},6170:(e,t,n)=>{const r=n(3908),a=n(144),{safeRe:s,t:i}=n(9718);e.exports=(e,t)=>{if(e instanceof r)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?s[i.COERCERTLFULL]:s[i.COERCERTL];let a;for(;(a=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&a.index+a[0].length===n.index+n[0].length||(n=a),r.lastIndex=a.index+a[1].length+a[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?s[i.COERCEFULL]:s[i.COERCE]);if(null===n)return null;const o=n[2],l=n[3]||"0",c=n[4]||"0",u=t.includePrerelease&&n[5]?`-${n[5]}`:"",d=t.includePrerelease&&n[6]?`+${n[6]}`:"";return a(`${o}.${l}.${c}${u}${d}`,t)}},909:(e,t,n)=>{const r=n(3908);e.exports=(e,t,n)=>{const a=new r(e,n),s=new r(t,n);return a.compare(s)||a.compareBuild(s)}},1763:(e,t,n)=>{const r=n(560);e.exports=(e,t)=>r(e,t,!0)},560:(e,t,n)=>{const r=n(3908);e.exports=(e,t,n)=>new r(e,n).compare(new r(t,n))},1832:(e,t,n)=>{const r=n(144);e.exports=(e,t)=>{const n=r(e,null,!0),a=r(t,null,!0),s=n.compare(a);if(0===s)return null;const i=s>0,o=i?n:a,l=i?a:n,c=!!o.prerelease.length;if(l.prerelease.length&&!c)return l.patch||l.minor?o.patch?"patch":o.minor?"minor":"major":"major";const u=c?"pre":"";return n.major!==a.major?u+"major":n.minor!==a.minor?u+"minor":n.patch!==a.patch?u+"patch":"prerelease"}},4641:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>0===r(e,t,n)},5580:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>r(e,t,n)>0},4089:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>r(e,t,n)>=0},3007:(e,t,n)=>{const r=n(3908);e.exports=(e,t,n,a,s)=>{"string"==typeof n&&(s=a,a=n,n=void 0);try{return new r(e instanceof r?e.version:e,n).inc(t,a,s).version}catch(e){return null}}},7059:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>r(e,t,n)<0},5200:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>r(e,t,n)<=0},2938:(e,t,n)=>{const r=n(3908);e.exports=(e,t)=>new r(e,t).major},6254:(e,t,n)=>{const r=n(3908);e.exports=(e,t)=>new r(e,t).minor},3999:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>0!==r(e,t,n)},144:(e,t,n)=>{const r=n(3908);e.exports=(e,t,n=!1)=>{if(e instanceof r)return e;try{return new r(e,t)}catch(e){if(!n)return null;throw e}}},4493:(e,t,n)=>{const r=n(3908);e.exports=(e,t)=>new r(e,t).patch},1729:(e,t,n)=>{const r=n(144);e.exports=(e,t)=>{const n=r(e,t);return n&&n.prerelease.length?n.prerelease:null}},9970:(e,t,n)=>{const r=n(560);e.exports=(e,t,n)=>r(t,e,n)},4277:(e,t,n)=>{const r=n(909);e.exports=(e,t)=>e.sort(((e,n)=>r(n,e,t)))},7638:(e,t,n)=>{const r=n(8311);e.exports=(e,t,n)=>{try{t=new r(t,n)}catch(e){return!1}return t.test(e)}},3927:(e,t,n)=>{const r=n(909);e.exports=(e,t)=>e.sort(((e,n)=>r(e,n,t)))},6953:(e,t,n)=>{const r=n(144);e.exports=(e,t)=>{const n=r(e,t);return n?n.version:null}},9589:(e,t,n)=>{const r=n(9718),a=n(6874),s=n(3908),i=n(1123),o=n(144),l=n(6953),c=n(7414),u=n(3007),d=n(1832),h=n(2938),p=n(6254),f=n(4493),m=n(1729),g=n(560),y=n(9970),b=n(1763),_=n(909),w=n(3927),v=n(4277),k=n(5580),O=n(7059),E=n(4641),x=n(3999),A=n(4089),S=n(5200),I=n(2111),T=n(6170),P=n(3904),C=n(8311),R=n(7638),N=n(7631),j=n(9628),$=n(270),M=n(1261),L=n(3874),D=n(7075),U=n(5571),F=n(5342),z=n(6780),B=n(2525),Z=n(5032);e.exports={parse:o,valid:l,clean:c,inc:u,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:y,compareLoose:b,compareBuild:_,sort:w,rsort:v,gt:k,lt:O,eq:E,neq:x,gte:A,lte:S,cmp:I,coerce:T,Comparator:P,Range:C,satisfies:R,toComparators:N,maxSatisfying:j,minSatisfying:$,minVersion:M,validRange:L,outside:D,gtr:U,ltr:F,intersects:z,simplifyRange:B,subset:Z,SemVer:s,re:r.re,src:r.src,tokens:r.t,SEMVER_SPEC_VERSION:a.SEMVER_SPEC_VERSION,RELEASE_TYPES:a.RELEASE_TYPES,compareIdentifiers:i.compareIdentifiers,rcompareIdentifiers:i.rcompareIdentifiers}},6874:e=>{const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},7272:e=>{const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},1123:e=>{const t=/^[0-9]+$/,n=(e,n)=>{const r=t.test(e),a=t.test(n);return r&&a&&(e=+e,n=+n),e===n?0:r&&!a?-1:a&&!r?1:e<n?-1:1};e.exports={compareIdentifiers:n,rcompareIdentifiers:(e,t)=>n(t,e)}},8794:e=>{e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},8587:e=>{const t=Object.freeze({loose:!0}),n=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:n},9718:(e,t,n)=>{const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:s}=n(6874),i=n(7272),o=(t=e.exports={}).re=[],l=t.safeRe=[],c=t.src=[],u=t.t={};let d=0;const h="[a-zA-Z0-9-]",p=[["\\s",1],["\\d",s],[h,a]],f=(e,t,n)=>{const r=(e=>{for(const[t,n]of p)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),a=d++;i(e,a,t),u[e]=a,c[a]=t,o[a]=new RegExp(t,n?"g":void 0),l[a]=new RegExp(r,n?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),f("MAINVERSION",`(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})\\.(${c[u.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})\\.(${c[u.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${c[u.NUMERICIDENTIFIER]}|${c[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${c[u.NUMERICIDENTIFIERLOOSE]}|${c[u.NONNUMERICIDENTIFIER]})`),f("PRERELEASE",`(?:-(${c[u.PRERELEASEIDENTIFIER]}(?:\\.${c[u.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${c[u.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[u.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${h}+`),f("BUILD",`(?:\\+(${c[u.BUILDIDENTIFIER]}(?:\\.${c[u.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${c[u.MAINVERSION]}${c[u.PRERELEASE]}?${c[u.BUILD]}?`),f("FULL",`^${c[u.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${c[u.MAINVERSIONLOOSE]}${c[u.PRERELEASELOOSE]}?${c[u.BUILD]}?`),f("LOOSE",`^${c[u.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${c[u.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${c[u.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:\\.(${c[u.XRANGEIDENTIFIER]})(?:${c[u.PRERELEASE]})?${c[u.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[u.XRANGEIDENTIFIERLOOSE]})(?:${c[u.PRERELEASELOOSE]})?${c[u.BUILD]}?)?)?`),f("XRANGE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${c[u.GTLT]}\\s*${c[u.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),f("COERCE",`${c[u.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",c[u.COERCEPLAIN]+`(?:${c[u.PRERELEASE]})?`+`(?:${c[u.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",c[u.COERCE],!0),f("COERCERTLFULL",c[u.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${c[u.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${c[u.LONETILDE]}${c[u.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${c[u.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${c[u.LONECARET]}${c[u.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${c[u.LONECARET]}${c[u.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${c[u.GTLT]}\\s*(${c[u.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${c[u.GTLT]}\\s*(${c[u.LOOSEPLAIN]}|${c[u.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${c[u.XRANGEPLAIN]})\\s+-\\s+(${c[u.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${c[u.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[u.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},5571:(e,t,n)=>{const r=n(7075);e.exports=(e,t,n)=>r(e,t,">",n)},6780:(e,t,n)=>{const r=n(8311);e.exports=(e,t,n)=>(e=new r(e,n),t=new r(t,n),e.intersects(t,n))},5342:(e,t,n)=>{const r=n(7075);e.exports=(e,t,n)=>r(e,t,"<",n)},9628:(e,t,n)=>{const r=n(3908),a=n(8311);e.exports=(e,t,n)=>{let s=null,i=null,o=null;try{o=new a(t,n)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(s&&-1!==i.compare(e)||(s=e,i=new r(s,n)))})),s}},270:(e,t,n)=>{const r=n(3908),a=n(8311);e.exports=(e,t,n)=>{let s=null,i=null,o=null;try{o=new a(t,n)}catch(e){return null}return e.forEach((e=>{o.test(e)&&(s&&1!==i.compare(e)||(s=e,i=new r(s,n)))})),s}},1261:(e,t,n)=>{const r=n(3908),a=n(8311),s=n(5580);e.exports=(e,t)=>{e=new a(e,t);let n=new r("0.0.0");if(e.test(n))return n;if(n=new r("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let i=null;a.forEach((e=>{const t=new r(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":i&&!s(t,i)||(i=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!i||n&&!s(n,i)||(n=i)}return n&&e.test(n)?n:null}},7075:(e,t,n)=>{const r=n(3908),a=n(3904),{ANY:s}=a,i=n(8311),o=n(7638),l=n(5580),c=n(7059),u=n(5200),d=n(4089);e.exports=(e,t,n,h)=>{let p,f,m,g,y;switch(e=new r(e,h),t=new i(t,h),n){case">":p=l,f=u,m=c,g=">",y=">=";break;case"<":p=c,f=d,m=l,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let n=0;n<t.set.length;++n){const r=t.set[n];let i=null,o=null;if(r.forEach((e=>{e.semver===s&&(e=new a(">=0.0.0")),i=i||e,o=o||e,p(e.semver,i.semver,h)?i=e:m(e.semver,o.semver,h)&&(o=e)})),i.operator===g||i.operator===y)return!1;if((!o.operator||o.operator===g)&&f(e,o.semver))return!1;if(o.operator===y&&m(e,o.semver))return!1}return!0}},2525:(e,t,n)=>{const r=n(7638),a=n(560);e.exports=(e,t,n)=>{const s=[];let i=null,o=null;const l=e.sort(((e,t)=>a(e,t,n)));for(const e of l)r(e,t,n)?(o=e,i||(i=e)):(o&&s.push([i,o]),o=null,i=null);i&&s.push([i,null]);const c=[];for(const[e,t]of s)e===t?c.push(e):t||e!==l[0]?t?e===l[0]?c.push(`<=${t}`):c.push(`${e} - ${t}`):c.push(`>=${e}`):c.push("*");const u=c.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},5032:(e,t,n)=>{const r=n(8311),a=n(3904),{ANY:s}=a,i=n(7638),o=n(560),l=[new a(">=0.0.0-0")],c=[new a(">=0.0.0")],u=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===s){if(1===t.length&&t[0].semver===s)return!0;e=n.includePrerelease?l:c}if(1===t.length&&t[0].semver===s){if(n.includePrerelease)return!0;t=c}const r=new Set;let a,u,p,f,m,g,y;for(const t of e)">"===t.operator||">="===t.operator?a=d(a,t,n):"<"===t.operator||"<="===t.operator?u=h(u,t,n):r.add(t.semver);if(r.size>1)return null;if(a&&u){if(p=o(a.semver,u.semver,n),p>0)return null;if(0===p&&(">="!==a.operator||"<="!==u.operator))return null}for(const e of r){if(a&&!i(e,String(a),n))return null;if(u&&!i(e,String(u),n))return null;for(const r of t)if(!i(e,String(r),n))return!1;return!0}let b=!(!u||n.includePrerelease||!u.semver.prerelease.length)&&u.semver,_=!(!a||n.includePrerelease||!a.semver.prerelease.length)&&a.semver;b&&1===b.prerelease.length&&"<"===u.operator&&0===b.prerelease[0]&&(b=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,a)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),">"===e.operator||">="===e.operator){if(f=d(a,e,n),f===e&&f!==a)return!1}else if(">="===a.operator&&!i(a.semver,String(e),n))return!1;if(u)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),"<"===e.operator||"<="===e.operator){if(m=h(u,e,n),m===e&&m!==u)return!1}else if("<="===u.operator&&!i(u.semver,String(e),n))return!1;if(!e.operator&&(u||a)&&0!==p)return!1}return!(a&&g&&!u&&0!==p||u&&y&&!a&&0!==p||_||b)},d=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,n={})=>{if(e===t)return!0;e=new r(e,n),t=new r(t,n);let a=!1;e:for(const r of e.set){for(const e of t.set){const t=u(r,e,n);if(a=a||null!==t,t)continue e}if(a)return!1}return!0}},7631:(e,t,n)=>{const r=n(8311);e.exports=(e,t)=>new r(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")))},3874:(e,t,n)=>{const r=n(8311);e.exports=(e,t)=>{try{return new r(e,t).range||"*"}catch(e){return null}}},5960:(e,t,n)=>{"use strict";n.d(t,{NK:()=>l,xL:()=>o,zr:()=>c});var r=n(9120),a=n(8999),s=n(9583);class i{}function o(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class l extends i{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,a.Z)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,s.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return a.y.prototype.toJSON.call(this)}toJSONNotImplemented(){return a.y.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends l{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:r.A()}),Object.assign(this,e)}}}}const c=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers}},5780:(e,t,n)=>{"use strict";n.d(t,{Td:()=>j,tW:()=>$,H_:()=>S});var r=n(9120),a=n(5960),s=n(9418),i=n(1590);function o(e,t){return`${e.open}${t}${e.close}`}function l(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function c(e){return"string"==typeof e?e.trim():null==e?e:l(e,e.toString())}function u(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:d}=s;class h extends i.J{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?o(s.bold,r):r})).join(" > ");return o(d.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[chain/start]")} [${t}] Entering Chain run with input: ${l(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[chain/end]")} [${t}] [${u(e)}] Exiting Chain run with output: ${l(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[chain/error]")} [${t}] [${u(e)}] Chain run errored with error: ${l(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${o(d.green,"[llm/start]")} [${t}] Entering LLM run with input: ${l(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[llm/end]")} [${t}] [${u(e)}] Exiting LLM run with output: ${l(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[llm/error]")} [${t}] [${u(e)}] LLM run errored with error: ${l(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[tool/start]")} [${t}] Entering Tool run with input: "${c(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[tool/end]")} [${t}] [${u(e)}] Exiting Tool run with output: "${c(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[tool/error]")} [${t}] [${u(e)}] Tool run errored with error: ${l(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${l(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.cyan,"[retriever/end]")} [${t}] [${u(e)}] Exiting Retriever run with output: ${l(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${o(d.red,"[retriever/error]")} [${t}] [${u(e)}] Retriever run errored with error: ${l(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${o(d.blue,"[agent/action]")} [${n}] Agent selected action: ${l(t.actions[t.actions.length-1],"[action]")}`)}}var p=n(6362),f=n(9583),m=n(3246),g=n(3389),y=n(1259);let b;const _=()=>{if(void 0===b){const e="false"===(0,f.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};b=new y.Kj(e)}return b};class w extends i.J{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??(0,f.Az)("LANGCHAIN_PROJECT")??(0,f.Az)("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??_();const a=w.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await(0,f.Ec)()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const n=new Set;for(;t.parent_run&&!n.has(t.id)&&(n.add(t.id),t.parent_run);)t=t.parent_run;n.clear();const r=[t];for(;r.length>0;){const e=r.shift();e&&!n.has(e.id)&&(n.add(e.id),this.runMap.set(e.id,e),e.child_runs&&r.push(...e.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},n=[];for(const[e,r]of this.runMap){const a=new m.gk({...r,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[e]=a,n.push([e,r.dotted_order])}n.sort(((e,t)=>e[1]&&t[1]?e[1].localeCompare(t[1]):0));for(const[e]of n){const n=this.runMap.get(e),r=t[e];if(n&&r&&n.parent_run_id){const e=t[n.parent_run_id];e&&(e.child_runs.push(r),r.parent_run=e)}}return t[e]}static getTraceableRunTree(){try{return(0,g.vR)()}catch{return}}}var v=n(3290),k=n(6968);let O;async function E(e,t){if(!0===t){const t=(0,k.X0)();void 0!==t?await t.run(void 0,(async()=>e())):await e()}else void 0===O&&(O=new(0,v.default)({autoStart:!0,concurrency:1})),O.add((async()=>{const t=(0,k.X0)();void 0!==t?await t.run(void 0,(async()=>e())):await e()}))}function x(e){const t=(0,k.X0)();if(void 0===t)return;const n=t.getStore();return n?.[k.hr]?.[e]}const A=Symbol("lc:configure_hooks");function S(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class I{setHandler(e){return this.setHandlers([e])}}class T{constructor(e,t,n,r,a,s,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>E((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleCustomEvent(e,t,n,r,a){await Promise.all(this.handlers.map((n=>E((async()=>{try{await(n.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}}class P extends T{getChild(e){const t=new j(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class C extends T{async handleLLMNewToken(e,t,n,r,a,s){await Promise.all(this.handlers.map((n=>E((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class R extends T{getChild(e){const t=new j(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,a){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,a){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class N extends T{getChild(e){const t=new j(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>E((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class j extends I{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,a=void 0,s=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(t.map((async(t,a)=>{const o=0===a&&n?n:(0,r.A)();return await Promise.all(this.handlers.map((n=>{if(!n.ignoreLLM)return(0,i.j)(n)&&n._createRunForLLMStart(e,[t],o,this._parentRunId,s,this.tags,this.metadata,c),E((async()=>{try{await(n.handleLLMStart?.(e,[t],o,this._parentRunId,s,this.tags,this.metadata,c))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new C(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,n=void 0,a=void 0,s=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(t.map((async(t,a)=>{const o=0===a&&n?n:(0,r.A)();return await Promise.all(this.handlers.map((n=>{if(!n.ignoreLLM)return(0,i.j)(n)&&n._createRunForChatModelStart(e,[t],o,this._parentRunId,s,this.tags,this.metadata,c),E((async()=>{try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],o,this._parentRunId,s,this.tags,this.metadata,c));else if(n.handleLLMStart){const r=(0,p.Sw)(t);await(n.handleLLMStart?.(e,[r],o,this._parentRunId,s,this.tags,this.metadata,c))}}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new C(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,n=(0,r.A)(),a=void 0,s=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map((r=>{if(!r.ignoreChain)return(0,i.j)(r)&&r._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,a,l),E((async()=>{try{await(r.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,a,l))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleChainStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new R(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=(0,r.A)(),a=void 0,s=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map((r=>{if(!r.ignoreAgent)return(0,i.j)(r)&&r._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,l),E((async()=>{try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,l))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new N(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=(0,r.A)(),a=void 0,s=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map((r=>{if(!r.ignoreRetriever)return(0,i.j)(r)&&r._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,l),E((async()=>{try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,l))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)}))),new P(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,a){await Promise.all(this.handlers.map((r=>E((async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new j(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){class t extends a.NK{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,r.A)()}),Object.assign(this,e)}}const n=new this;return n.addHandler(new t),n}static configure(e,t,n,r,a,s,i){return this._configureSync(e,t,n,r,a,s,i)}static _configureSync(e,t,n,r,s,i,o){let l;(e||t)&&(Array.isArray(e)||!e?(l=new j,l.setHandlers(e?.map($)??[],!0)):l=e,l=l.copy(Array.isArray(t)?t.map($):t?.handlers,!1));const c="true"===(0,f.Az)("LANGCHAIN_VERBOSE")||o?.verbose,u=w.getTraceableRunTree()?.tracingEnabled||!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===(0,f.Az)(e))),d=u||((0,f.Az)("LANGCHAIN_TRACING")??!1);if(c||d){if(l||(l=new j),c&&!l.handlers.some((e=>e.name===h.prototype.name))){const e=new h;l.addHandler(e,!0)}if(d&&!l.handlers.some((e=>"langchain_tracer"===e.name))&&u){const e=new w;l.addHandler(e,!0),l._parentRunId=w.getTraceableRunTree()?.id??l._parentRunId}}for(const{contextVar:e,inheritable:t=!0,handlerClass:n,envVar:r}of x(A)||[]){const s=r&&"true"===(0,f.Az)(r)&&n;let i;const o=void 0!==e?x(e):void 0;o&&(0,a.zr)(o)?i=o:s&&(i=new n({})),void 0!==i&&(l||(l=new j),l.handlers.some((e=>e.name===i.name))||l.addHandler(i,t))}return(n||r)&&l&&(l.addTags(n??[]),l.addTags(r??[],!1)),(s||i)&&l&&(l.addMetadata(s??{}),l.addMetadata(i??{},!1)),l}}function $(e){return"name"in e?e:a.NK.fromMethods(e)}},1368:(e,t,n)=>{"use strict";function r(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}n.d(t,{Y:()=>r})},8999:(e,t,n)=>{"use strict";n.d(t,{y:()=>c,Z:()=>l});var r=n(9478);function a(e,t){return t?.[e]||r(e)}function s(e,t,n){const r={};for(const a in e)Object.hasOwn(e,a)&&(r[t(a,n)]=e[a]);return r}function i(e){return Array.isArray(e)?[...e]:{...e}}function o(e,t){const n=i(e);for(const[e,r]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let s=n;for(const e of a.reverse()){if(void 0===s[e])break;s[e]=i(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[r]})}return n}function l(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}n(2729);class c{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,l(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof c||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[a,...s]=e.split(".").reverse();for(const e of s.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}a in t&&void 0!==t[a]&&(r[a]=r[a]||t[a])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:s(Object.keys(t).length?o(n,t):n,a,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},7765:(e,t,n)=>{"use strict";n.d(t,{H:()=>c,KX:()=>o,Od:()=>i,jm:()=>l});var r=n(780),a=n(3490),s=n(8009);class i extends a.XQ{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=(0,s.p1)(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function o(e){return"ai"===e._getType()}function l(e){return"ai"===e._getType()}class c extends a.gj{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const n=[],a=[];for(const t of e.tool_call_chunks){let e={};try{if(e=(0,r.d)(t.args||"{}"),null===e||"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){a.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:a,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:(0,a._I)(this.content,e.content),additional_kwargs:(0,a.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.ns)(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=(0,a.Vt)(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const n={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},r={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},a=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i={input_tokens:a.input_tokens+s.input_tokens,output_tokens:a.output_tokens+s.output_tokens,total_tokens:a.total_tokens+s.total_tokens,...Object.keys(n).length>0&&{input_token_details:n},...Object.keys(r).length>0&&{output_token_details:r}};t.usage_metadata=i}return new c(t)}}},3490:(e,t,n)=>{"use strict";n.d(t,{AJ:()=>p,F7:()=>c,Iv:()=>s,Vt:()=>l,XQ:()=>i,_I:()=>a,dp:()=>d,gj:()=>u,ns:()=>o,ny:()=>h});var r=n(8999);function a(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?l(e,t)??[...e,...t]:[...e,{type:"text",text:t}]}function s(e,t){return"error"===e||"error"===t?"error":"success"}class i extends r.y{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(n=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,n){if("object"!=typeof t||null==t)return t;if(n>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map((t=>e(t,n+1)));const a={};for(const r of Object.keys(t))a[r]=e(t[r],n+1);return a}(n,0),null,2));var n,r;return`${this.constructor.lc_name()} ${t}`}}function o(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e]))if(Array.isArray(n[e]))n[e]=l(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=o(n[e],r)}return n}function l(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=o(n[t],e):n.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function c(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return l(e,t);if("object"==typeof e&&"object"==typeof t)return o(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class u extends i{}function d(e){return"string"==typeof e.role}function h(e){return"function"==typeof e?._getType}function p(e){return h(e)&&"function"==typeof e.concat}},4301:(e,t,n)=>{"use strict";n.d(t,{XU:()=>s,cM:()=>a});var r=n(3490);class a extends r.XQ{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return a}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class s extends r.gj{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new s({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}},8675:(e,t,n)=>{"use strict";n.d(t,{FK:()=>s,mg:()=>a});var r=n(3490);class a extends r.XQ{static lc_name(){return"FunctionMessage"}constructor(e,t){"string"==typeof e&&(e={content:e,name:t}),super(e)}_getType(){return"function"}}class s extends r.gj{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new s({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}},5454:(e,t,n)=>{"use strict";n.d(t,{a7:()=>s,xc:()=>a});var r=n(3490);class a extends r.XQ{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class s extends r.gj{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new s({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},1673:(e,t,n)=>{"use strict";n.d(t,{Od:()=>r.Od,H:()=>r.H,XQ:()=>a.XQ,cM:()=>s.cM,XU:()=>s.XU,FK:()=>i.FK,xc:()=>o.xc,a7:()=>o.a7,tn:()=>l.tn,uU:()=>l.uU,dr:()=>u.dr,K0:()=>c.K0,Sw:()=>c.Sw,KX:()=>r.KX,jm:()=>r.jm,ny:()=>a.ny});var r=n(7765),a=n(3490),s=n(4301),i=n(8675),o=n(5454),l=n(7974),c=n(6362);n(3292);a.XQ;var u=n(8009);o.xc,o.a7,r.Od,r.H,l.tn,l.uU,l.tn,l.uU,u.uf,u.dr,i.mg,i.FK,s.cM,s.XU},7974:(e,t,n)=>{"use strict";n.d(t,{tn:()=>a,uU:()=>s});var r=n(3490);class a extends r.XQ{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class s extends r.gj{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new s({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),id:this.id??e.id})}}},8009:(e,t,n)=>{"use strict";n.d(t,{dr:()=>i,fK:()=>a,p1:()=>o,uf:()=>s});var r=n(3490);function a(e){return null!=e&&"object"==typeof e&&"lc_direct_tool_output"in e&&!0===e.lc_direct_tool_output}class s extends r.XQ{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,n){"string"==typeof e&&(e={content:e,name:n,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class i extends r.gj{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new i({content:(0,r._I)(this.content,e.content),additional_kwargs:(0,r.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,r.ns)(this.response_metadata,e.response_metadata),artifact:(0,r.F7)(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(0,r.Iv)(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function o(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}},6362:(e,t,n)=>{"use strict";n.d(t,{K0:()=>f,Sw:()=>m,ih:()=>g});var r=n(1368),a=n(199),s=n(7765),i=n(3490),o=n(4301),l=n(8675),c=n(5454),u=n(7974),d=n(8009);function h(e){return(0,a.K)(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function p(e){let t,n;if("object"==typeof(a=e)&&null!=a&&1===a.lc&&Array.isArray(a.id)&&null!=a.kwargs&&"object"==typeof a.kwargs){const r=e.id.at(-1);t="HumanMessage"===r||"HumanMessageChunk"===r?"user":"AIMessage"===r||"AIMessageChunk"===r?"assistant":"SystemMessage"===r||"SystemMessageChunk"===r?"system":"unknown",n=e.kwargs}else{const{type:r,...a}=e;t=r,n=a}var a;if("human"===t||"user"===t)return new c.xc(n);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=n;if(!Array.isArray(e))return new s.Od(n);const r=e.map(h);return new s.Od({...t,tool_calls:r})}if("system"===t)return new u.tn(n);if("developer"===t)return new u.tn({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in n)return new d.uf({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});throw(0,r.Y)(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function f(e){if("string"==typeof e)return new c.xc(e);if((0,i.ny)(e))return e;if(Array.isArray(e)){const[t,n]=e;return p({type:t,content:n})}if((0,i.dp)(e)){const{role:t,...n}=e;return p({...n,type:t})}return p(e)}function m(e,t="Human",n="AI"){const r=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=n;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const s=a.name?`${a.name}, `:"",i="string"==typeof a.content?a.content:JSON.stringify(a.content,null,2);r.push(`${e}: ${s}${i}`)}return r.join("\n")}function g(e){const t=e._getType();if("human"===t)return new c.a7({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),new s.H({...t})}if("system"===t)return new u.uU({...e});if("function"===t)return new l.FK({...e});if(o.cM.isInstance(e))return new o.XU({...e});throw new Error("Unknown message type.")}},8028:(e,t,n)=>{"use strict";n.d(t,{Cf:()=>s,SP:()=>r,mu:()=>a});const r="__run";class a{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new a({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class s extends a{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new s({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},5311:(e,t,n)=>{"use strict";n.d(t,{HY:()=>o,aB:()=>l,vX:()=>c});var r=n(8999),a=n(5454),s=n(6362);class i extends r.y{}class o extends i{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new a.xc(this.value)]}}class l extends i{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,s.Sw)(this.messages)}toChatMessages(){return this.messages}}class c extends i{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new a.xc({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}},6993:(e,t,n)=>{"use strict";n.d(t,{m:()=>a});var r=n(3292);class a extends r.YN{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},n={};for(const[e,r]of Object.entries(t))n[e]="string"==typeof r?r:await r();return{...n,...e}}async invoke(e,t){return this._callWithConfig((e=>this.formatPromptValue(e)),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then(n.bind(n,3650));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then(n.bind(n,3650));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then(n.bind(n,2771));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}},3766:(e,t,n)=>{"use strict";n.d(t,{GL:()=>p,RZ:()=>k,qF:()=>m});var r=n(1673),a=n(5311),s=n(3292),i=n(329),o=n(6993),l=n(3650),c=n(6279),u=n(9849),d=n(1368);class h extends s.YN{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig((e=>this.formatMessages(e)),e,{...t,runType:"prompt"})}}class p extends h{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const e=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let n;try{n=Array.isArray(t)?t.map(r.K0):[(0,r.K0)(t)]}catch(e){const n="string"==typeof t?t:JSON.stringify(t,null,2),r=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${n}`,`Additional message: ${e.message}`].join("\n\n"));throw r.name="InputFormatError",r.lc_error_code=e.lc_error_code,r}return n}}class f extends h{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class m extends o.m{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new a.aB(t)}}class g extends f{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new r.cM(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(l.PromptTemplate.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}}class y extends h{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach((t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))})),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass())return new(t._messageClass())({content:e});if(t.chatMessageClass){const n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(l.PromptTemplate.fromTemplate(e,t));const n=[];for(const r of e)if("string"==typeof r||"object"==typeof r&&"text"in r){let e="";"string"==typeof r?e=r:"string"==typeof r.text&&(e=r.text??"");const a={...t,..."string"!=typeof r?{additionalContentFields:r}:{}};n.push(l.PromptTemplate.fromTemplate(e,a))}else if("object"==typeof r&&"image_url"in r){let e,a=r.image_url??"",s=[];if("string"==typeof a){let n;n="mustache"===t?.templateFormat?(0,u.g2)(a):(0,u.D4)(a);const i=n.flatMap((e=>"variable"===e.type?[e.name]:[]));if((i?.length??0)>0){if(i.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${i}\nFrom: ${a}`);s=[i[0]]}else s=[];a={url:a},e=new c.C({template:a,inputVariables:s,templateFormat:t?.templateFormat,additionalContentFields:r})}else{if("object"!=typeof a)throw new Error("Invalid image template");if("url"in a){let e;e="mustache"===t?.templateFormat?(0,u.g2)(a.url):(0,u.D4)(a.url),s=e.flatMap((e=>"variable"===e.type?[e.name]:[]))}else s=[];e=new c.C({template:a,inputVariables:s,templateFormat:t?.templateFormat,additionalContentFields:r})}n.push(e)}return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof i.L){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const n of this.prompt){let r={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const t of n.inputVariables)r||(r={[t]:e[t]}),r={...r,[t]:e[t]};if(n instanceof i.L){const e=await n.format(r);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),t.push({...a,type:"text",text:e})}else if(n instanceof c.C){const e=await n.format(r);let a;"additionalContentFields"in n&&(a=n.additionalContentFields),t.push({...a,type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class b extends y{static _messageClass(){return r.xc}static lc_name(){return"HumanMessagePromptTemplate"}}class _ extends y{static _messageClass(){return r.Od}static lc_name(){return"AIMessagePromptTemplate"}}class w extends y{static _messageClass(){return r.tn}static lc_name(){return"SystemMessagePromptTemplate"}}function v(e,t){if("function"==typeof e.formatMessages||(0,r.ny)(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const t=e[1];if("string"!=typeof t||"{"!==t[0]||"}"!==t[t.length-1])throw new Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);const n=t.slice(1,-1);return new p({variableName:n,optional:!0})}const n=(0,r.K0)(e);let a;if(a="string"==typeof n.content?n.content:n.content.map((e=>"text"in e?{...e,text:e.text}:"image_url"in e?{...e,image_url:e.image_url}:e)),"human"===n._getType())return b.fromTemplate(a,t);if("ai"===n._getType())return _.fromTemplate(a,t);if("system"===n._getType())return w.fromTemplate(a,t);if(r.cM.isInstance(n))return g.fromTemplate(n.content,n.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}class k extends m{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof r.XQ))for(const n of t.inputVariables)e.add(n);const t=this.inputVariables,n=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),a=new Set([...n].filter((t=>!e.has(t))));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const s=new Set([...e].filter((e=>!n.has(e))));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const n=await Promise.all(e.content.map((async e=>{if("image_url"!==e.type)return e;let n="";n="string"==typeof e.image_url?e.image_url:e.image_url.url;const r=l.PromptTemplate.fromTemplate(n,{templateFormat:this.templateFormat}),a=await r.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=a:e.image_url=a,e})));return e.content=n,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let n=[];for(const e of this.promptMessages)if(e instanceof r.XQ)n.push(await this._parseImagePrompts(e,t));else{const r=e.inputVariables.reduce(((n,r)=>{if(!(r in t||"MessagesPlaceholder"===e.constructor.lc_name()&&e.optional))throw(0,d.Y)(new Error(`Missing value for input variable \`${r.toString()}\``),"INVALID_PROMPT_INPUT");return n[r]=t[r],n}),{}),a=await e.formatMessages(r);n=n.concat(a)}return n}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new k(r)}static fromTemplate(e,t){const n=l.PromptTemplate.fromTemplate(e,t),r=new b({prompt:n});return this.fromMessages([r])}static fromMessages(e,t){const n=e.reduce(((e,n)=>e.concat(n instanceof k?n.promptMessages:[v(n,t)])),[]),a=e.reduce(((e,t)=>t instanceof k?Object.assign(e,t.partialVariables):e),Object.create(null)),s=new Set;for(const e of n)if(!(e instanceof r.XQ))for(const t of e.inputVariables)t in a||s.add(t);return new this({...t,inputVariables:[...s],promptMessages:n,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}},2771:(e,t,n)=>{"use strict";n.d(t,{FewShotPromptTemplate:()=>o});var r=n(329),a=n(9849),s=n(3650),i=n(3766);class o extends r.L{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new o(r)}async format(e){const t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),r=await Promise.all(n.map((e=>this.examplePrompt.format(e)))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return(0,a.Xm)(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const n=await s.PromptTemplate.deserialize(t);let r;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return r=e.examples,new o({inputVariables:e.input_variables,examplePrompt:n,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}i.qF},6279:(e,t,n)=>{"use strict";n.d(t,{C:()=>i});var r=n(5311),a=n(6993),s=n(9849);class i extends a.m{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,s.Ns)([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new i(r)}async format(e){const t={};for(const[n,r]of Object.entries(this.template))t[n]="string"==typeof r?(0,s.Xm)(r,this.templateFormat,e):r;const n=e.url||t.url,r=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if("string"!=typeof n)throw new Error("url must be a string.");const a={url:n};return r&&(a.detail=r),a}async formatPromptValue(e){const t=await this.format(e);return new r.vX(t)}}},3650:(e,t,n)=>{"use strict";n.d(t,{PromptTemplate:()=>s});var r=n(329),a=n(9849);class s extends r.L{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return(0,a.Xm)(this.template,this.templateFormat,t)}static fromExamples(e,t,n,r="\n\n",a=""){const i=[a,...e,t].join(r);return new s({inputVariables:n,template:i})}static fromTemplate(e,t){const{templateFormat:n="f-string",...r}=t??{},i=new Set;return(0,a.QC)(e,n).forEach((e=>{"variable"===e.type&&i.add(e.name)})),new s({inputVariables:[...i],templateFormat:n,template:e,...r})}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new s(r)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new s({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}},329:(e,t,n)=>{"use strict";n.d(t,{L:()=>s});var r=n(5311),a=n(6993);class s extends a.m{async formatPromptValue(e){const t=await this.format(e);return new r.HY(t)}}},9849:(e,t,n)=>{"use strict";n.d(t,{Ns:()=>P,D4:()=>E,g2:()=>x,QC:()=>T,Xm:()=>I});var r=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===r.call(e)};function s(e){return"function"==typeof e}function i(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(e,t){return null!=e&&"object"==typeof e&&t in e}var l=RegExp.prototype.test,c=/\S/;var u={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},d=/\s*/,h=/\s+/,p=/\s*=/,f=/\s*\}/,m=/#|\^|\/|>|\{|&|=|!/;function g(e){this.string=e,this.tail=e,this.pos=0}function y(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function b(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}g.prototype.eos=function(){return""===this.tail},g.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},g.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},y.prototype.push=function(e){return new y(e,this)},y.prototype.lookup=function(e){var t,n,r,a=this.cache;if(a.hasOwnProperty(e))t=a[e];else{for(var i,l,c,u=this,d=!1;u;){if(e.indexOf(".")>0)for(i=u.view,l=e.split("."),c=0;null!=i&&c<l.length;)c===l.length-1&&(d=o(i,l[c])||(n=i,r=l[c],null!=n&&"object"!=typeof n&&n.hasOwnProperty&&n.hasOwnProperty(r))),i=i[l[c++]];else i=u.view[e],d=o(u.view,e);if(d){t=i;break}u=u.parent}a[e]=t}return s(t)&&(t=t.call(this.view)),t},b.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},b.prototype.parse=function(e,t){var n=this.templateCache,r=e+":"+(t||_.tags).join(":"),s=void 0!==n,o=s?n.get(r):void 0;return null==o&&(o=function(e,t){if(!e)return[];var n,r,s,o,u=!1,y=[],b=[],w=[],v=!1,k=!1,O="",E=0;function x(){if(v&&!k)for(;w.length;)delete b[w.pop()];else w=[];v=!1,k=!1}function A(e){if("string"==typeof e&&(e=e.split(h,2)),!a(e)||2!==e.length)throw new Error("Invalid tags: "+e);n=new RegExp(i(e[0])+"\\s*"),r=new RegExp("\\s*"+i(e[1])),s=new RegExp("\\s*"+i("}"+e[1]))}A(t||_.tags);for(var S,I,T,P,C,R,N=new g(e);!N.eos();){if(S=N.pos,T=N.scanUntil(n))for(var j=0,$=T.length;j<$;++j)o=P=T.charAt(j),function(e,t){return l.call(e,t)}(c,o)?(k=!0,u=!0,O+=" "):(w.push(b.length),O+=P),b.push(["text",P,S,S+1]),S+=1,"\n"===P&&(x(),O="",E=0,u=!1);if(!N.scan(n))break;if(v=!0,I=N.scan(m)||"name",N.scan(d),"="===I?(T=N.scanUntil(p),N.scan(p),N.scanUntil(r)):"{"===I?(T=N.scanUntil(s),N.scan(f),N.scanUntil(r),I="&"):T=N.scanUntil(r),!N.scan(r))throw new Error("Unclosed tag at "+N.pos);if(C=">"==I?[I,T,S,N.pos,O,E,u]:[I,T,S,N.pos],E++,b.push(C),"#"===I||"^"===I)y.push(C);else if("/"===I){if(!(R=y.pop()))throw new Error('Unopened section "'+T+'" at '+S);if(R[1]!==T)throw new Error('Unclosed section "'+R[1]+'" at '+S)}else"name"===I||"{"===I||"&"===I?k=!0:"="===I&&A(T)}if(x(),R=y.pop())throw new Error('Unclosed section "'+R[1]+'" at '+N.pos);return function(e){for(var t,n=[],r=n,a=[],s=0,i=e.length;s<i;++s)switch((t=e[s])[0]){case"#":case"^":r.push(t),a.push(t),r=t[4]=[];break;case"/":a.pop()[5]=t[2],r=a.length>0?a[a.length-1][4]:n;break;default:r.push(t)}return n}(function(e){for(var t,n,r=[],a=0,s=e.length;a<s;++a)(t=e[a])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}(b))}(e,t),s&&n.set(r,o)),o},b.prototype.render=function(e,t,n,r){var a=this.getConfigTags(r),s=this.parse(e,a),i=t instanceof y?t:new y(t,void 0);return this.renderTokens(s,i,n,e,r)},b.prototype.renderTokens=function(e,t,n,r,a){for(var s,i,o,l="",c=0,u=e.length;c<u;++c)o=void 0,"#"===(i=(s=e[c])[0])?o=this.renderSection(s,t,n,r,a):"^"===i?o=this.renderInverted(s,t,n,r,a):">"===i?o=this.renderPartial(s,t,n,a):"&"===i?o=this.unescapedValue(s,t):"name"===i?o=this.escapedValue(s,t,a):"text"===i&&(o=this.rawValue(s)),void 0!==o&&(l+=o);return l},b.prototype.renderSection=function(e,t,n,r,i){var o=this,l="",c=t.lookup(e[1]);if(c){if(a(c))for(var u=0,d=c.length;u<d;++u)l+=this.renderTokens(e[4],t.push(c[u]),n,r,i);else if("object"==typeof c||"string"==typeof c||"number"==typeof c)l+=this.renderTokens(e[4],t.push(c),n,r,i);else if(s(c)){if("string"!=typeof r)throw new Error("Cannot use higher-order sections without the original template");null!=(c=c.call(t.view,r.slice(e[3],e[5]),(function(e){return o.render(e,t,n,i)})))&&(l+=c)}else l+=this.renderTokens(e[4],t,n,r,i);return l}},b.prototype.renderInverted=function(e,t,n,r,s){var i=t.lookup(e[1]);if(!i||a(i)&&0===i.length)return this.renderTokens(e[4],t,n,r,s)},b.prototype.indentPartial=function(e,t,n){for(var r=t.replace(/[^ \t]/g,""),a=e.split("\n"),s=0;s<a.length;s++)a[s].length&&(s>0||!n)&&(a[s]=r+a[s]);return a.join("\n")},b.prototype.renderPartial=function(e,t,n,r){if(n){var a=this.getConfigTags(r),i=s(n)?n(e[1]):n[e[1]];if(null!=i){var o=e[6],l=e[5],c=e[4],u=i;0==l&&c&&(u=this.indentPartial(i,c,o));var d=this.parse(u,a);return this.renderTokens(d,t,n,u,r)}}},b.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},b.prototype.escapedValue=function(e,t,n){var r=this.getConfigEscape(n)||_.escape,a=t.lookup(e[1]);if(null!=a)return"number"==typeof a&&r===_.escape?String(a):r(a)},b.prototype.rawValue=function(e){return e[1]},b.prototype.getConfigTags=function(e){return a(e)?e:e&&"object"==typeof e?e.tags:void 0},b.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!a(e)?e.escape:void 0};var _={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){w.templateCache=e},get templateCache(){return w.templateCache}},w=new b;_.clearCache=function(){return w.clearCache()},_.parse=function(e,t){return w.parse(e,t)},_.render=function(e,t,n,r){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+(a(s=e)?"array":typeof s)+'" was given as the first argument for mustache#render(template, view, partials)');var s;return w.render(e,t,n,r)},_.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return u[e]}))},_.Scanner=g,_.Context=y,_.Writer=b;const v=_;var k=n(1368);function O(){v.escape=e=>e}const E=e=>{const t=e.split(""),n=[],r=(e,n)=>{for(let r=n;r<t.length;r+=1)if(e.includes(t[r]))return r;return-1};let a=0;for(;a<t.length;)if("{"===t[a]&&a+1<t.length&&"{"===t[a+1])n.push({type:"literal",text:"{"}),a+=2;else if("}"===t[a]&&a+1<t.length&&"}"===t[a+1])n.push({type:"literal",text:"}"}),a+=2;else if("{"===t[a]){const e=r("}",a);if(e<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:t.slice(a+1,e).join("")}),a=e+1}else{if("}"===t[a])throw new Error("Single '}' in template.");{const e=r("{}",a),s=(e<0?t.slice(a):t.slice(a,e)).join("");n.push({type:"literal",text:s}),a=e<0?t.length:e}}return n},x=e=>(O(),(e=>e.map((e=>"name"===e[0]?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]})))(v.parse(e))),A={"f-string":(e,t)=>E(e).reduce(((e,n)=>{if("variable"===n.type){if(n.name in t)return e+("string"==typeof t[n.name]?t[n.name]:JSON.stringify(t[n.name]));throw new Error(`(f-string) Missing value for input ${n.name}`)}return e+n.text}),""),mustache:(e,t)=>(O(),v.render(e,t))},S={"f-string":E,mustache:x},I=(e,t,n)=>{try{return A[t](e,n)}catch(e){throw(0,k.Y)(e,"INVALID_PROMPT_INPUT")}},T=(e,t)=>S[t](e),P=(e,t,n)=>{if(!(t in A)){const e=Object.keys(A);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const r=n.reduce(((e,t)=>(e[t]="foo",e)),{});Array.isArray(e)?e.forEach((e=>{if("text"===e.type)I(e.text,t,r);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)I(e.image_url,t,r);else{const n=e.image_url.url;I(n,t,r)}}})):I(e,t,r)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}}},3292:(e,t,n)=>{"use strict";n.d(t,{YN:()=>q,B2:()=>te,fJ:()=>G,jY:()=>X,ck:()=>J,zZ:()=>V,GH:()=>H,Bp:()=>ee});var r=n(4476),a=n(4116),s=n(9120),i=n(3389),o=n(6150),l=n(1590),c=n(58),u=n(7765);class d{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=(0,o.X6)({},t);return new h({ops:t,state:n[n.length-1].newDocument})}}class h extends d{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=(0,o.X6)(this.state,e.ops);return new h({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=(0,o.X6)({},e.ops);return new h({ops:e.ops,state:t[t.length-1].newDocument})}}const p=e=>"log_stream_tracer"===e.name;async function f(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function m(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class g extends l.J{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=c.bO.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new d({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new d({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await f(e,this._schemaFormat)),await this.writer.write(new d({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await f(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await m(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new d({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new d({ops:[{op:"replace",path:"/final_output",value:await m(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let a;var s;void 0!==e.inputs.messages?(s=n?.chunk,a=void 0!==s&&void 0!==s.message?n?.chunk:new u.H({id:`run-${e.id}`,content:t})):a=t;const i=new d({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:a}]});await this.writer.write(i)}}var y=n(8028);function b({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const _=e=>"event_stream_tracer"===e.name;class w extends l.J{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=c.bO.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);function a(e,t){return"llm"===e&&"string"==typeof t?new y.mu({text:t}):t}let s=this.tappedPromises.get(e);if(void 0===s){let i;s=new Promise((e=>{i=e})),this.tappedPromises.set(e,s);try{const s={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...s,data:{chunk:a(r.runType,n.value)}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...s,data:{chunk:a(r.runType,e)}},r),yield e}finally{i()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=b(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const a=`on_${n}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let a,s;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===r.runType)s="on_chat_model_stream",a=void 0===n?.chunk?new u.H({content:t,id:`run-${e.id}`}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);s="on_llm_stream",a=void 0===n?.chunk?new y.mu({text:t}):n.chunk}await this.send({event:s,data:{chunk:a},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let a;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==a)break;a=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);a={generations:r?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=b(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let a={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(a={},r.inputs={}):void 0!==e.inputs.input?(a.input=e.inputs.input,r.inputs=e.inputs.input):(a.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(a.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=b(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=b(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}var v=n(8999),k=n(9830),O=n(765),E=n(9624);class x extends l.J{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function A(e){return!!e&&e.lc_runnable}class S{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}var I=n(4350),T=n(2522);const P=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,C=function(e){return"string"==typeof e&&P.test(e)};function R(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const N=["*","_","`"];function j(e,t){if(void 0!==e&&!C(e))return e;if(!A(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function $(e){return A(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...(0,T.Ik)(e.data.schema),title:e.data.name}}}class M{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,n)=>{e[t.id]=C(t.id)?n:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...$(t)}))),edges:this.edges.map((t=>{const n={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(n.data=t.data),void 0!==t.conditional&&(n.conditional=t.conditional),n}))}}addNode(e,t,n){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t??(0,s.A)(),a={id:r,data:e,name:j(t,e),metadata:n};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(a),a}firstNode(){return L(this)}lastNode(){return D(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map((e=>e.id)).every(C)&&(n="");const r=e=>n?`${n}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[r(e)]={...t,id:r(e)}}));const a=e.edges.map((e=>({...e,source:r(e.source),target:r(e.target)})));this.edges=[...this.edges,...a];const s=e.firstNode(),i=e.lastNode();return[s?{id:r(s.id),data:s.data}:void 0,i?{id:r(i.id),data:i.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&L(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&D(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map((e=>[e.id,e.name]))),t=new Map;Object.values(e).forEach((e=>{t.set(e,(t.get(e)||0)+1)}));const n=n=>{const r=e[n];return C(n)&&1===t.get(r)?r:n};return new M({nodes:Object.fromEntries(Object.entries(this.nodes).map((([e,t])=>[n(e),{...t,id:n(e)}]))),edges:this.edges.map((e=>({...e,source:n(e.source),target:n(e.target)})))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},s=this.reid(),i=s.firstNode(),o=s.lastNode();return function(e,t,n){const{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=n??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",n={[t]:"{0}({1})"};void 0!==r&&(n[r]="{0}([{1}]):::first"),void 0!==a&&(n[a]="{0}([{1}]):::last");for(const[r,a]of Object.entries(e)){const e=a.name.split(":").pop()??"";let s=N.some((t=>e.startsWith(t)&&e.endsWith(t)))?`<p>${e}</p>`:e;Object.keys(a.metadata??{}).length&&(s+=`<hr/><small><em>${Object.entries(a.metadata??{}).map((([e,t])=>`${e} = ${t}`)).join("\n")}</em></small>`);const i=(n[r]??n[t]).replace("{0}",R(r)).replace("{1}",s);c+=`\t${i}\n`}}const u={};for(const e of t){const t=e.source.split(":"),n=e.target.split(":"),r=t.filter(((e,t)=>e===n[t])).join(":");u[r]||(u[r]=[]),u[r].push(e)}const d=new Set;function h(e,t){const n=1===e.length&&e[0].source===e[0].target;if(t&&!n){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),c+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:n,data:r,conditional:a}=t;let s="";if(void 0!==r){let e=r;const t=e.split(" ");t.length>l&&(e=Array.from({length:Math.ceil(t.length/l)},((e,n)=>t.slice(n*l,(n+1)*l).join(" "))).join("&nbsp;<br>&nbsp;")),s=a?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else s=a?" -.-> ":" --\x3e ";c+=`\t${R(e)}${s}${R(n)};\n`}for(const e in u)e.startsWith(`${t}:`)&&e!==t&&h(u[e],e);t&&!n&&(c+="\tend\n")}h(u[""]??[],"");for(const e in u)e.includes(":")||""===e||h(u[e],e);return i&&(c+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n} ${r};\n`;return t}(s??{})),c}(s.nodes,s.edges,{firstNode:i?.id,lastNode:o?.id,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:a})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:n="white"}=t??{};const r=btoa(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const a=`https://mermaid.ink/img/${r}?bgColor=${n}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join("\n"));return await s.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function L(e,t=[]){const n=new Set(e.edges.filter((e=>!t.includes(e.source))).map((e=>e.target))),r=[];for(const a of Object.values(e.nodes))t.includes(a.id)||n.has(a.id)||r.push(a);return 1===r.length?r[0]:void 0}function D(e,t=[]){const n=new Set(e.edges.filter((e=>!t.includes(e.target))).map((e=>e.source))),r=[];for(const a of Object.values(e.nodes))t.includes(a.id)||n.has(a.id)||r.push(a);return 1===r.length?r[0]:void 0}function U(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function F(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*z(e,t){for(;;){const{value:n,done:r}=I.Nx.runWithConfig((0,O.DY)(e),t.next.bind(t),!0);if(r)break;yield n}}async function*B(e,t){const n=t[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await I.Nx.runWithConfig((0,O.DY)(e),n.next.bind(t),!0);if(a)break;yield r}}var Z=n(199);function H(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class q extends v.y{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new G({bound:this,kwargs:e,config:{}})}map(){return new Y({bound:this})}withRetry(e){return new K({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new G({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Q({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(O.ZI);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>(0,O.ZI)(0===r?e:n)))}return Array.from({length:t},(()=>(0,O.ZI)(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=r[0]?.maxConcurrency??n?.maxConcurrency,s=new E.g({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),i=e.map(((e,t)=>s.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=(0,O.ZI)(t),r=new c.Tr({generator:this._streamIterator(e,n),config:n});return await r.setup,c.bO.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?(0,O.ZI)(e):(0,O.ZI)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const r=(0,O.ZI)(n),a=await(0,O.kJ)(r),s=await(a?.handleChainStart(this.toJSON(),H(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let i;delete r.runId;try{const a=e.call(this,t,r,s);i=await(0,k.o)(a,n?.signal)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(H(i,"output"))),i}async _batchWithConfig(e,t,n,r){const a=this._getOptionsList(n??{},t.length),s=await Promise.all(a.map(O.kJ)),i=await Promise.all(s.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),H(t[n],"input"),a[n].runId,a[n].runType,void 0,void 0,a[n].runName??this.getName()));return delete a[n].runId,r})));let o;try{const n=e.call(this,t,a,i,r);o=await(0,k.o)(n,a?.[0]?.signal)}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(H(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,a,s=!0,i=!0;const o=(0,O.ZI)(n),l=await(0,O.kJ)(o);let u;try{const d=await(0,c.DS)(t.bind(this),async function*(){for await(const t of e){if(s)if(void 0===r)r=t;else try{r=(0,c.xW)(r,t)}catch{r=void 0,s=!1}yield t}}(),(async()=>l?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),n?.signal,o);delete o.runId,u=d.setup;const h=u?.handlers.find(_);let f=d.output;void 0!==h&&void 0!==u&&(f=h.tapOutputIterable(u.runId,f));const m=u?.handlers.find(p);void 0!==m&&void 0!==u&&(f=m.tapOutputIterable(u.runId,f));for await(const e of f)if(yield e,i)if(void 0===a)a=e;else try{a=(0,c.xW)(a,e)}catch{a=void 0,i=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:H(r,"input")})),e}await(u?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:H(r,"input")}))}getGraph(e){const t=new M,n=t.addNode({name:`${this.getName()}Input`,schema:r.z.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:r.z.any()});return t.addEdge(n,a),t.addEdge(a,s),t}pipe(e){return new V({first:this,last:ee(e)})}pick(e){return this.pipe(new ne(e))}assign(e){return this.pipe(new te(new J({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:(0,c.xW)(n,t);yield*this._streamIterator(n,(0,O.ZI)(t))}async*streamLog(e,t,n){const r=new g({...n,autoClose:!1,_schemaFormat:"original"}),a=(0,O.ZI)(t);yield*this._streamLog(e,r,a)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.addHandler(t,!0),n.callbacks=e}const a=this.stream(e,n),s=async function(){try{const e=await a;for await(const n of e){const e=new d({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await s}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return c.bO.fromReadableStream(n)}(r):c.bO.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,n){const r=new w({...n,autoClose:!1}),a=(0,O.ZI)(t),i=a.runId??(0,s.A)();a.runId=i;const o=a.callbacks;if(void 0===o)a.callbacks=[r];else if(Array.isArray(o))a.callbacks=o.concat(r);else{const e=o.copy();e.addHandler(r,!0),a.callbacks=e}const l=this,c=async function(){try{const t=await l.stream(e,a),n=r.tapOutputIterable(i,t);for await(const e of n);}finally{await r.finish()}}();let u,d=!1;try{for await(const t of r)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{await c}}async*_streamEventsV1(e,t,n){let r,a=!1;const s=(0,O.ZI)(t),i=s.tags??[],o=s.metadata??{},l=s.runName??this.getName(),c=new g({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new S({...n}),d=this._streamLog(e,c,s);for await(const t of d){if(r=r?r.concat(t):h.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:i,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),s=[...new Set(n)];for(const e of s){let t,n={};const a=r.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(n.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(n.input=a.inputs),n.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);n={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:n}}const{state:c}=r;if(c.streamed_output.length>0){const e=c.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${c.name}"`);const t={chunk:c.streamed_output[0]};c.streamed_output=[];const n={event:`on_${c.type}_stream`,run_id:c.id,tags:i,metadata:o,name:l,data:t};u.includeEvent(n,c.type)&&(yield n)}}const p=r?.state;if(void 0!==p){const e={event:`on_${p.type}_end`,name:l,run_id:p.id,tags:i,metadata:o,data:{output:p.final_output}};u.includeEvent(e,p.type)&&(yield e)}}static isRunnable(e){return A(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new G({bound:this,config:{},configFactories:[r=>({callbacks:[new x({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),a=t.description??t.schema?.description;return t.schema.constructor===r.z.ZodString?new re({name:n,description:a,schema:r.z.object({input:r.z.string()}).transform((e=>e.input)),bound:e}):new re({name:n,description:a,schema:t.schema,bound:e})}(this,e)}}class G extends q{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=(0,O.SV)(this.config,...e);return(0,O.SV)(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig((0,O.ZI)(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig((0,O.ZI)(e),this.kwargs)))):await this._mergeConfig((0,O.ZI)(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig((0,O.ZI)(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig((0,O.ZI)(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig((0,O.ZI)(t),this.kwargs))}streamEvents(e,t,n){const r=this;return c.bO.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig((0,O.ZI)(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&q.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new G({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new x({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class Y extends q{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Y({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,(0,O.tn)(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new Y({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class K extends G{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return(0,O.tn)(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return a((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,r){const s={};try{await a((async a=>{const i=e.map(((e,t)=>t)).filter((e=>void 0===s[e.toString()]||s[e.toString()]instanceof Error)),o=i.map((t=>e[t])),l=i.map((e=>this._patchConfigForRetry(a,t?.[e],n?.[e]))),c=await super.batch(o,l,{...r,returnExceptions:!0});let u;for(let e=0;e<c.length;e+=1){const t=c[e],n=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),s[n.toString()]=t}if(u)throw u;return c}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(s).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>s[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class V extends q{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=(0,O.ZI)(t),r=await(0,O.kJ)(n),a=await(r?.handleChainStart(this.toJSON(),H(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let s,i=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const s=e[r].invoke(i,(0,O.tn)(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));i=await(0,k.o)(s,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");s=await this.last.invoke(i,(0,O.tn)(n,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(H(s,"output"))),s}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map(O.kJ)),s=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),H(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(i,s.map(((t,n)=>{const a=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return(0,O.tn)(r[n],{callbacks:a})})),n);i=await(0,k.o)(t,r[0]?.signal)}}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(H(i,"output"))))),i}async*_streamIterator(e,t){const n=await(0,O.kJ)(t),{runId:r,...a}=t??{},s=await(n?.handleChainStart(this.toJSON(),H(e,"input"),r,void 0,void 0,void 0,a?.runName)),i=[this.first,...this.middle,this.last];let o,l=!0;try{let n=i[0].transform(async function*(){yield e}(),(0,O.tn)(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<i.length;e+=1){const t=i[e];n=await t.transform(n,(0,O.tn)(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of n)if(t?.signal?.throwIfAborted(),yield e,l)if(void 0===o)o=e;else try{o=(0,c.xW)(o,e)}catch(e){o=void 0,l=!1}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(H(o,"output")))}getGraph(e){const t=new M;let n=null;return this.steps.forEach(((r,a)=>{const s=r.getGraph(e);0!==a&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const i=s.firstNode();if(!i)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,i),n=s.lastNode()})),t}pipe(e){return V.isRunnableSequence(e)?new V({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new V({first:this.first,middle:[...this.middle,this.last],last:ee(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&q.isRunnable(e)}static from([e,...t],n){let r={};return"string"==typeof n?r.name=n:void 0!==n&&(r=n),new V({...r,first:ee(e),middle:t.slice(0,-1).map(ee),last:ee(t[t.length-1])})}}class J extends q{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=ee(n)}static from(e){return new J({steps:e})}async invoke(e,t){const n=(0,O.ZI)(t),r=await(0,O.kJ)(n),a=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const s={};try{const r=Object.entries(this.steps).map((async([t,r])=>{s[t]=await r.invoke(e,(0,O.tn)(n,{callbacks:a?.getChild(`map:key:${t}`)}))}));await(0,k.o)(Promise.all(r),t?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(s)),s}async*_transform(e,t,n){const r={...this.steps},a=(0,c.gI)(e,Object.keys(r).length),s=new Map(Object.entries(r).map((([e,r],s)=>{const i=r.transform(a[s],(0,O.tn)(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then((t=>({key:e,gen:i,result:t})))]})));for(;s.size;){const e=Promise.race(s.values()),{key:t,result:r,gen:a}=await(0,k.o)(e,n?.signal);s.delete(t),r.done||(yield{[t]:r.value},s.set(t,a.next().then((e=>({key:t,gen:a,result:e})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,O.ZI)(t),r=new c.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,c.bO.fromAsyncGenerator(r)}}class W extends q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!(0,i.GZ)(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await(0,O.kJ)(n),a=this.func((0,O.tn)(n,{callbacks:r}),e);return(0,k.o)(a,n?.signal)}async*_streamIterator(e,t){const[n]=this._getOptionsList(t??{},1),r=await this.invoke(e,t);var a;if(F(r))for await(const e of r)n?.signal?.throwIfAborted(),yield e;else if(null!=(a=r)&&"object"==typeof a&&"next"in a&&"function"==typeof a.next)for(;;){n?.signal?.throwIfAborted();const e=r.next();if(e.done)break;yield e.value}else yield r}static from(e){return new W({func:e})}}class X extends q{static lc_name(){return"RunnableLambda"}constructor(e){if((0,i.GZ)(e.func))return W.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if((0,i.GZ)(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new X({func:e})}async _invoke(e,t,n){return new Promise(((r,a)=>{const s=(0,O.tn)(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??O.p_)-1});I.Nx.runWithConfig((0,O.DY)(s),(async()=>{try{let n=await this.func(e,{...s});if(n&&q.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...s,recursionLimit:(s.recursionLimit??O.p_)-1})}else if(F(n)){let e;for await(const r of B(s,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=(0,c.xW)(e,r)}catch(t){e=r}n=e}else if(U(n)){let e;for(const r of z(s,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=(0,c.xW)(e,r)}catch(t){e=r}n=e}r(n)}catch(e){a(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=(0,c.xW)(r,t)}catch(e){r=t}const a=(0,O.tn)(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??O.p_)-1}),s=await new Promise(((e,t)=>{I.Nx.runWithConfig((0,O.DY)(a),(async()=>{try{const t=await this.func(r,{...a,config:a});e(t)}catch(e){t(e)}}))}));if(s&&q.isRunnable(s)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await s.stream(r,a);for await(const t of e)yield t}else if(F(s))for await(const e of B(a,s))n?.signal?.throwIfAborted(),yield e;else if(U(s))for(const e of z(a,s))n?.signal?.throwIfAborted(),yield e;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,O.ZI)(t),r=new c.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,c.bO.fromAsyncGenerator(r)}}class Q extends q{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=(0,O.ZI)(t),r=await(0,O.kJ)(n),{runId:a,...s}=n,i=await(r?.handleChainStart(this.toJSON(),H(e,"input"),a,void 0,void 0,void 0,s?.runName)),o=(0,O.tn)(s,{callbacks:i?.getChild()});return await I.Nx.runWithConfig(o,(async()=>{let t;for(const r of this.runnables()){n?.signal?.throwIfAborted();try{const t=await r.invoke(e,o);return await(i?.handleChainEnd(H(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(t)),t}))}async*_streamIterator(e,t){const n=(0,O.ZI)(t),r=await(0,O.kJ)(n),{runId:a,...s}=n,i=await(r?.handleChainStart(this.toJSON(),H(e,"input"),a,void 0,void 0,void 0,s?.runName));let o,l,u;for(const t of this.runnables()){n?.signal?.throwIfAborted();const r=(0,O.tn)(s,{callbacks:i?.getChild()});try{l=B(r,await t.stream(e,r));break}catch(e){void 0===o&&(o=e)}}if(void 0===l){const e=o??new Error("No error stored at end of fallback.");throw await(i?.handleChainError(e)),e}try{for await(const e of l){yield e;try{u=void 0===u?u:(0,c.xW)(u,e)}catch(e){u=void 0}}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(H(u,"output")))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),a=await Promise.all(r.map((e=>(0,O.kJ)(e)))),s=await Promise.all(a.map((async(t,n)=>{const a=await(t?.handleChainStart(this.toJSON(),H(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,a})));let i;for(const t of this.runnables()){r[0].signal?.throwIfAborted();try{const a=await t.batch(e,s.map(((e,t)=>(0,O.tn)(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(s.map(((e,t)=>e?.handleChainEnd(H(a[t],"output"))))),a}catch(e){void 0===i&&(i=e)}}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map((e=>e?.handleChainError(i)))),i}}function ee(e){if("function"==typeof e)return new X({func:e});if(q.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=ee(r);return new J({steps:t})}}class te extends q{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof J&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[a,s]=(0,c.gI)(e),i=this.mapper.transform(s,(0,O.tn)(n,{callbacks:t?.getChild()})),o=i.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,O.ZI)(t),r=new c.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,c.bO.fromAsyncGenerator(r)}}class ne extends q{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=(0,O.ZI)(t),r=new c.Tr({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,c.bO.fromAsyncGenerator(r)}}class re extends G{constructor(e){super({bound:V.from([X.from((async e=>{let t;if((0,Z.K)(e))try{t=await this.schema.parseAsync(e.args)}catch(t){throw new Z.q("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t})).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}},765:(e,t,n)=>{"use strict";n.d(t,{DY:()=>d,SV:()=>o,ZI:()=>c,kJ:()=>i,p_:()=>s,tn:()=>u});var r=n(5780),a=n(4350);const s=25;async function i(e){return r.Td._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function o(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=n.timeout:void 0!==n.timeout&&(t.timeout=Math.min(t.timeout,n.timeout));else if("signal"===e)void 0===t.signal?t.signal=n.signal:void 0!==n.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,n.signal]):t.signal=n.signal);else if("callbacks"===e){const e=t.callbacks,a=n.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{const n=e.copy();for(const e of a)n.addHandler((0,r.tW)(e),!0);t.callbacks=n}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){const n=a.copy();for(const t of e)n.addHandler((0,r.tW)(t),!0);t.callbacks=n}else t.callbacks=new r.Td(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else{const r=e;t[r]=n[r]??t[r]}return t}const l=new Set(["string","number","boolean"]);function c(e){const t=a.Nx.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:r,...a}=t;n=Object.entries(a).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)}if(e&&(n=Object.entries(e).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)),n?.configurable)for(const e of Object.keys(n.configurable))l.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);if(void 0!==n.timeout){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(n.timeout);void 0!==n.signal?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,e])):n.signal=e,delete n.timeout}return n}function u(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:a,configurable:s,runId:i}={}){const o=c(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==a&&(o.runName=a),void 0!==s&&(o.configurable={...o.configurable,...s}),void 0!==i&&delete o.runId,o}function d(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}},6968:(e,t,n)=>{"use strict";n.d(t,{X0:()=>i,hr:()=>a,pH:()=>s});const r=Symbol.for("ls:tracing_async_local_storage"),a=Symbol.for("lc:context_variables"),s=e=>{globalThis[r]=e},i=()=>globalThis[r]},4350:(e,t,n)=>{"use strict";n.d(t,{Nx:()=>l});var r=n(1259),a=n(6968),s=n(5780);const i=new class{getStore(){}run(e,t){return t()}enterWith(e){}},o=Symbol.for("lc:child_config"),l=new class{getInstance(){return(0,a.X0)()??i}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[o]}runWithConfig(e,t,n){const i=s.Td._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),l=this.getInstance(),c=l.getStore(),u=i?.getParentRunId(),d=i?.handlers?.find((e=>"langchain_tracer"===e?.name));let h;return d&&u?h=d.convertToRunTree(u):n||(h=new r.gk({name:"<runnable_lambda>",tracingEnabled:!1})),h&&(h.extra={...h.extra,[o]:e}),void 0!==c&&void 0!==c[a.hr]&&(h[a.hr]=c[a.hr]),l.run(h,t)}initializeGlobalInstance(e){void 0===(0,a.X0)()&&(0,a.pH)(e)}}},199:(e,t,n)=>{"use strict";function r(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}n.d(t,{K:()=>r,q:()=>a});class a extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}},1590:(e,t,n)=>{"use strict";n.d(t,{J:()=>i,j:()=>s});var r=n(5960);function a(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function s(e){return"function"==typeof e._addRunToRunMap}class i extends r.NK{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;return this.runMap.set(n.id,n),n}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,r,a,s,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...a,metadata:i}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,n,r,a,s,i,o){const l=this.runMap.get(n)??this._createRunForLLMStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(l)),await(this.onLLMStart?.(l)),l}_createRunForChatModelStart(e,t,n,r,a,s,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...a,metadata:i}:a,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,n,r,a,s,i,o){const l=this.runMap.get(n)??this._createRunForChatModelStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(l)),await(this.onLLMStart?.(l)),l}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}_createRunForChainStart(e,t,n,r,a,s,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:i??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,n,r,a,s,i,o){const l=this.runMap.get(n)??this._createRunForChainStart(e,t,n,r,a,s,i,o);return await(this.onRunCreate?.(l)),await(this.onChainStart?.(l)),l}async handleChainEnd(e,t,n,r,s){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=a(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==s?.inputs&&(i.inputs=a(s.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,n,r,s){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==s?.inputs&&(i.inputs=a(s.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}_createRunForToolStart(e,t,n,r,a,s,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleToolStart(e,t,n,r,a,s,i){const o=this.runMap.get(n)??this._createRunForToolStart(e,t,n,r,a,s,i);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}_createRunForRetrieverStart(e,t,n,r,a,s,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleRetrieverStart(e,t,n,r,a,s,i){const o=this.runMap.get(n)??this._createRunForRetrieverStart(e,t,n,r,a,s,i);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,a,s){const i=this.runMap.get(n);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:s?.chunk})),i}}},9624:(e,t,n)=>{"use strict";n.d(t,{g:()=>o});var r=n(4116),a=n(3290);const s=[400,401,402,403,404,405,406,407,409],i=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&s.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??i;const t=a.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>r((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}},9583:(e,t,n)=>{"use strict";n.d(t,{Az:()=>o,Ec:()=>i});const r=()=>"undefined"!=typeof Deno,a=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||r()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":r()?"deno":"other":"node",e};let s;async function i(){if(void 0===s){const e=a();s={library:"langchain-js",runtime:e}}return s}function o(e){try{return"undefined"!=typeof process?process.env?.[e]:r()?Deno?.env.get(e):void 0}catch(e){return}}},6150:(e,t,n)=>{"use strict";n.d(t,{X6:()=>_,UD:()=>x});var r={};n.r(r),n.d(r,{JsonPatchError:()=>p,_areEquals:()=>O,applyOperation:()=>b,applyPatch:()=>_,applyReducer:()=>w,deepClone:()=>f,getValueByPointer:()=>y,validate:()=>k,validator:()=>v});const a=Object.prototype.hasOwnProperty;function s(e,t){return a.call(e,t)}function i(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)s(e,n)&&t.push(n);return t}function o(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function l(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function c(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function u(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(u(e[t]))return!0}else if("object"==typeof e){const n=i(e),r=n.length;for(var t=0;t<r;t++)if(u(e[n[t]]))return!0}return!1}function d(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class h extends Error{constructor(e,t,n,r,a){super(d(e,{name:t,index:n,operation:r,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=d(e,{name:t,index:n,operation:r,tree:a})}}const p=h,f=o,m={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=y(n,this.path);r&&(r=o(r));const a=b(n,{op:"remove",path:this.from}).removed;return b(n,{op:"add",path:this.path,value:a}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=y(n,this.from);return b(n,{op:"add",path:this.path,value:o(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:O(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var g={add:function(e,t,n){return l(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:m.move,copy:m.copy,test:m.test,_get:m._get};function y(e,t){if(""==t)return e;var n={op:"_get",path:t};return b(e,n),n.value}function b(e,t,n=!1,r=!0,a=!0,s=0){if(n&&("function"==typeof n?n(t,0,e,t.path):v(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=y(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=O(e,t.value),!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,t,e);return r}{r||(e=o(e));const i=(t.path||"").split("/");let c,u,d,h=e,f=1,y=i.length;for(d="function"==typeof n?n:v;;){if(u=i[f],u&&-1!=u.indexOf("~")&&(u=u.replace(/~1/g,"/").replace(/~0/g,"~")),a&&("__proto__"==u||"prototype"==u&&f>0&&"constructor"==i[f-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===c&&(void 0===h[u]?c=i.slice(0,f).join("/"):f==y-1&&(c=t.path),void 0!==c&&d(t,0,e,c)),f++,Array.isArray(h)){if("-"===u)u=h.length;else{if(n&&!l(u))throw new p("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,t,e);l(u)&&(u=~~u)}if(f>=y){if(n&&"add"===t.op&&u>h.length)throw new p("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,t,e);const r=g[t.op].call(t,h,u,e);if(!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r}}else if(f>=y){const n=m[t.op].call(t,h,u,e);if(!1===n.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n}if(h=h[u],n&&f<y&&(!h||"object"!=typeof h))throw new p("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,t,e)}}}function _(e,t,n,r=!0,a=!0){if(n&&!Array.isArray(t))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=o(e));const s=new Array(t.length);for(let r=0,i=t.length;r<i;r++)s[r]=b(e,t[r],n,!0,a,r),e=s[r].newDocument;return s.newDocument=e,s}function w(e,t,n){const r=b(e,t);if(!1===r.test)throw new p("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function v(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new p("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!m[e.op])throw new p("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new p("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new p('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new p("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&u(e.value))throw new p("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var a=e.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new p("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new p("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var i=k([{op:"_get",path:e.from,value:void 0}],n);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new p("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function k(e,t,n){try{if(!Array.isArray(e))throw new p("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)_(o(t),o(e),n||!0);else{n=n||v;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof p)return e;throw e}}function O(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,a,s=Array.isArray(e),i=Array.isArray(t);if(s&&i){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!O(e[n],t[n]))return!1;return!0}if(s!=i)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!O(e[a=o[n]],t[a]))return!1;return!0}return e!=e&&t!=t}function E(e,t,n,r,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var l=i(t),u=i(e),d=!1,h=u.length-1;h>=0;h--){var p=e[m=u[h]];if(!s(t,m)||void 0===t[m]&&void 0!==p&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&n.push({op:"test",path:r+"/"+c(m),value:o(p)}),n.push({op:"remove",path:r+"/"+c(m)}),d=!0):(a&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var f=t[m];"object"==typeof p&&null!=p&&"object"==typeof f&&null!=f&&Array.isArray(p)===Array.isArray(f)?E(p,f,n,r+"/"+c(m),a):p!==f&&(a&&n.push({op:"test",path:r+"/"+c(m),value:o(p)}),n.push({op:"replace",path:r+"/"+c(m),value:o(f)}))}}if(d||l.length!=u.length)for(h=0;h<l.length;h++){var m;s(e,m=l[h])||void 0===t[m]||n.push({op:"add",path:r+"/"+c(m),value:o(t[m])})}}}function x(e,t,n=!1){var r=[];return E(e,t,r,"",n),r}new WeakMap},780:(e,t,n)=>{"use strict";function r(e,t=a){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function a(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,a=!1;for(let s of e){if(r)'"'!==s||a?"\n"!==s||a?a="\\"===s&&!a:s="\\n":r=!1;else if('"'===s)r=!0,a=!1;else if("{"===s)n.push("}");else if("["===s)n.push("]");else if("}"===s||"]"===s){if(!n||n[n.length-1]!==s)return null;n.pop()}t+=s}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}n.d(t,{D:()=>r,d:()=>a})},9830:(e,t,n)=>{"use strict";async function r(e,t){if(void 0===t)return e;let n;return Promise.race([e.catch((e=>{if(!t?.aborted)throw e})),new Promise(((e,r)=>{n=()=>{r(new Error("Aborted"))},t.addEventListener("abort",n),t.aborted&&r(new Error("Aborted"))}))]).finally((()=>t.removeEventListener("abort",n)))}n.d(t,{o:()=>r})},58:(e,t,n)=>{"use strict";n.d(t,{DS:()=>u,Tr:()=>c,bO:()=>i,gI:()=>o,xW:()=>l});var r=n(765),a=n(4350),s=n(9830);class i extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new i({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new i({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function o(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function l(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=l(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class c{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise(((t,n)=>{a.Nx.runWithConfig((0,r.DY)(e.config),(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then((e=>t(void 0)),n)}),!0)}))}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?a.Nx.runWithConfig((0,r.DY)(this.config),this.signal?async()=>(0,s.o)(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function u(e,t,n,r,...a){const s=new c({generator:t,startSetup:n,signal:r}),i=await s.setup;return{output:e(s,i,...a),setup:i}}},9056:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>C});var r=n(5230),a=n(4116),s=n(3290),i=n(747);const o=[400,401,403,404,405,406,407,408],l=[409];class c{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new s.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>a((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(o.includes(+r))throw e;if(l.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>(0,i.Y)()(...e).then((e=>e.ok?e:Promise.reject(e)))))}}function u(e){return"function"==typeof e?._getType}function d(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var h=n(4785),p=n(6928);const f=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function m(e,t){if("string"!=typeof(n=e)||!f.test(n))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);var n;return e}var g=n(6232);function y(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,a]=t.split("/",2);if(!n||!a)throw new Error(`Invalid identifier format: ${e}`);return[n,a,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}n(9589);class b extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function _(e,t,n){let r;if(e.ok)return void(n&&(r=await e.text()));r=await e.text();const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${r}`;if(409===e.status)throw new b(a);throw new Error(a)}var w="[...]",v={result:"[Circular]"},k=[],O=[];function E(e,t,n,r){try{return JSON.stringify(e,t,n)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";var a;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===r&&(r={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),A(e,"",0,[],void 0,0,r);try{a=0===O.length?JSON.stringify(e,t,n):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if(O.length>0)for(var r=0;r<O.length;r++){var a=O[r];if(a[1]===t&&a[0]===n){n=a[2],O.splice(r,1);break}}return e.call(this,t,n)}}(t),n)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==k.length;){var s=k.pop();4===s.length?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return a}}function x(e,t,n,r){var a=Object.getOwnPropertyDescriptor(r,n);void 0!==a.get?a.configurable?(Object.defineProperty(r,n,{value:e}),k.push([r,n,t,a])):O.push([t,n,e]):(r[n]=e,k.push([r,n,t]))}function A(e,t,n,r,a,s,i){var o;if(s+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void x(v,e,t,a);if(void 0!==i.depthLimit&&s>i.depthLimit)return void x(w,e,t,a);if(void 0!==i.edgesLimit&&n+1>i.edgesLimit)return void x(w,e,t,a);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)A(e[o],o,o,r,e,s,i);else{var l=Object.keys(e);for(o=0;o<l.length;o++){var c=l[o];A(e[c],c,o,r,e,s,i)}}r.pop()}}function S(e){const t=(0,h.Ec)(),n=(0,h.yk)(),r=e.extra??{},a=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...a}},e}function I(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const T=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class P{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const n=new Promise((e=>{t=e})),r=E(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),n+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}class C{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new P}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===(0,h.Az)("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});const t=C.getDefaultClientConfig();if(this.tracingSampleRate=(()=>{const e=(0,h.Jz)("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=I(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=I(e.apiKey??t.apiKey),this.webUrl=I(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new c(e.callerOptions??{}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new c({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:T}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=(0,h.Jz)("API_KEY");return{apiUrl:(0,h.Jz)("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===(0,h.Jz)("HIDE_INPUTS"),hideOutputs:"true"===(0,h.Jz)("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${p.Ls}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,a=await this.caller.call((0,i.Y)(),r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));const s=`${this.apiUrl}${e}?${t}`,o=await this.caller.call((0,i.Y)(),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,`Failed to fetch ${e}`);const l=n?n(await o.json()):await o.json();if(0===l.length)break;if(yield l,l.length<a)break;r+=l.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const a=t?{...t}:{};for(;;){const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)}),s=await t.json();if(!s)break;if(!s[r])break;yield s[r];const o=s.cursors;if(!o)break;if(!o.next)break;a.cursor=o.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.id)?this.filteredPostUuids.delete(n.id):t.push(n);return t}{const t=[];for(const n of e)n.id!==n.trace_id&&!this.filteredPostUuids.has(n.trace_id)||Math.random()<this.tracingSampleRate?t.push(n):this.filteredPostUuids.add(n.id);return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}async _getMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[n,r]=this.autoBatchQueue.pop(e);if(!n.length){r();break}const a=this._processBatch(n,r).catch(console.error);t.push(a)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},n=await this._ensureServerInfo();n?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}else t()}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=S(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>n&&this.drainAutoBatchQueue(n),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(n)}),this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await(0,i.Y)()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(2500),...this.fetchOptions});return await _(e,"get server info"),e.json()}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const a=S(r),s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:E(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(s,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const a={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!a.post.length&&!a.patch.length)return;const s={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=a[t].reverse();let r=n.pop();for(;void 0!==r;)s[t].push(r),r=n.pop()}(s.post.length>0||s.patch.length>0)&&await this._postBatchIngestRuns(E(s))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call((0,i.Y)(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const n={};let r=[];for(const t of e??[]){const e=this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(n[e.id]=e.attachments),delete e.attachments,r.push(e)}let a=[];for(const e of t??[])a.push(this.prepareRunCreateOrUpdateInputs(e));if(void 0!==r.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==a.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(r.length>0&&a.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of a)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),a=t}if(0===r.length&&0===a.length)return;const s=[],i=[];for(const[e,t]of[["post",r],["patch",a]])for(const r of t){const{inputs:t,outputs:a,events:o,attachments:l,...c}=r,u={inputs:t,outputs:a,events:o},d=E(c);i.push({name:`${e}.${c.id}`,payload:new Blob([d],{type:`application/json; length=${d.length}`})});for(const[t,n]of Object.entries(u)){if(void 0===n)continue;const r=E(n);i.push({name:`${e}.${c.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==c.id){const e=n[c.id];if(e){delete n[c.id];for(const[t,n]of Object.entries(e)){let e,r;Array.isArray(n)?[e,r]=n:(e=n.mimeType,r=n.data),t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${c.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):i.push({name:`attachment.${c.id}.${t}`,payload:new Blob([r],{type:`${e}; length=${r.byteLength}`})})}}}s.push(`trace=${c.trace_id},id=${c.id}`)}await this._sendMultipartRequest(i,s.join("; "))}async _sendMultipartRequest(e,t){try{const t="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),n=[];for(const r of e)n.push(new Blob([`--${t}\r\n`])),n.push(new Blob([`Content-Disposition: form-data; name="${r.name}"\r\n`,`Content-Type: ${r.payload.type}\r\n\r\n`])),n.push(r.payload),n.push(new Blob(["\r\n"]));n.push(new Blob([`--${t}--\r\n`]));const r=new Blob(n),a=await r.arrayBuffer(),s=await this.batchIngestCaller.call((0,i.Y)(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${t}`},body:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(s,"ingest multipart runs",!0)}catch(e){console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){m(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:n}).catch(console.error):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:E(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){m(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:(0,h.Jz)("PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:a,referenceExampleId:s,startTime:i,executionOrder:o,isRoot:l,runType:c,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));b.push(...t)}const _={session:b.length?b:null,run_type:c,reference_example:s,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:r,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:a,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l};let w=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(w>=g)break;if(e.length+w>g){const t=e.slice(0,g-w);yield*t;break}w+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:a,projectIds:s,referenceExampleIds:o,startTime:l,endTime:c,error:u,query:d,filter:h,traceFilter:p,treeFilter:f,isRoot:m,dataSourceType:g}){let y=s||[];a&&(y=[...s||[],...await Promise.all(a.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const b={id:e,trace:t,parent_run:n,run_type:r,session:y,reference_example:o,start_time:l,end_time:c,error:u,query:d,filter:h,trace_filter:p,tree_filter:f,is_root:m,data_source_type:g},_=Object.fromEntries(Object.entries(b).filter((([e,t])=>void 0!==t))),w=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(_),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await w.json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||r.A()};m(e);const a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await a.json();if(null===s||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){m(e);const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare run",!0)}async readRunSharedLink(e){m(e);const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);m(e);const r=await this.caller.call((0,i.Y)(),`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),m(e);const n=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const n={dataset_id:e};m(e);const r=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){m(e);const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare dataset",!0)}async readSharedDataset(e){m(e);const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>r.append(e,t))):r.append(e,t)}));const a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await a.json();if(!a.ok){if("detail"in s)throw new Error(`Failed to list shared examples.\nStatus: ${a.status}\nMessage: ${s.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`)}return s.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:a=null,referenceDatasetId:s=null}){const o=r?"?upsert=true":"",l=`${this.apiUrl}/sessions${o}`,c=a||{};n&&(c.metadata=n);const u={name:e,extra:c,description:t};null!==s&&(u.reference_dataset_id=s);const d=await this.caller.call((0,i.Y)(),l,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:a=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${e}`;let l=a;r&&(l={...l||{},metadata:r});const c={name:t,extra:l,description:n,end_time:s?new Date(s).toISOString():null},u=await this.caller.call((0,i.Y)(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"update project"),await u.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const a=await this.caller.call((0,i.Y)(),`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)m(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==n&&a.append("include_stats",n.toString());const s=await this._get(r,a);let i;if(Array.isArray(s)){if(0===s.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:a,referenceFree:s,metadata:i}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==n&&o.append("name_contains",n),void 0!==r)o.append("reference_dataset",r);else if(void 0!==a){const e=await this.readDataset({datasetName:a});o.append("reference_dataset",e.id)}void 0!==s&&o.append("reference_free",s.toString()),void 0!==i&&o.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,m(n);const r=await this.caller.call((0,i.Y)(),`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete session ${n} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:a,dataType:s,name:o}){const l=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach((e=>{c.append("input_keys",e)})),r.forEach((e=>{c.append("output_keys",e)})),a&&c.append("description",a),s&&c.append("data_type",s),o&&c.append("name",o);const u=await this.caller.call((0,i.Y)(),l,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"upload CSV"),await u.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:a,metadata:s}={}){const o={name:e,description:t,extra:s?{metadata:s}:void 0};n&&(o.data_type=n),r&&(o.inputs_schema_definition=r),a&&(o.outputs_schema_definition=a);const l=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(l,"create dataset"),await l.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)m(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const a=await this._get(n,r);let s;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:a,metadata:s}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==a&&i.append("name_contains",a),void 0!==s&&i.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:n})).id;m(a);const s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(s,"update dataset"),await s.json()}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");m(r),n+=`/${r}`;const a=await this.caller.call((0,i.Y)(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,`delete ${n}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");r||(r=(await this.readDataset({datasetName:t})).id),m(r);const a={tag:n},s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(s,"index dataset"),await s.json()}async similarExamples(e,t,n,{filter:r}={}){const a={limit:n,inputs:e};void 0!==r&&(a.filter=r),m(t);const s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(s,"fetch similar examples"),(await s.json()).examples}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:a,exampleId:s,metadata:o,split:l,sourceRunId:c}){let u=n;if(void 0===u&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==u&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===u&&(u=(await this.readDataset({datasetName:r})).id);const d=a||new Date,h={dataset_id:u,inputs:e,outputs:t,created_at:d?.toISOString(),id:s,metadata:o,split:l,source_run_id:c},p=await this.caller.call((0,i.Y)(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(p,"create example"),await p.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:a,exampleIds:s,datasetId:o,datasetName:l}=e;let c=o;if(void 0===c&&void 0===l)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==l)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:l});c=e.id}const u=t.map(((t,i)=>({dataset_id:c,inputs:t,outputs:n?n[i]:void 0,metadata:r?r[i]:void 0,split:e.splits?e.splits[i]:void 0,id:s?s[i]:void 0,source_run_id:a?a[i]:void 0}))),d=await this.caller.call((0,i.Y)(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(d,"create examples"),await d.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>u(e)?d(e):e)),a=u(t)?d(t):t;return this.createExample({input:r},{output:a},n)}async readExample(e){m(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:r,...a}=n,s=a;return r&&(s.attachments=Object.entries(r).reduce(((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url},e)),{})),s}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:a,inlineS3Urls:s,metadata:i,limit:o,offset:l,filter:c,includeAttachments:u}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:d}),p=r?"string"==typeof r?r:r?.toISOString():void 0;p&&h.append("as_of",p);const f=s??!0;if(h.append("inline_s3_urls",f.toString()),void 0!==n)for(const e of n)h.append("id",e);if(void 0!==a)for(const e of a)h.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==l&&h.append("offset",l.toString()),void 0!==c&&h.append("filter",c),!0===u&&["attachment_urls","outputs","metadata"].forEach((e=>h.append("select",e)));let m=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e){const{attachment_urls:e,...n}=t,r=n;e&&(r.attachments=Object.entries(e).reduce(((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url},e)),{})),yield r,m++}if(void 0!==o&&m>=o)break}}async deleteExample(e){m(e);const t=`/examples/${e}`,n=await this.caller.call((0,i.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,`delete ${t}`),await n.json()}async updateExample(e,t){m(e);const n=await this.caller.call((0,i.Y)(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"update example"),await n.json()}async updateExamples(e){const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");r=void 0===e?(await this.readDataset({datasetName:t})).id:e,m(r);const a=new URLSearchParams,s=n?"string"==typeof n?n:n?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${r}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:a=!1}){let s;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");s=void 0===e?(await this.readDataset({datasetName:t})).id:e,m(s);const o={split_name:n,examples:r.map((e=>(m(e),e))),remove:a},l=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:a}={loadChildRuns:!1}){let s;if((0,g.m)("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)s=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(a=await this.readExample(s.reference_example_id));const i=await t.evaluateRun(s,a),[o,l]=await this._logEvaluationFeedback(i,s,n);return l[0]}async createFeedback(e,t,{score:n,value:a,correction:s,comment:o,sourceInfo:l,feedbackSourceType:c="api",sourceRunId:u,feedbackId:d,feedbackConfig:h,projectId:p,comparativeExperimentId:f}){if(!e&&!p)throw new Error("One of runId or projectId must be provided");if(e&&p)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:l??{}};void 0===u||void 0===g?.metadata||g.metadata.__run||(g.metadata.__run={run_id:u}),void 0!==g?.metadata&&void 0!==g.metadata.__run?.run_id&&m(g.metadata.__run.run_id);const y={id:d??r.A(),run_id:e,key:t,score:n,value:a,correction:s,comment:o,feedback_source:g,comparative_experiment_id:f,feedbackConfig:h,session_id:p},b=`${this.apiUrl}/feedback`,w=await this.caller.call((0,i.Y)(),b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(y),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(w,"create feedback",!0),y}async updateFeedback(e,{score:t,value:n,correction:r,comment:a}){const s={};null!=t&&(s.score=t),null!=n&&(s.value=n),null!=r&&(s.correction=r),null!=a&&(s.comment=a),m(e);const o=await this.caller.call((0,i.Y)(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"update feedback",!0)}async readFeedback(e){m(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){m(e);const t=`/feedback/${e}`,n=await this.caller.call((0,i.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,`delete ${t}`),await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const a={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?a.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(a.expires_in=n):a.expires_in={hours:3};const s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:a,metadata:s,id:o}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const l={id:o,name:e,experiment_ids:t,reference_dataset_id:n,description:a,created_at:(r??new Date)?.toISOString(),extra:{}};s&&(l.extra.metadata=s);const c=await this.caller.call((0,i.Y)(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){m(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),a=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let s=null;e.targetRunId?s=e.targetRunId:t&&(s=t.id),a.push(await this.createFeedback(s,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,a]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:a}=e,s=new URLSearchParams;t&&t.forEach(((e,t)=>{m(e,`queueIds[${t}]`),s.append("ids",e)})),n&&s.append("name",n),r&&s.append("name_contains",r),s.append("limit",(void 0!==a?Math.min(a,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",s))if(yield*e,i++,void 0!==a&&i>=a)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:a}=e,s={name:t,description:n,id:a||r.A()},o=await this.caller.call((0,i.Y)(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(o,"create annotation queue"),await o.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:n,description:r}=t,a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:n,description:r}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const n=await this.caller.call((0,i.Y)(),`${this.apiUrl}/annotation-queues/${m(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>m(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${m(e,"queueId")}/run`,r=await this.caller.call((0,i.Y)(),`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(r,"get run from annotation queue"),await r.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call((0,i.Y)(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(!t.ok){const e="string"==typeof n.detail?n.detail:JSON.stringify(n.detail),r=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw r.statusCode=t.status,r}if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,a]=y(e),s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(s,(t?"like":"unlike")+" prompt"),await s.json()}async _getPromptUrl(e){const[t,n,r]=y(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,n,r]=y(e),a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===a.status)return null;await _(a,"get prompt");const s=await a.json();return s.repo?s.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,a,s]=y(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const o={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},l=await this.caller.call((0,i.Y)(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"create prompt");const{repo:c}=await l.json();return c}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a,s]=y(e),o="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${a}`),l={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call((0,i.Y)(),`${this.apiUrl}/commits/${r}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(c,"create commit");const u=await c.json();return this._getPromptUrl(`${r}/${a}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const n=new FormData;for(const e of t){const t=e.id,r=E({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}}),a=new Blob([r],{type:"application/json"});if(n.append(t,a),e.inputs){const r=E(e.inputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,a)}if(e.outputs){const r=E(e.outputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,a)}if(e.attachments)for(const[r,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});n.append(`${t}.attachment.${r}`,i)}if(e.attachments_operations){const r=E(e.attachments_operations),a=new Blob([r],{type:"application/json"});n.append(`${t}.attachments_operations`,a)}}const r=await this.caller.call((0,i.Y)(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:n});return await r.json()}async uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");const n=new FormData;for(const e of t){const t=(e.id??r.A()).toString(),a=E({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}}),s=new Blob([a],{type:"application/json"});n.append(t,s);const i=E(e.inputs),o=new Blob([i],{type:"application/json"});if(n.append(`${t}.inputs`,o),e.outputs){const r=E(e.outputs),a=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,a)}if(e.attachments)for(const[r,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});n.append(`${t}.attachment.${r}`,i)}}const a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:n});return await a.json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=y(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const a={};if(void 0!==t?.description&&(a.description=t.description),void 0!==t?.readme&&(a.readme=t.readme),void 0!==t?.tags&&(a.tags=t.tags),void 0!==t?.isPublic&&(a.is_public=t.isPublic),void 0!==t?.isArchived&&(a.is_archived=t.isArchived),0===Object.keys(a).length)throw new Error("No valid update options provided");const s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(s,"update prompt"),s.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=y(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const a=await this.caller.call((0,i.Y)(),`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async pullPromptCommit(e,t){const[n,r,a]=y(e),s=await this.caller.call((0,i.Y)(),`${this.apiUrl}/commits/${n}/${r}/${a}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(s,"pull prompt commit");const o=await s.json();return{owner:n,repo:r,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[a,s]=this.parseTokenOrUrl(e,n),i=new C({apiUrl:a,apiKey:"placeholder"}),o=await i.readSharedDataset(s),l=r||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}const c=await i.listSharedExamples(s),u=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map((e=>e.inputs)),outputs:c.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return m(e),[t,e]}catch(e){}try{const a=new URL(e).pathname.split("/").filter((e=>""!==e));if(a.length>=n)return[t,a[a.length-n]];throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map((({itemPromise:e})=>e)),this.batchIngestCaller.queue.onIdle()])}}},6928:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>r.Kj,Ls:()=>s,gk:()=>a.gk});var r=n(9056),a=n(3246);n(747);const s="0.2.14"},3246:(e,t,n)=>{"use strict";n.d(t,{gk:()=>c,m5:()=>u});var r=n(5230),a=n(4785),s=n(9056),i=n(6232);const o=Symbol.for("lc:context_variables");class l{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let n={},r=[];for(const e of t){const[t,a]=e.split("="),s=decodeURIComponent(a);"langsmith-metadata"===t?n=JSON.parse(s):"langsmith-tags"===t&&(r=s.split(","))}return new l(n,r)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class c{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),u(e))return void Object.assign(this,{...e});const t=c.getDefaultConfig(),{metadata:n,...r}=e,a=r.client??c.getSharedClient(),s={...n,...r?.extra?.metadata};if(r.extra={...r.extra,metadata:s},Object.assign(this,{...t,...r,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const e=function(e,t,n=1){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}static getDefaultConfig(){return{id:r.A(),run_type:"chain",project_name:(0,a.Az)("LANGCHAIN_PROJECT")??(0,a.Az)("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:(0,a.Az)("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:(0,a.Az)("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return c.sharedClient||(c.sharedClient=new s.Kj),c.sharedClient}createChild(e){const t=this.child_execution_order+1,n=new c({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});o in this&&(n[o]=this[o]);const r=Symbol.for("lc:child_config"),a=e.extra?.[r]??this.extra[r];if(void 0!==(s=a)&&"object"==typeof s.callbacks&&(h(s.callbacks?.handlers)||h(s.callbacks))){const e={...a},t=function(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:n.id}),t.handlers?.find(d)?.updateFromRunTree?.(n),e.callbacks=t),n.extra[r]=e}var s;const i=new Set;let l=this;for(;null!=l&&!i.has(l.id);)i.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,t),l=l.parent_run;return this.child_runs.push(n),n}async end(e,t,n=Date.now(),r){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,r&&Object.keys(r).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...r}}:{metadata:r})}_convertToCreate(e,t,n=!0){const r=e.extra??{};if(r.runtime||(r.runtime={}),t)for(const[e,n]of Object.entries(t))r.runtime[e]||(r.runtime[e]=n);let a,s;return n?(s=e.parent_run?.id,a=[]):(a=e.child_runs.map((e=>this._convertToCreate(e,t,n))),s=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:r,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=(0,a.Ec)(),n=await this._convertToCreate(this,t,!0);if(await this.client.createRun(n),!e){(0,i.m)("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){const n=e?.callbacks;let r,s,i,o=!!["TRACING_V2","TRACING"].find((e=>"true"===(0,a.Jz)(e)));if(n){const e=n?.getParentRunId?.()??"",t=n?.handlers?.find((e=>"langchain_tracer"==e?.name));r=t?.getRun?.(e),s=t?.projectName,i=t?.client,o=o||!!t}return r?new c({name:r.name,id:r.id,trace_id:r.trace_id,dotted_order:r.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set((r?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...r?.extra?.metadata,...e?.metadata}}}).createChild(t):new c({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const n="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,r=n["langsmith-trace"];if(!r||"string"!=typeof r)return;const a=r.trim(),s=a.split(".").map((e=>{const[t,n]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:n}})),i=s[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:i,dotted_order:a};if(n.baggage&&"string"==typeof n.baggage){const e=l.fromHeader(n.baggage);o.metadata=e.metadata,o.tags=e.tags}return new c(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new l(this.extra?.metadata,this.tags).toHeader()};if(e)for(const[n,r]of Object.entries(t))e.set(n,r);return t}}function u(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function d(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function h(e){return Array.isArray(e)&&e.some((e=>d(e)))}Object.defineProperty(c,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})},747:(e,t,n)=>{"use strict";n.d(t,{Y:()=>s});const r=(...e)=>fetch(...e),a=Symbol.for("ls:fetch_implementation"),s=()=>globalThis[a]??r},4785:(e,t,n)=>{"use strict";n.d(t,{Az:()=>d,Ec:()=>c,Jz:()=>h,yk:()=>u});var r=n(6928);let a;const s=()=>"undefined"!=typeof Deno,i=()=>a||(a="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||s()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":s()?"deno":"other":"node",a);let o,l;function c(){if(void 0===o){const e=i(),t=function(){if(void 0!==l)return l;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=d(n);void 0!==e&&(t[n]=e)}return l=t,t}();o={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:r.Ls,...t}}return o}function u(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(e))!r.startsWith("LANGCHAIN_")&&!r.startsWith("LANGSMITH_")||"string"!=typeof a||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=a:t[r]=a);return t}function d(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function h(e){return d(`LANGSMITH_${e}`)||d(`LANGCHAIN_${e}`)}},6232:(e,t,n)=>{"use strict";n.d(t,{m:()=>a});const r={};function a(e){r[e]||(console.warn(e),r[e]=!0)}},1259:(e,t,n)=>{"use strict";n.d(t,{Kj:()=>r.Kj,gk:()=>r.gk});var r=n(6928)},3389:(e,t,n)=>{"use strict";n.d(t,{vR:()=>o,GZ:()=>l});var r=n(3246);const a=Symbol.for("ls:tracing_async_local_storage"),s=new class{getStore(){}run(e,t){return t()}},i=new class{getInstance(){return globalThis[a]??s}initializeGlobalInstance(e){void 0===globalThis[a]&&(globalThis[a]=e)}},o=()=>{const e=i.getInstance().getStore();if(!(0,r.m5)(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e};function l(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root")},2522:(e,t,n)=>{"use strict";n.d(t,{Ik:()=>I});const r=Symbol("Let zodToJsonSchema decide on which parser to use"),a={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};var s=n(4476);function i(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function o(e,t,n,r,a){e[t]=n,i(e,t,r,a)}function l(e,t){return O(e.type._def,t)}function c(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>c(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return u(e,t)}}const u=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":o(n,"minimum",r.value,r.message,t);break;case"max":o(n,"maximum",r.value,r.message,t)}return n};let d;const h={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===d&&(d=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),d),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function p(e,t){const n={type:"string"};if(e.checks)for(const r of e.checks)switch(r.kind){case"min":o(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":o(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":g(n,"email",r.message,t);break;case"format:idn-email":g(n,"idn-email",r.message,t);break;case"pattern:zod":y(n,h.email,r.message,t)}break;case"url":g(n,"uri",r.message,t);break;case"uuid":g(n,"uuid",r.message,t);break;case"regex":y(n,r.regex,r.message,t);break;case"cuid":y(n,h.cuid,r.message,t);break;case"cuid2":y(n,h.cuid2,r.message,t);break;case"startsWith":y(n,RegExp(`^${f(r.value,t)}`),r.message,t);break;case"endsWith":y(n,RegExp(`${f(r.value,t)}$`),r.message,t);break;case"datetime":g(n,"date-time",r.message,t);break;case"date":g(n,"date",r.message,t);break;case"time":g(n,"time",r.message,t);break;case"duration":g(n,"duration",r.message,t);break;case"length":o(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),o(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":y(n,RegExp(f(r.value,t)),r.message,t);break;case"ip":"v6"!==r.version&&g(n,"ipv4",r.message,t),"v4"!==r.version&&g(n,"ipv6",r.message,t);break;case"base64url":y(n,h.base64url,r.message,t);break;case"jwt":y(n,h.jwt,r.message,t);break;case"cidr":"v6"!==r.version&&y(n,h.ipv4Cidr,r.message,t),"v4"!==r.version&&y(n,h.ipv6Cidr,r.message,t);break;case"emoji":y(n,h.emoji(),r.message,t);break;case"ulid":y(n,h.ulid,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":g(n,"binary",r.message,t);break;case"contentEncoding:base64":o(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":y(n,h.base64,r.message,t)}break;case"nanoid":y(n,h.nanoid,r.message,t)}return n}function f(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let n=0;n<e.length;n++)m.has(e[n])||(t+="\\"),t+=e[n];return t}(e):e}const m=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function g(e,t,n,r){e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):o(e,"format",t,n,r)}function y(e,t,n,r){e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:b(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):o(e,"pattern",b(t,r),n,r)}function b(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const n=e.flags.includes("i"),r=e.flags.includes("m"),a=e.flags.includes("s"),s=n?e.source.toLowerCase():e.source;let i="",o=!1,l=!1,c=!1;for(let e=0;e<s.length;e++)if(o)i+=s[e],o=!1;else{if(n)if(l){if(s[e].match(/[a-z]/)){c?(i+=s[e],i+=`${s[e-2]}-${s[e]}`.toUpperCase(),c=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(i+=s[e],c=!0):i+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){i+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(r){if("^"===s[e]){i+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){i+="($|(?=[\r\n]))";continue}}a&&"."===s[e]?i+=l?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(i+=s[e],"\\"===s[e]?o=!0:l&&"]"===s[e]?l=!1:l||"["!==s[e]||(l=!0))}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function _(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===s.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:O(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:O(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===s.kY.ZodString&&e.keyType._def.checks?.length){const{type:r,...a}=p(e.keyType._def,t);return{...n,propertyNames:a}}if(e.keyType?._def.typeName===s.kY.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===s.kY.ZodBranded&&e.keyType._def.type._def.typeName===s.kY.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...a}=l(e.keyType._def,t);return{...n,propertyNames:a}}return n}const w={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},v=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>O(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function k(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:O(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:O(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function O(e,t,n=!1){const a=t.seen.get(e);if(t.override){const s=t.override?.(e,t,a,n);if(s!==r)return s}if(a&&!n){const e=E(a,t);if(void 0!==e)return e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const i=A(e,e.typeName,t);return i&&S(e,t,i),s.jsonSchema=i,i}const E=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:x(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},x=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},A=(e,t,n)=>{switch(t){case s.kY.ZodString:return p(e,n);case s.kY.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",i(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?o(n,"minimum",r.value,r.message,t):o(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),o(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?o(n,"maximum",r.value,r.message,t):o(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),o(n,"maximum",r.value,r.message,t));break;case"multipleOf":o(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case s.kY.ZodObject:return function(e,t){const n="openAi"===t.target,r={type:"object",...Object.entries(e.shape()).reduce(((e,[r,a])=>{if(void 0===a||void 0===a._def)return e;let i=a.isOptional();i&&n&&(a instanceof s.Ii&&(a=a._def.innerType),a.isNullable()||(a=a.nullable()),i=!1);const o=O(a._def,{...t,currentPath:[...t.currentPath,"properties",r],propertyPath:[...t.currentPath,"properties",r]});return void 0===o?e:{properties:{...e.properties,[r]:o},required:i?e.required:[...e.required,r]}}),{properties:{},required:[]}),additionalProperties:k(e,t)};return r.required.length||delete r.required,r}(e,n);case s.kY.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?o(n,"minimum",r.value,r.message,t):o(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),o(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?o(n,"maximum",r.value,r.message,t):o(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),o(n,"maximum",r.value,r.message,t));break;case"multipleOf":o(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case s.kY.ZodBoolean:return{type:"boolean"};case s.kY.ZodDate:return c(e,n);case s.kY.ZodUndefined:return{not:{}};case s.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case s.kY.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==s.kY.ZodAny&&(n.items=O(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&o(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&o(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(o(n,"minItems",e.exactLength.value,e.exactLength.message,t),o(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case s.kY.ZodUnion:case s.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return v(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in w&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=w[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return v(e,t)}(e,n);case s.kY.ZodIntersection:return function(e,t){const n=[O(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),O(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),a.length?{allOf:a,...r}:void 0}(e,n);case s.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>O(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:O(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>O(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case s.kY.ZodRecord:return _(e,n);case s.kY.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case s.kY.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case s.kY.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case s.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:w[e.innerType._def.typeName],nullable:!0}:{type:[w[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=O(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=O(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case s.kY.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return O(e.innerType._def,t);const n=O(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case s.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?_(e,t):{type:"array",maxItems:125,items:{type:"array",items:[O(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},O(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case s.kY.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:O(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&o(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&o(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case s.kY.ZodLazy:return O(e.getter()._def,n);case s.kY.ZodPromise:return function(e,t){return O(e.type._def,t)}(e,n);case s.kY.ZodNaN:case s.kY.ZodNever:return{not:{}};case s.kY.ZodEffects:return function(e,t){return"input"===t.effectStrategy?O(e.schema._def,t):{}}(e,n);case s.kY.ZodAny:case s.kY.ZodUnknown:return{};case s.kY.ZodDefault:return function(e,t){return{...O(e.innerType._def,t),default:e.defaultValue()}}(e,n);case s.kY.ZodBranded:return l(e,n);case s.kY.ZodReadonly:case s.kY.ZodCatch:return((e,t)=>O(e.innerType._def,t))(e,n);case s.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return O(e.in._def,t);if("output"===t.pipeStrategy)return O(e.out._def,t);const n=O(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,O(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case s.kY.ZodFunction:case s.kY.ZodVoid:case s.kY.ZodSymbol:default:return}},S=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),I=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...a,name:e}:{...a,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,r])=>({...e,[t]:O(r._def,{...n,currentPath:[...n.basePath,n.definitionPath,t]},!0)??{}})),{}):void 0,s="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,i=O(e._def,void 0===s?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??{},o="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==o&&(i.title=o);const l=void 0===s?r?{...i,[n.definitionPath]:r}:i:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:i}};return"jsonSchema7"===n.target?l.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==n.target&&"openAi"!==n.target||(l.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===n.target&&("anyOf"in l||"oneOf"in l||"allOf"in l||"type"in l&&Array.isArray(l.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),l}},4476:(e,t,n)=>{"use strict";var r,a;n.d(t,{Ii:()=>Ce,kY:()=>Be,z:()=>xt}),function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(r||(r={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(a||(a={}));const s=r.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),i=e=>{switch(typeof e){case"undefined":return s.undefined;case"string":return s.string;case"number":return isNaN(e)?s.nan:s.number;case"boolean":return s.boolean;case"function":return s.function;case"bigint":return s.bigint;case"symbol":return s.symbol;case"object":return Array.isArray(e)?s.array:null===e?s.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?s.promise:"undefined"!=typeof Map&&e instanceof Map?s.map:"undefined"!=typeof Set&&e instanceof Set?s.set:"undefined"!=typeof Date&&e instanceof Date?s.date:s.object;default:return s.unknown}},o=r.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class l extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(r);else if("invalid_return_type"===a.code)r(a.returnTypeError);else if("invalid_arguments"===a.code)r(a.argumentsError);else if(0===a.path.length)n._errors.push(t(a));else{let e=n,r=0;for(;r<a.path.length;){const n=a.path[r];r===a.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(a))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof l))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,r.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=(e=>e.message)){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}l.create=e=>new l(e);const c=(e,t)=>{let n;switch(e.code){case o.invalid_type:n=e.received===s.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case o.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,r.jsonStringifyReplacer)}`;break;case o.unrecognized_keys:n=`Unrecognized key(s) in object: ${r.joinValues(e.keys,", ")}`;break;case o.invalid_union:n="Invalid input";break;case o.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${r.joinValues(e.options)}`;break;case o.invalid_enum_value:n=`Invalid enum value. Expected ${r.joinValues(e.options)}, received '${e.received}'`;break;case o.invalid_arguments:n="Invalid function arguments";break;case o.invalid_return_type:n="Invalid function return type";break;case o.invalid_date:n="Invalid date";break;case o.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:r.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case o.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case o.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case o.custom:n="Invalid input";break;case o.invalid_intersection_types:n="Intersection results could not be merged";break;case o.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case o.not_finite:n="Number must be finite";break;default:n=t.defaultError,r.assertNever(e)}return{message:n}};let u=c;function d(){return u}const h=e=>{const{data:t,path:n,errorMaps:r,issueData:a}=e,s=[...n,...a.path||[]],i={...a,path:s};if(void 0!==a.message)return{...a,path:s,message:a.message};let o="";const l=r.filter((e=>!!e)).slice().reverse();for(const e of l)o=e(i,{data:t,defaultError:o}).message;return{...a,path:s,message:o}};function p(e,t){const n=d(),r=h({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===c?void 0:c].filter((e=>!!e))});e.common.issues.push(r)}class f{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return m;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return f.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:a}=r;if("aborted"===t.status)return m;if("aborted"===a.status)return m;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!r.alwaysSet||(n[t.value]=a.value)}return{status:e.value,value:n}}}const m=Object.freeze({status:"aborted"}),g=e=>({status:"dirty",value:e}),y=e=>({status:"valid",value:e}),b=e=>"aborted"===e.status,_=e=>"dirty"===e.status,w=e=>"valid"===e.status,v=e=>"undefined"!=typeof Promise&&e instanceof Promise;function k(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function O(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n}var E,x,A;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(E||(E={}));class S{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const I=(e,t)=>{if(w(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new l(e.common.issues);return this._error=t,this._error}}};function T(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:a}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{var s,i;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:a.defaultError}:void 0===a.data?{message:null!==(s=null!=o?o:r)&&void 0!==s?s:a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:null!==(i=null!=o?o:n)&&void 0!==i?i:a.defaultError}},description:a}}class P{get description(){return this._def.description}_getType(e){return i(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:i(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new f,ctx:{common:e.parent.common,data:e.data,parsedType:i(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(v(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:i(e)},a=this._parseSync({data:e,path:r.path,parent:r});return I(r,a)}"~validate"(e){var t,n;const r={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:i(e)};if(!this["~standard"].async)try{const t=this._parseSync({data:e,path:[],parent:r});return w(t)?{value:t.value}:{issues:r.common.issues}}catch(e){(null===(n=null===(t=null==e?void 0:e.message)||void 0===t?void 0:t.toLowerCase())||void 0===n?void 0:n.includes("encountered"))&&(this["~standard"].async=!0),r.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:r}).then((e=>w(e)?{value:e.value}:{issues:r.common.issues}))}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:i(e)},r=this._parse({data:e,path:n.path,parent:n}),a=await(v(r)?r:Promise.resolve(r));return I(n,a)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const a=e(t),s=()=>r.addIssue({code:o.custom,...n(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then((e=>!!e||(s(),!1))):!!a||(s(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new Pe({schema:this,typeName:Be.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Ce.create(this,this._def)}nullable(){return Re.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return de.create(this)}promise(){return Te.create(this,this._def)}or(e){return fe.create([this,e],this._def)}and(e){return be.create(this,e,this._def)}transform(e){return new Pe({...T(this._def),schema:this,typeName:Be.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Ne({...T(this._def),innerType:this,defaultValue:t,typeName:Be.ZodDefault})}brand(){return new Le({typeName:Be.ZodBranded,type:this,...T(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new je({...T(this._def),innerType:this,catchValue:t,typeName:Be.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return De.create(this,e)}readonly(){return Ue.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const C=/^c[^\s-]{8,}$/i,R=/^[0-9a-z]+$/,N=/^[0-9A-HJKMNP-TV-Z]{26}$/i,j=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,$=/^[a-z0-9_-]{21}$/i,M=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,L=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,D=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let U;const F=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,z=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,B=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Z=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,H=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,q=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,G="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Y=new RegExp(`^${G}$`);function K(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function V(e){let t=`${G}T${K(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function J(e,t){if(!M.test(e))return!1;try{const[n]=e.split("."),r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),a=JSON.parse(atob(r));return!("object"!=typeof a||null===a||!a.typ||!a.alg||t&&a.alg!==t)}catch(e){return!1}}function W(e,t){return!("v4"!==t&&t||!z.test(e))||!("v6"!==t&&t||!Z.test(e))}class X extends P{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==s.string){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.string,received:t.parsedType}),m}const t=new f;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:o.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:o.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?p(n,{code:o.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&p(n,{code:o.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)D.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"email",code:o.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)U||(U=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),U.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"emoji",code:o.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)j.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"uuid",code:o.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)$.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"nanoid",code:o.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)C.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cuid",code:o.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)R.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cuid2",code:o.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)N.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"ulid",code:o.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch(r){n=this._getOrReturnCtx(e,n),p(n,{validation:"url",code:o.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"regex",code:o.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?V(s).test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?Y.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?new RegExp(`^${K(s)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{code:o.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?L.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"duration",code:o.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?(a=e.data,("v4"!==(i=s.version)&&i||!F.test(a))&&("v6"!==i&&i||!B.test(a))&&(n=this._getOrReturnCtx(e,n),p(n,{validation:"ip",code:o.invalid_string,message:s.message}),t.dirty())):"jwt"===s.kind?J(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"jwt",code:o.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?W(e.data,s.version)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"cidr",code:o.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?H.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"base64",code:o.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?q.test(e.data)||(n=this._getOrReturnCtx(e,n),p(n,{validation:"base64url",code:o.invalid_string,message:s.message}),t.dirty()):r.assertNever(s);var a,i;return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:o.invalid_string,...E.errToObj(n)})}_addCheck(e){return new X({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...E.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...E.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...E.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...E.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...E.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...E.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...E.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new X({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new X({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new X({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isCIDR(){return!!this._def.checks.find((e=>"cidr"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get isBase64url(){return!!this._def.checks.find((e=>"base64url"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Q(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,a=n>r?n:r;return parseInt(e.toFixed(a).replace(".",""))%parseInt(t.toFixed(a).replace(".",""))/Math.pow(10,a)}X.create=e=>{var t;return new X({checks:[],typeName:Be.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...T(e)})};class ee extends P{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==s.number){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.number,received:t.parsedType}),m}let t;const n=new f;for(const a of this._def.checks)"int"===a.kind?r.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),p(t,{code:o.invalid_type,expected:"integer",received:"float",message:a.message}),n.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),n.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),n.dirty()):"multipleOf"===a.kind?0!==Q(e.data,a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),n.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_finite,message:a.message}),n.dirty()):r.assertNever(a);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,n,r){return new ee({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:E.toString(r)}]})}_addCheck(e){return new ee({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&r.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ee.create=e=>new ee({checks:[],typeName:Be.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...T(e)});class te extends P{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(t){return this._getInvalidInput(e)}if(this._getType(e)!==s.bigint)return this._getInvalidInput(e);let t;const n=new f;for(const a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),n.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),n.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),p(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),n.dirty()):r.assertNever(a);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.bigint,received:t.parsedType}),m}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,n,r){return new te({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:E.toString(r)}]})}_addCheck(e){return new te({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}te.create=e=>{var t;return new te({checks:[],typeName:Be.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...T(e)})};class ne extends P{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==s.boolean){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.boolean,received:t.parsedType}),m}return y(e.data)}}ne.create=e=>new ne({typeName:Be.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...T(e)});class re extends P{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==s.date){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.date,received:t.parsedType}),m}if(isNaN(e.data.getTime()))return p(this._getOrReturnCtx(e),{code:o.invalid_date}),m;const t=new f;let n;for(const a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:o.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),t.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(n=this._getOrReturnCtx(e,n),p(n,{code:o.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),t.dirty()):r.assertNever(a);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new re({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}re.create=e=>new re({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:Be.ZodDate,...T(e)});class ae extends P{_parse(e){if(this._getType(e)!==s.symbol){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.symbol,received:t.parsedType}),m}return y(e.data)}}ae.create=e=>new ae({typeName:Be.ZodSymbol,...T(e)});class se extends P{_parse(e){if(this._getType(e)!==s.undefined){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.undefined,received:t.parsedType}),m}return y(e.data)}}se.create=e=>new se({typeName:Be.ZodUndefined,...T(e)});class ie extends P{_parse(e){if(this._getType(e)!==s.null){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.null,received:t.parsedType}),m}return y(e.data)}}ie.create=e=>new ie({typeName:Be.ZodNull,...T(e)});class oe extends P{constructor(){super(...arguments),this._any=!0}_parse(e){return y(e.data)}}oe.create=e=>new oe({typeName:Be.ZodAny,...T(e)});class le extends P{constructor(){super(...arguments),this._unknown=!0}_parse(e){return y(e.data)}}le.create=e=>new le({typeName:Be.ZodUnknown,...T(e)});class ce extends P{_parse(e){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.never,received:t.parsedType}),m}}ce.create=e=>new ce({typeName:Be.ZodNever,...T(e)});class ue extends P{_parse(e){if(this._getType(e)!==s.undefined){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.void,received:t.parsedType}),m}return y(e.data)}}ue.create=e=>new ue({typeName:Be.ZodVoid,...T(e)});class de extends P{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==s.array)return p(t,{code:o.invalid_type,expected:s.array,received:t.parsedType}),m;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,a=t.data.length<r.exactLength.value;(e||a)&&(p(t,{code:e?o.too_big:o.too_small,minimum:a?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(p(t,{code:o.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(p(t,{code:o.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new S(t,e,t.path,n))))).then((e=>f.mergeArray(n,e)));const a=[...t.data].map(((e,n)=>r.type._parseSync(new S(t,e,t.path,n))));return f.mergeArray(n,a)}get element(){return this._def.type}min(e,t){return new de({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new de({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new de({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}}function he(e){if(e instanceof pe){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=Ce.create(he(r))}return new pe({...e._def,shape:()=>t})}return e instanceof de?new de({...e._def,type:he(e.element)}):e instanceof Ce?Ce.create(he(e.unwrap())):e instanceof Re?Re.create(he(e.unwrap())):e instanceof _e?_e.create(e.items.map((e=>he(e)))):e}de.create=(e,t)=>new de({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Be.ZodArray,...T(t)});class pe extends P{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=r.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==s.object){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.object,received:t.parsedType}),m}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:a}=this._getCached(),i=[];if(!(this._def.catchall instanceof ce&&"strip"===this._def.unknownKeys))for(const e in n.data)a.includes(e)||i.push(e);const l=[];for(const e of a){const t=r[e],a=n.data[e];l.push({key:{status:"valid",value:e},value:t._parse(new S(n,a,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof ce){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of i)l.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)i.length>0&&(p(n,{code:o.unrecognized_keys,keys:i}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of i){const r=n.data[t];l.push({key:{status:"valid",value:t},value:e._parse(new S(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of l){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>f.mergeObjectSync(t,e))):f.mergeObjectSync(t,l)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new pe({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,a,s,i;const o=null!==(s=null===(a=(r=this._def).errorMap)||void 0===a?void 0:a.call(r,t,n).message)&&void 0!==s?s:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(i=E.errToObj(e).message)&&void 0!==i?i:o}:{message:o}}}:{}})}strip(){return new pe({...this._def,unknownKeys:"strip"})}passthrough(){return new pe({...this._def,unknownKeys:"passthrough"})}extend(e){return new pe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new pe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Be.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new pe({...this._def,catchall:e})}pick(e){const t={};return r.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new pe({...this._def,shape:()=>t})}omit(e){const t={};return r.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new pe({...this._def,shape:()=>t})}deepPartial(){return he(this)}partial(e){const t={};return r.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new pe({...this._def,shape:()=>t})}required(e){const t={};return r.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Ce;)e=e._def.innerType;t[n]=e}})),new pe({...this._def,shape:()=>t})}keyof(){return Ae(r.objectKeys(this.shape))}}pe.create=(e,t)=>new pe({shape:()=>e,unknownKeys:"strip",catchall:ce.create(),typeName:Be.ZodObject,...T(t)}),pe.strictCreate=(e,t)=>new pe({shape:()=>e,unknownKeys:"strict",catchall:ce.create(),typeName:Be.ZodObject,...T(t)}),pe.lazycreate=(e,t)=>new pe({shape:e,unknownKeys:"strip",catchall:ce.create(),typeName:Be.ZodObject,...T(t)});class fe extends P{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new l(e.ctx.common.issues)));return p(t,{code:o.invalid_union,unionErrors:n}),m}));{let e;const r=[];for(const a of n){const n={...t,common:{...t.common,issues:[]},parent:null},s=a._parseSync({data:t.data,path:t.path,parent:n});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=r.map((e=>new l(e)));return p(t,{code:o.invalid_union,unionErrors:a}),m}}get options(){return this._def.options}}fe.create=(e,t)=>new fe({options:e,typeName:Be.ZodUnion,...T(t)});const me=e=>e instanceof Ee?me(e.schema):e instanceof Pe?me(e.innerType()):e instanceof xe?[e.value]:e instanceof Se?e.options:e instanceof Ie?r.objectValues(e.enum):e instanceof Ne?me(e._def.innerType):e instanceof se?[void 0]:e instanceof ie?[null]:e instanceof Ce?[void 0,...me(e.unwrap())]:e instanceof Re?[null,...me(e.unwrap())]:e instanceof Le||e instanceof Ue?me(e.unwrap()):e instanceof je?me(e._def.innerType):[];class ge extends P{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==s.object)return p(t,{code:o.invalid_type,expected:s.object,received:t.parsedType}),m;const n=this.discriminator,r=t.data[n],a=this.optionsMap.get(r);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(p(t,{code:o.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),m)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=me(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of t){if(r.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);r.set(a,n)}}return new ge({typeName:Be.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...T(n)})}}function ye(e,t){const n=i(e),a=i(t);if(e===t)return{valid:!0,data:e};if(n===s.object&&a===s.object){const n=r.objectKeys(t),a=r.objectKeys(e).filter((e=>-1!==n.indexOf(e))),s={...e,...t};for(const n of a){const r=ye(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===s.array&&a===s.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const a=ye(e[r],t[r]);if(!a.valid)return{valid:!1};n.push(a.data)}return{valid:!0,data:n}}return n===s.date&&a===s.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class be extends P{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(b(e)||b(r))return m;const a=ye(e.value,r.value);return a.valid?((_(e)||_(r))&&t.dirty(),{status:t.value,value:a.data}):(p(n,{code:o.invalid_intersection_types}),m)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}be.create=(e,t,n)=>new be({left:e,right:t,typeName:Be.ZodIntersection,...T(n)});class _e extends P{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==s.array)return p(n,{code:o.invalid_type,expected:s.array,received:n.parsedType}),m;if(n.data.length<this._def.items.length)return p(n,{code:o.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),m;!this._def.rest&&n.data.length>this._def.items.length&&(p(n,{code:o.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new S(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>f.mergeArray(t,e))):f.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new _e({...this._def,rest:e})}}_e.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new _e({items:e,typeName:Be.ZodTuple,rest:null,...T(t)})};class we extends P{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==s.object)return p(n,{code:o.invalid_type,expected:s.object,received:n.parsedType}),m;const r=[],a=this._def.keyType,i=this._def.valueType;for(const e in n.data)r.push({key:a._parse(new S(n,e,n.path,e)),value:i._parse(new S(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?f.mergeObjectAsync(t,r):f.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new we(t instanceof P?{keyType:e,valueType:t,typeName:Be.ZodRecord,...T(n)}:{keyType:X.create(),valueType:e,typeName:Be.ZodRecord,...T(t)})}}class ve extends P{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==s.map)return p(n,{code:o.invalid_type,expected:s.map,received:n.parsedType}),m;const r=this._def.keyType,a=this._def.valueType,i=[...n.data.entries()].map((([e,t],s)=>({key:r._parse(new S(n,e,n.path,[s,"key"])),value:a._parse(new S(n,t,n.path,[s,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of i){const r=await n.key,a=await n.value;if("aborted"===r.status||"aborted"===a.status)return m;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of i){const r=n.key,a=n.value;if("aborted"===r.status||"aborted"===a.status)return m;"dirty"!==r.status&&"dirty"!==a.status||t.dirty(),e.set(r.value,a.value)}return{status:t.value,value:e}}}}ve.create=(e,t,n)=>new ve({valueType:t,keyType:e,typeName:Be.ZodMap,...T(n)});class ke extends P{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==s.set)return p(n,{code:o.invalid_type,expected:s.set,received:n.parsedType}),m;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(p(n,{code:o.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(p(n,{code:o.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const a=this._def.valueType;function i(e){const n=new Set;for(const r of e){if("aborted"===r.status)return m;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const l=[...n.data.values()].map(((e,t)=>a._parse(new S(n,e,n.path,t))));return n.common.async?Promise.all(l).then((e=>i(e))):i(l)}min(e,t){return new ke({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new ke({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}ke.create=(e,t)=>new ke({valueType:e,minSize:null,maxSize:null,typeName:Be.ZodSet,...T(t)});class Oe extends P{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==s.function)return p(t,{code:o.invalid_type,expected:s.function,received:t.parsedType}),m;function n(e,n){return h({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,d(),c].filter((e=>!!e)),issueData:{code:o.invalid_arguments,argumentsError:n}})}function r(e,n){return h({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,d(),c].filter((e=>!!e)),issueData:{code:o.invalid_return_type,returnTypeError:n}})}const a={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Te){const e=this;return y((async function(...t){const s=new l([]),o=await e._def.args.parseAsync(t,a).catch((e=>{throw s.addIssue(n(t,e)),s})),c=await Reflect.apply(i,this,o);return await e._def.returns._def.type.parseAsync(c,a).catch((e=>{throw s.addIssue(r(c,e)),s}))}))}{const e=this;return y((function(...t){const s=e._def.args.safeParse(t,a);if(!s.success)throw new l([n(t,s.error)]);const o=Reflect.apply(i,this,s.data),c=e._def.returns.safeParse(o,a);if(!c.success)throw new l([r(o,c.error)]);return c.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Oe({...this._def,args:_e.create(e).rest(le.create())})}returns(e){return new Oe({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Oe({args:e||_e.create([]).rest(le.create()),returns:t||le.create(),typeName:Be.ZodFunction,...T(n)})}}class Ee extends P{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ee.create=(e,t)=>new Ee({getter:e,typeName:Be.ZodLazy,...T(t)});class xe extends P{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return p(t,{received:t.data,code:o.invalid_literal,expected:this._def.value}),m}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Ae(e,t){return new Se({values:e,typeName:Be.ZodEnum,...T(t)})}xe.create=(e,t)=>new xe({value:e,typeName:Be.ZodLiteral,...T(t)});class Se extends P{constructor(){super(...arguments),x.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return p(t,{expected:r.joinValues(n),received:t.parsedType,code:o.invalid_type}),m}if(k(this,x,"f")||O(this,x,new Set(this._def.values),"f"),!k(this,x,"f").has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return p(t,{received:t.data,code:o.invalid_enum_value,options:n}),m}return y(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Se.create(e,{...this._def,...t})}exclude(e,t=this._def){return Se.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}x=new WeakMap,Se.create=Ae;class Ie extends P{constructor(){super(...arguments),A.set(this,void 0)}_parse(e){const t=r.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==s.string&&n.parsedType!==s.number){const e=r.objectValues(t);return p(n,{expected:r.joinValues(e),received:n.parsedType,code:o.invalid_type}),m}if(k(this,A,"f")||O(this,A,new Set(r.getValidEnumValues(this._def.values)),"f"),!k(this,A,"f").has(e.data)){const e=r.objectValues(t);return p(n,{received:n.data,code:o.invalid_enum_value,options:e}),m}return y(e.data)}get enum(){return this._def.values}}A=new WeakMap,Ie.create=(e,t)=>new Ie({values:e,typeName:Be.ZodNativeEnum,...T(t)});class Te extends P{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==s.promise&&!1===t.common.async)return p(t,{code:o.invalid_type,expected:s.promise,received:t.parsedType}),m;const n=t.parsedType===s.promise?t.data:Promise.resolve(t.data);return y(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}Te.create=(e,t)=>new Te({type:e,typeName:Be.ZodPromise,...T(t)});class Pe extends P{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Be.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:e=>{p(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===a.type){const e=a.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return m;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?m:"dirty"===r.status||"dirty"===t.value?g(r.value):r}));{if("aborted"===t.value)return m;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?m:"dirty"===r.status||"dirty"===t.value?g(r.value):r}}if("refinement"===a.type){const e=e=>{const t=a.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?m:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?m:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===a.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!w(e))return e;const r=a.transform(e.value,s);if(r instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:r}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>w(e)?Promise.resolve(a.transform(e.value,s)).then((e=>({status:t.value,value:e}))):e))}r.assertNever(a)}}Pe.create=(e,t,n)=>new Pe({schema:e,typeName:Be.ZodEffects,effect:t,...T(n)}),Pe.createWithPreprocess=(e,t,n)=>new Pe({schema:t,effect:{type:"preprocess",transform:e},typeName:Be.ZodEffects,...T(n)});class Ce extends P{_parse(e){return this._getType(e)===s.undefined?y(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ce.create=(e,t)=>new Ce({innerType:e,typeName:Be.ZodOptional,...T(t)});class Re extends P{_parse(e){return this._getType(e)===s.null?y(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Re.create=(e,t)=>new Re({innerType:e,typeName:Be.ZodNullable,...T(t)});class Ne extends P{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===s.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Ne.create=(e,t)=>new Ne({innerType:e,typeName:Be.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...T(t)});class je extends P{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return v(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new l(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new l(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}je.create=(e,t)=>new je({innerType:e,typeName:Be.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...T(t)});class $e extends P{_parse(e){if(this._getType(e)!==s.nan){const t=this._getOrReturnCtx(e);return p(t,{code:o.invalid_type,expected:s.nan,received:t.parsedType}),m}return{status:"valid",value:e.data}}}$e.create=e=>new $e({typeName:Be.ZodNaN,...T(e)});const Me=Symbol("zod_brand");class Le extends P{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class De extends P{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),g(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new De({in:e,out:t,typeName:Be.ZodPipeline})}}class Ue extends P{_parse(e){const t=this._def.innerType._parse(e),n=e=>(w(e)&&(e.value=Object.freeze(e.value)),e);return v(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function Fe(e,t={},n){return e?oe.create().superRefine(((r,a)=>{var s,i;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(i=null!==(s=e.fatal)&&void 0!==s?s:n)||void 0===i||i,l="string"==typeof e?{message:e}:e;a.addIssue({code:"custom",...l,fatal:o})}})):oe.create()}Ue.create=(e,t)=>new Ue({innerType:e,typeName:Be.ZodReadonly,...T(t)});const ze={object:pe.lazycreate};var Be;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Be||(Be={}));const Ze=X.create,He=ee.create,qe=$e.create,Ge=te.create,Ye=ne.create,Ke=re.create,Ve=ae.create,Je=se.create,We=ie.create,Xe=oe.create,Qe=le.create,et=ce.create,tt=ue.create,nt=de.create,rt=pe.create,at=pe.strictCreate,st=fe.create,it=ge.create,ot=be.create,lt=_e.create,ct=we.create,ut=ve.create,dt=ke.create,ht=Oe.create,pt=Ee.create,ft=xe.create,mt=Se.create,gt=Ie.create,yt=Te.create,bt=Pe.create,_t=Ce.create,wt=Re.create,vt=Pe.createWithPreprocess,kt=De.create,Ot={string:e=>X.create({...e,coerce:!0}),number:e=>ee.create({...e,coerce:!0}),boolean:e=>ne.create({...e,coerce:!0}),bigint:e=>te.create({...e,coerce:!0}),date:e=>re.create({...e,coerce:!0})},Et=m;var xt=Object.freeze({__proto__:null,defaultErrorMap:c,setErrorMap:function(e){u=e},getErrorMap:d,makeIssue:h,EMPTY_PATH:[],addIssueToContext:p,ParseStatus:f,INVALID:m,DIRTY:g,OK:y,isAborted:b,isDirty:_,isValid:w,isAsync:v,get util(){return r},get objectUtil(){return a},ZodParsedType:s,getParsedType:i,ZodType:P,datetimeRegex:V,ZodString:X,ZodNumber:ee,ZodBigInt:te,ZodBoolean:ne,ZodDate:re,ZodSymbol:ae,ZodUndefined:se,ZodNull:ie,ZodAny:oe,ZodUnknown:le,ZodNever:ce,ZodVoid:ue,ZodArray:de,ZodObject:pe,ZodUnion:fe,ZodDiscriminatedUnion:ge,ZodIntersection:be,ZodTuple:_e,ZodRecord:we,ZodMap:ve,ZodSet:ke,ZodFunction:Oe,ZodLazy:Ee,ZodLiteral:xe,ZodEnum:Se,ZodNativeEnum:Ie,ZodPromise:Te,ZodEffects:Pe,ZodTransformer:Pe,ZodOptional:Ce,ZodNullable:Re,ZodDefault:Ne,ZodCatch:je,ZodNaN:$e,BRAND:Me,ZodBranded:Le,ZodPipeline:De,ZodReadonly:Ue,custom:Fe,Schema:P,ZodSchema:P,late:ze,get ZodFirstPartyTypeKind(){return Be},coerce:Ot,any:Xe,array:nt,bigint:Ge,boolean:Ye,date:Ke,discriminatedUnion:it,effect:bt,enum:mt,function:ht,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Fe((t=>t instanceof e),t),intersection:ot,lazy:pt,literal:ft,map:ut,nan:qe,nativeEnum:gt,never:et,null:We,nullable:wt,number:He,object:rt,oboolean:()=>Ye().optional(),onumber:()=>He().optional(),optional:_t,ostring:()=>Ze().optional(),pipeline:kt,preprocess:vt,promise:yt,record:ct,set:dt,strictObject:at,string:Ze,symbol:Ve,transformer:bt,tuple:lt,undefined:Je,union:st,unknown:Qe,void:tt,NEVER:Et,ZodIssueCode:o,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:l})}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={id:r,loaded:!1,exports:{}};return e[r](s,s.exports,n),s.loaded=!0,s.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{"use strict";let e={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};function t(t){e=t}const r={exec:()=>null};function a(e,t=""){let n="string"==typeof e?e:e.source;const r={replace:(e,t)=>{let a="string"==typeof t?t:t.source;return a=a.replace(s.caret,"$1"),n=n.replace(e,a),r},getRegex:()=>new RegExp(n,t)};return r}const s={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:e=>new RegExp(`^( {0,3}${e})((?:[\t ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),hrRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}#`),htmlBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}<(?:[a-z].*>|!--)`,"i")},i=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,o=/(?:[*+-]|\d{1,9}[.)])/,l=a(/^(?!bull |blockCode|fences|blockquote|heading|html)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html))+?)\n {0,3}(=+|-+) *(?:\n+|$)/).replace(/bull/g,o).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).getRegex(),c=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,u=/(?!\s*\])(?:\\.|[^\[\]\\])+/,d=a(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",u).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),h=a(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,o).getRegex(),p="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",f=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,m=a("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$))","i").replace("comment",f).replace("tag",p).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),g=a(c).replace("hr",i).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",p).getRegex(),y={blockquote:a(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",g).getRegex(),code:/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,def:d,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:i,html:m,lheading:l,list:h,newline:/^(?:[ \t]*(?:\n|$))+/,paragraph:g,table:r,text:/^[^\n]+/},b=a("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",i).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}\t)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",p).getRegex(),_={...y,table:b,paragraph:a(c).replace("hr",i).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",b).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",p).getRegex()},w={...y,html:a("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",f).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:r,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:a(c).replace("hr",i).replace("heading"," *#{1,6} *[^\n]").replace("lheading",l).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},v=/^( {2,}|\\)\n(?!\s*$)/,k=/[\p{P}\p{S}]/u,O=/[\s\p{P}\p{S}]/u,E=/[^\s\p{P}\p{S}]/u,x=a(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,O).getRegex(),A=a(/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,"u").replace(/punct/g,k).getRegex(),S="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",I=a(S,"gu").replace(/notPunctSpace/g,E).replace(/punctSpace/g,O).replace(/punct/g,k).getRegex(),T=a(S,"gu").replace(/notPunctSpace/g,/(?:[^\s\p{P}\p{S}]|~)/u).replace(/punctSpace/g,/(?!~)[\s\p{P}\p{S}]/u).replace(/punct/g,/(?!~)[\p{P}\p{S}]/u).getRegex(),P=a("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,E).replace(/punctSpace/g,O).replace(/punct/g,k).getRegex(),C=a(/\\(punct)/,"gu").replace(/punct/g,k).getRegex(),R=a(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),N=a(f).replace("(?:--\x3e|$)","--\x3e").getRegex(),j=a("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",N).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),$=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,M=a(/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/).replace("label",$).replace("href",/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),L=a(/^!?\[(label)\]\[(ref)\]/).replace("label",$).replace("ref",u).getRegex(),D=a(/^!?\[(ref)\](?:\[\])?/).replace("ref",u).getRegex(),U={_backpedal:r,anyPunctuation:C,autolink:R,blockSkip:/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,br:v,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:r,emStrongLDelim:A,emStrongRDelimAst:I,emStrongRDelimUnd:P,escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,link:M,nolink:D,punctuation:x,reflink:L,reflinkSearch:a("reflink|nolink(?!\\()","g").replace("reflink",L).replace("nolink",D).getRegex(),tag:j,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:r},F={...U,link:a(/^!?\[(label)\]\((.*?)\)/).replace("label",$).getRegex(),reflink:a(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",$).getRegex()},z={...U,emStrongRDelimAst:T,url:a(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},B={...z,br:a(v).replace("{2,}","*").getRegex(),text:a(z.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},Z={normal:y,gfm:_,pedantic:w},H={normal:U,gfm:z,breaks:B,pedantic:F},q={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},G=e=>q[e];function Y(e,t){if(t){if(s.escapeTest.test(e))return e.replace(s.escapeReplace,G)}else if(s.escapeTestNoEncode.test(e))return e.replace(s.escapeReplaceNoEncode,G);return e}function K(e){try{e=encodeURI(e).replace(s.percentDecode,"%")}catch{return null}return e}function V(e,t){const n=e.replace(s.findPipe,((e,t,n)=>{let r=!1,a=t;for(;--a>=0&&"\\"===n[a];)r=!r;return r?"|":" |"})),r=n.split(s.splitPipe);let a=0;if(r[0].trim()||r.shift(),r.length>0&&!r.at(-1)?.trim()&&r.pop(),t)if(r.length>t)r.splice(t);else for(;r.length<t;)r.push("");for(;a<r.length;a++)r[a]=r[a].trim().replace(s.slashPipe,"|");return r}function J(e,t,n){const r=e.length;if(0===r)return"";let a=0;for(;a<r&&(e.charAt(r-a-1)===t&&!n);)a++;return e.slice(0,r-a)}function W(e,t,n,r,a){const s=t.href,i=t.title||null,o=e[1].replace(a.other.outputLinkReplace,"$1");if("!"!==e[0].charAt(0)){r.state.inLink=!0;const e={type:"link",raw:n,href:s,title:i,text:o,tokens:r.inlineTokens(o)};return r.state.inLink=!1,e}return{type:"image",raw:n,href:s,title:i,text:o}}class X{options;rules;lexer;constructor(t){this.options=t||e}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:J(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t,n){const r=e.match(n.other.indentCodeCompensation);if(null===r)return t;const a=r[1];return t.split("\n").map((e=>{const t=e.match(n.other.beginningSpace);if(null===t)return e;const[r]=t;return r.length>=a.length?e.slice(a.length):e})).join("\n")}(e,t[3]||"",this.rules);return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(this.rules.other.endingHash.test(e)){const t=J(e,"#");this.options.pedantic?e=t.trim():t&&!this.rules.other.endingSpaceChar.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:J(t[0],"\n")}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){let e=J(t[0],"\n").split("\n"),n="",r="";const a=[];for(;e.length>0;){let t=!1;const s=[];let i;for(i=0;i<e.length;i++)if(this.rules.other.blockquoteStart.test(e[i]))s.push(e[i]),t=!0;else{if(t)break;s.push(e[i])}e=e.slice(i);const o=s.join("\n"),l=o.replace(this.rules.other.blockquoteSetextReplace,"\n    $1").replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}\n${o}`:o,r=r?`${r}\n${l}`:l;const c=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(l,a,!0),this.lexer.state.top=c,0===e.length)break;const u=a.at(-1);if("code"===u?.type)break;if("blockquote"===u?.type){const t=u,s=t.raw+"\n"+e.join("\n"),i=this.blockquote(s);a[a.length-1]=i,n=n.substring(0,n.length-t.raw.length)+i.raw,r=r.substring(0,r.length-t.text.length)+i.text;break}if("list"!==u?.type);else{const t=u,s=t.raw+"\n"+e.join("\n"),i=this.list(s);a[a.length-1]=i,n=n.substring(0,n.length-u.raw.length)+i.raw,r=r.substring(0,r.length-t.raw.length)+i.raw,e=s.substring(a.at(-1).raw.length).split("\n")}}return{type:"blockquote",raw:n,tokens:a,text:r}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const r=n.length>1,a={type:"list",raw:"",ordered:r,start:r?+n.slice(0,-1):"",loose:!1,items:[]};n=r?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=r?n:"[*+-]");const s=this.rules.other.listItemRegex(n);let i=!1;for(;e;){let n=!1,r="",o="";if(!(t=s.exec(e)))break;if(this.rules.block.hr.test(e))break;r=t[0],e=e.substring(r.length);let l=t[2].split("\n",1)[0].replace(this.rules.other.listReplaceTabs,(e=>" ".repeat(3*e.length))),c=e.split("\n",1)[0],u=!l.trim(),d=0;if(this.options.pedantic?(d=2,o=l.trimStart()):u?d=t[1].length+1:(d=t[2].search(this.rules.other.nonSpaceChar),d=d>4?1:d,o=l.slice(d),d+=t[1].length),u&&this.rules.other.blankLine.test(c)&&(r+=c+"\n",e=e.substring(c.length+1),n=!0),!n){const t=this.rules.other.nextBulletRegex(d),n=this.rules.other.hrRegex(d),a=this.rules.other.fencesBeginRegex(d),s=this.rules.other.headingBeginRegex(d),i=this.rules.other.htmlBeginRegex(d);for(;e;){const h=e.split("\n",1)[0];let p;if(c=h,this.options.pedantic?(c=c.replace(this.rules.other.listReplaceNesting,"  "),p=c):p=c.replace(this.rules.other.tabCharGlobal,"    "),a.test(c))break;if(s.test(c))break;if(i.test(c))break;if(t.test(c))break;if(n.test(c))break;if(p.search(this.rules.other.nonSpaceChar)>=d||!c.trim())o+="\n"+p.slice(d);else{if(u)break;if(l.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4)break;if(a.test(l))break;if(s.test(l))break;if(n.test(l))break;o+="\n"+c}u||c.trim()||(u=!0),r+=h+"\n",e=e.substring(h.length+1),l=p.slice(d)}}a.loose||(i?a.loose=!0:this.rules.other.doubleBlankLine.test(r)&&(i=!0));let h,p=null;this.options.gfm&&(p=this.rules.other.listIsTask.exec(o),p&&(h="[ ] "!==p[0],o=o.replace(this.rules.other.listReplaceTask,""))),a.items.push({type:"list_item",raw:r,task:!!p,checked:h,loose:!1,text:o,tokens:[]}),a.raw+=r}const o=a.items.at(-1);if(!o)return;o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd(),a.raw=a.raw.trimEnd();for(let e=0;e<a.items.length;e++)if(this.lexer.state.top=!1,a.items[e].tokens=this.lexer.blockTokens(a.items[e].text,[]),!a.loose){const t=a.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>this.rules.other.anyLine.test(e.raw)));a.loose=n}if(a.loose)for(let e=0;e<a.items.length;e++)a.items[e].loose=!0;return a}}html(e){const t=this.rules.block.html.exec(e);if(t)return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:r}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!this.rules.other.tableDelimiter.test(t[2]))return;const n=V(t[1]),r=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),a=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split("\n"):[],s={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===r.length){for(const e of r)this.rules.other.tableAlignRight.test(e)?s.align.push("right"):this.rules.other.tableAlignCenter.test(e)?s.align.push("center"):this.rules.other.tableAlignLeft.test(e)?s.align.push("left"):s.align.push(null);for(let e=0;e<n.length;e++)s.header.push({text:n[e],tokens:this.lexer.inline(n[e]),header:!0,align:s.align[e]});for(const e of a)s.rows.push(V(e,s.header.length).map(((e,t)=>({text:e,tokens:this.lexer.inline(e),header:!1,align:s.align[t]}))));return s}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(e)){if(!this.rules.other.endAngleBracket.test(e))return;const t=J(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let r=0;r<e.length;r++)if("\\"===e[r])r++;else if(e[r]===t[0])n++;else if(e[r]===t[1]&&(n--,n<0))return r;return-1}(t[2],"()");if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],r="";if(this.options.pedantic){const e=this.rules.other.pedanticHrefTitle.exec(n);e&&(n=e[1],r=e[3])}else r=t[3]?t[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(n=this.options.pedantic&&!this.rules.other.endAngleBracket.test(e)?n.slice(1):n.slice(1,-1)),W(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:r?r.replace(this.rules.inline.anyPunctuation,"$1"):r},t[0],this.lexer,this.rules)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(this.rules.other.multipleSpaceGlobal," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return W(n,e,n[0],this.lexer,this.rules)}}emStrong(e,t,n=""){let r=this.rules.inline.emStrongLDelim.exec(e);if(r&&(!r[3]||!n.match(this.rules.other.unicodeAlphaNumeric))&&(!r[1]&&!r[2]||!n||this.rules.inline.punctuation.exec(n))){const n=[...r[0]].length-1;let a,s,i=n,o=0;const l="*"===r[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(l.lastIndex=0,t=t.slice(-1*e.length+n);null!=(r=l.exec(t));){if(a=r[1]||r[2]||r[3]||r[4]||r[5]||r[6],!a)continue;if(s=[...a].length,r[3]||r[4]){i+=s;continue}if((r[5]||r[6])&&n%3&&!((n+s)%3)){o+=s;continue}if(i-=s,i>0)continue;s=Math.min(s,s+i+o);const t=[...r[0]][0].length,l=e.slice(0,n+r.index+t+s);if(Math.min(n,s)%2){const e=l.slice(1,-1);return{type:"em",raw:l,text:e,tokens:this.lexer.inlineTokens(e)}}const c=l.slice(2,-2);return{type:"strong",raw:l,text:c,tokens:this.lexer.inlineTokens(c)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(this.rules.other.newLineCharGlobal," ");const n=this.rules.other.nonSpaceChar.test(e),r=this.rules.other.startingSpaceChar.test(e)&&this.rules.other.endingSpaceChar.test(e);return n&&r&&(e=e.substring(1,e.length-1)),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=t[1],n="mailto:"+e):(e=t[1],n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=t[0],n="mailto:"+e;else{let r;do{r=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(r!==t[0]);e=t[0],n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){const e=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:e}}}}class Q{tokens;options;state;tokenizer;inlineQueue;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||e,this.options.tokenizer=this.options.tokenizer||new X,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const n={other:s,block:Z.normal,inline:H.normal};this.options.pedantic?(n.block=Z.pedantic,n.inline=H.pedantic):this.options.gfm&&(n.block=Z.gfm,this.options.breaks?n.inline=H.breaks:n.inline=H.gfm),this.tokenizer.rules=n}static get rules(){return{block:Z,inline:H}}static lex(e,t){return new Q(t).lex(e)}static lexInline(e,t){return new Q(t).inlineTokens(e)}lex(e){e=e.replace(s.carriageReturn,"\n"),this.blockTokens(e,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(s.tabCharGlobal,"    ").replace(s.spaceLine,""));e;){let r;if(this.options.extensions?.block?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);const n=t.at(-1);1===r.raw.length&&void 0!==n?n.raw+="\n":t.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.at(-1).src=n.text):t.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.raw,this.inlineQueue.at(-1).src=n.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title});continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),t.push(r);continue}let a=e;if(this.options.extensions?.startBlock){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startBlock.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(a=e.substring(0,t+1))}if(this.state.top&&(r=this.tokenizer.paragraph(a))){const s=t.at(-1);n&&"paragraph"===s?.type?(s.raw+="\n"+r.raw,s.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=s.text):t.push(r),n=a.length!==e.length,e=e.substring(r.raw.length)}else if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=n.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,r=null;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(r=this.tokenizer.rules.inline.reflinkSearch.exec(n));)e.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(r=this.tokenizer.rules.inline.blockSkip.exec(n));)n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;null!=(r=this.tokenizer.rules.inline.anyPunctuation.exec(n));)n=n.slice(0,r.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let a=!1,s="";for(;e;){let r;if(a||(s=""),a=!1,this.options.extensions?.inline?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.escape(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.tag(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.link(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===r.type&&"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r);continue}if(r=this.tokenizer.emStrong(e,n,s)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.codespan(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.br(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.del(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.autolink(e)){e=e.substring(r.raw.length),t.push(r);continue}if(!this.state.inLink&&(r=this.tokenizer.url(e))){e=e.substring(r.raw.length),t.push(r);continue}let i=e;if(this.options.extensions?.startInline){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startInline.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(i=e.substring(0,t+1))}if(r=this.tokenizer.inlineText(i)){e=e.substring(r.raw.length),"_"!==r.raw.slice(-1)&&(s=r.raw.slice(-1)),a=!0;const n=t.at(-1);"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return t}}class ee{options;parser;constructor(t){this.options=t||e}space(e){return""}code({text:e,lang:t,escaped:n}){const r=(t||"").match(s.notSpaceStart)?.[0],a=e.replace(s.endingNewline,"")+"\n";return r?'<pre><code class="language-'+Y(r)+'">'+(n?a:Y(a,!0))+"</code></pre>\n":"<pre><code>"+(n?a:Y(a,!0))+"</code></pre>\n"}blockquote({tokens:e}){return`<blockquote>\n${this.parser.parse(e)}</blockquote>\n`}html({text:e}){return e}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>\n`}hr(e){return"<hr>\n"}list(e){const t=e.ordered,n=e.start;let r="";for(let t=0;t<e.items.length;t++){const n=e.items[t];r+=this.listitem(n)}const a=t?"ol":"ul";return"<"+a+(t&&1!==n?' start="'+n+'"':"")+">\n"+r+"</"+a+">\n"}listitem(e){let t="";if(e.task){const n=this.checkbox({checked:!!e.checked});e.loose?"paragraph"===e.tokens[0]?.type?(e.tokens[0].text=n+" "+e.tokens[0].text,e.tokens[0].tokens&&e.tokens[0].tokens.length>0&&"text"===e.tokens[0].tokens[0].type&&(e.tokens[0].tokens[0].text=n+" "+Y(e.tokens[0].tokens[0].text),e.tokens[0].tokens[0].escaped=!0)):e.tokens.unshift({type:"text",raw:n+" ",text:n+" ",escaped:!0}):t+=n+" "}return t+=this.parser.parse(e.tokens,!!e.loose),`<li>${t}</li>\n`}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>\n`}table(e){let t="",n="";for(let t=0;t<e.header.length;t++)n+=this.tablecell(e.header[t]);t+=this.tablerow({text:n});let r="";for(let t=0;t<e.rows.length;t++){const a=e.rows[t];n="";for(let e=0;e<a.length;e++)n+=this.tablecell(a[e]);r+=this.tablerow({text:n})}return r&&(r=`<tbody>${r}</tbody>`),"<table>\n<thead>\n"+t+"</thead>\n"+r+"</table>\n"}tablerow({text:e}){return`<tr>\n${e}</tr>\n`}tablecell(e){const t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>\n`}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${Y(e,!0)}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){const r=this.parser.parseInline(n),a=K(e);if(null===a)return r;let s='<a href="'+(e=a)+'"';return t&&(s+=' title="'+Y(t)+'"'),s+=">"+r+"</a>",s}image({href:e,title:t,text:n}){const r=K(e);if(null===r)return Y(n);let a=`<img src="${e=r}" alt="${n}"`;return t&&(a+=` title="${Y(t)}"`),a+=">",a}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):"escaped"in e&&e.escaped?e.text:Y(e.text)}}class te{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}}class ne{options;renderer;textRenderer;constructor(t){this.options=t||e,this.options.renderer=this.options.renderer||new ee,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new te}static parse(e,t){return new ne(t).parse(e)}static parseInline(e,t){return new ne(t).parseInline(e)}parse(e,t=!0){let n="";for(let r=0;r<e.length;r++){const a=e[r];if(this.options.extensions?.renderers?.[a.type]){const e=a,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}const s=a;switch(s.type){case"space":n+=this.renderer.space(s);continue;case"hr":n+=this.renderer.hr(s);continue;case"heading":n+=this.renderer.heading(s);continue;case"code":n+=this.renderer.code(s);continue;case"table":n+=this.renderer.table(s);continue;case"blockquote":n+=this.renderer.blockquote(s);continue;case"list":n+=this.renderer.list(s);continue;case"html":n+=this.renderer.html(s);continue;case"paragraph":n+=this.renderer.paragraph(s);continue;case"text":{let a=s,i=this.renderer.text(a);for(;r+1<e.length&&"text"===e[r+1].type;)a=e[++r],i+="\n"+this.renderer.text(a);n+=t?this.renderer.paragraph({type:"paragraph",raw:i,text:i,tokens:[{type:"text",raw:i,text:i,escaped:!0}]}):i;continue}default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}parseInline(e,t=this.renderer){let n="";for(let r=0;r<e.length;r++){const a=e[r];if(this.options.extensions?.renderers?.[a.type]){const e=this.options.extensions.renderers[a.type].call({parser:this},a);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){n+=e||"";continue}}const s=a;switch(s.type){case"escape":case"text":n+=t.text(s);break;case"html":n+=t.html(s);break;case"link":n+=t.link(s);break;case"image":n+=t.image(s);break;case"strong":n+=t.strong(s);break;case"em":n+=t.em(s);break;case"codespan":n+=t.codespan(s);break;case"br":n+=t.br(s);break;case"del":n+=t.del(s);break;default:{const e='Token with "'+s.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}}class re{options;block;constructor(t){this.options=t||e}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}provideLexer(){return this.block?Q.lex:Q.lexInline}provideParser(){return this.block?ne.parse:ne.parseInline}}const ae=new class{defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=ne;Renderer=ee;TextRenderer=te;Lexer=Q;Tokenizer=X;Hooks=re;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(const r of e)switch(n=n.concat(t.call(this,r)),r.type){case"table":{const e=r;for(const r of e.header)n=n.concat(this.walkTokens(r.tokens,t));for(const r of e.rows)for(const e of r)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=r;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=r;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((r=>{const a=e[r].flat(1/0);n=n.concat(this.walkTokens(a,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let r=e.renderer.apply(this,t);return!1===r&&(r=n.apply(this,t)),r}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new ee(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;const r=n,a=e.renderer[r],s=t[r];t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new X(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const r=n,a=e.tokenizer[r],s=t[r];t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new re;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;const r=n,a=e.hooks[r],s=t[r];re.passThroughHooks.has(n)?t[r]=e=>{if(this.defaults.async)return Promise.resolve(a.call(t,e)).then((e=>s.call(t,e)));const n=a.call(t,e);return s.call(t,n)}:t[r]=(...e)=>{let n=a.apply(t,e);return!1===n&&(n=s.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,r=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(r.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return Q.lex(e,t??this.defaults)}parser(e,t){return ne.parse(e,t??this.defaults)}parseMarkdown(e){return(t,n)=>{const r={...n},a={...this.defaults,...r},s=this.onError(!!a.silent,!!a.async);if(!0===this.defaults.async&&!1===r.async)return s(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==t)return s(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof t)return s(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));a.hooks&&(a.hooks.options=a,a.hooks.block=e);const i=a.hooks?a.hooks.provideLexer():e?Q.lex:Q.lexInline,o=a.hooks?a.hooks.provideParser():e?ne.parse:ne.parseInline;if(a.async)return Promise.resolve(a.hooks?a.hooks.preprocess(t):t).then((e=>i(e,a))).then((e=>a.hooks?a.hooks.processAllTokens(e):e)).then((e=>a.walkTokens?Promise.all(this.walkTokens(e,a.walkTokens)).then((()=>e)):e)).then((e=>o(e,a))).then((e=>a.hooks?a.hooks.postprocess(e):e)).catch(s);try{a.hooks&&(t=a.hooks.preprocess(t));let e=i(t,a);a.hooks&&(e=a.hooks.processAllTokens(e)),a.walkTokens&&this.walkTokens(e,a.walkTokens);let n=o(e,a);return a.hooks&&(n=a.hooks.postprocess(n)),n}catch(e){return s(e)}}}onError(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+Y(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}}};function se(e,t){return ae.parse(e,t)}var ie,oe,le;se.options=se.setOptions=function(e){return ae.setOptions(e),se.defaults=ae.defaults,t(se.defaults),se},se.getDefaults=function(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}},se.defaults=e,se.use=function(...e){return ae.use(...e),se.defaults=ae.defaults,t(se.defaults),se},se.walkTokens=function(e,t){return ae.walkTokens(e,t)},se.parseInline=ae.parseInline,se.Parser=ne,se.parser=ne.parse,se.Renderer=ee,se.TextRenderer=te,se.Lexer=Q,se.lexer=Q.lex,se.Tokenizer=X,se.Hooks=re,se.parse=se,se.options,se.setOptions,se.use,se.walkTokens,se.parseInline,ne.parse,Q.lex,function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"}(ie||(ie={})),function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"}(oe||(oe={})),function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"}(le||(le={}));const ce=["user","model","function","system"];var ue,de,he,pe,fe,me,ge,ye;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"}(ue||(ue={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(de||(de={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(he||(he={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(pe||(pe={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.OTHER="OTHER"}(fe||(fe={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(me||(me={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(ge||(ge={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"}(ye||(ye={}));class be extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class _e extends be{constructor(e,t){super(e),this.response=t}}class we extends be{constructor(e,t,n,r){super(e),this.status=t,this.statusText=n,this.errorDetails=r}}class ve extends be{}const ke="0.21.0",Oe="genai-js";var Ee;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(Ee||(Ee={}));class xe{constructor(e,t,n,r,a){this.model=e,this.task=t,this.apiKey=n,this.stream=r,this.requestOptions=a}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let r=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}async function Ae(e){var t;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push(`${Oe}/${ke}`),t.join(" ")}(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let r=null===(t=e.requestOptions)||void 0===t?void 0:t.customHeaders;if(r){if(!(r instanceof Headers))try{r=new Headers(r)}catch(e){throw new ve(`unable to convert customHeaders value ${JSON.stringify(r)} to Headers: ${e.message}`)}for(const[e,t]of r.entries()){if("x-goog-api-key"===e)throw new ve(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new ve(`Header name ${e} can only be set using the apiClient field`);n.append(e,t)}}return n}async function Se(e,t,n,r,a,s={},i=fetch){const{url:o,fetchOptions:l}=await async function(e,t,n,r,a,s){const i=new xe(e,t,n,r,s);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},Ie(s)),{method:"POST",headers:await Ae(i),body:a})}}(e,t,n,r,a,s);return async function(e,t,n=fetch){let r;try{r=await n(e,t)}catch(t){!function(e,t){let n=e;throw e instanceof we||e instanceof ve||(n=new be(`Error fetching from ${t.toString()}: ${e.message}`),n.stack=e.stack),n}(t,e)}return r.ok||await async function(e,t){let n,r="";try{const t=await e.json();r=t.error.message,t.error.details&&(r+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new we(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${r}`,e.status,e.statusText,n)}(r,e),r}(o,l,i)}function Ie(e){const t={};if(void 0!==(null==e?void 0:e.signal)||(null==e?void 0:e.timeout)>=0){const n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout((()=>n.abort()),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",(()=>{n.abort()})),t.signal=n.signal}return t}function Te(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Re(e.candidates[0]))throw new _e(`${Ne(e)}`,e);return function(e){var t,n,r,a;const s=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===a?void 0:a.parts)t.text&&s.push(t.text),t.executableCode&&s.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&s.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return s.length>0?s.join(""):""}(e)}if(e.promptFeedback)throw new _e(`Text not available. ${Ne(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Re(e.candidates[0]))throw new _e(`${Ne(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),Pe(e)[0]}if(e.promptFeedback)throw new _e(`Function call not available. ${Ne(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),Re(e.candidates[0]))throw new _e(`${Ne(e)}`,e);return Pe(e)}if(e.promptFeedback)throw new _e(`Function call not available. ${Ne(e)}`,e)},e}function Pe(e){var t,n,r,a;const s=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===a?void 0:a.parts)t.functionCall&&s.push(t.functionCall);return s.length>0?s:void 0}const Ce=[fe.RECITATION,fe.SAFETY,fe.LANGUAGE];function Re(e){return!!e.finishReason&&Ce.includes(e.finishReason)}function Ne(e){var t,n,r;let a="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(r=e.candidates)||void 0===r?void 0:r[0]){const t=e.candidates[0];Re(t)&&(a+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(a+=`: ${t.finishMessage}`))}}else a+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(a+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(a+=`: ${e.promptFeedback.blockReasonMessage}`);return a}function je(e){return this instanceof je?(this.v=e,this):new je(e)}"function"==typeof SuppressedError&&SuppressedError;const $e=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function Me(e){const t=[],n=e.getReader();for(;;){const{done:e,value:r}=await n.read();if(e)return Te(De(t));t.push(r)}}function Le(e){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,a=n.apply(e,t||[]),s=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){a[e]&&(r[e]=function(t){return new Promise((function(n,r){s.push([e,t,n,r])>1||o(e,t)}))})}function o(e,t){try{(n=a[e](t)).value instanceof je?Promise.resolve(n.value.v).then(l,c):u(s[0][2],n)}catch(e){u(s[0][3],e)}var n}function l(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),s.shift(),s.length&&o(s[0][0],s[0][1])}}(this,arguments,(function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield je(t.read());if(n)break;yield yield je(Te(e))}}))}function De(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e){if(t.candidates)for(const e of t.candidates){const t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].groundingMetadata=e.groundingMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});const r={};for(const a of e.content.parts)a.text&&(r.text=a.text),a.functionCall&&(r.functionCall=a.functionCall),a.executableCode&&(r.executableCode=a.executableCode),a.codeExecutionResult&&(r.codeExecutionResult=a.codeExecutionResult),0===Object.keys(r).length&&(r.text=""),n.candidates[t].content.parts.push(r)}}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}async function Ue(e,t,n,r){return function(e){const t=function(e){const t=e.getReader();return new ReadableStream({start(e){let n="";return function r(){return t.read().then((({value:t,done:a})=>{if(a)return n.trim()?void e.error(new be("Failed to parse stream")):void e.close();n+=t;let s,i=n.match($e);for(;i;){try{s=JSON.parse(i[1])}catch(t){return void e.error(new be(`Error parsing JSON response: "${i[1]}"`))}e.enqueue(s),n=n.substring(i[0].length),i=n.match($e)}return r()}))}()}})}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,r]=t.tee();return{stream:Le(n),response:Me(r)}}(await Se(t,Ee.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),r))}async function Fe(e,t,n,r){const a=await Se(t,Ee.GENERATE_CONTENT,e,!1,JSON.stringify(n),r);return{response:Te(await a.json())}}function ze(e){if(null!=e)return"string"==typeof e?{role:"system",parts:[{text:e}]}:e.text?{role:"system",parts:[e]}:e.parts?e.role?e:{role:"system",parts:e.parts}:void 0}function Be(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,a=!1;for(const s of e)"functionResponse"in s?(n.parts.push(s),a=!0):(t.parts.push(s),r=!0);if(r&&a)throw new be("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new be("No content is provided for sending chat message.");return r?t:n}(t)}function Ze(e){let t;return t=e.contents?e:{contents:[Be(e)]},e.systemInstruction&&(t.systemInstruction=ze(e.systemInstruction)),t}const He=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],qe={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]},Ge="SILENT_ERROR";class Ye{constructor(e,t,n,r={}){this.model=t,this.params=n,this._requestOptions=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(function(e){let t=!1;for(const n of e){const{role:e,parts:r}=n;if(!t&&"user"!==e)throw new be(`First content should be with role 'user', got ${e}`);if(!ce.includes(e))throw new be(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(ce)}`);if(!Array.isArray(r))throw new be("Content should have 'parts' property with an array of Parts");if(0===r.length)throw new be("Each Content should have at least one part");const a={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const e of r)for(const t of He)t in e&&(a[t]+=1);const s=qe[e];for(const t of He)if(!s.includes(t)&&a[t]>0)throw new be(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,r,a,s,i,o;await this._sendPromise;const l=Be(e),c={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(a=this.params)||void 0===a?void 0:a.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(o=this.params)||void 0===o?void 0:o.cachedContent,contents:[...this._history,l]},u=Object.assign(Object.assign({},this._requestOptions),t);let d;return this._sendPromise=this._sendPromise.then((()=>Fe(this._apiKey,this.model,c,u))).then((e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(l);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{const t=Ne(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}d=e})),await this._sendPromise,d}async sendMessageStream(e,t={}){var n,r,a,s,i,o;await this._sendPromise;const l=Be(e),c={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,tools:null===(a=this.params)||void 0===a?void 0:a.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(o=this.params)||void 0===o?void 0:o.cachedContent,contents:[...this._history,l]},u=Object.assign(Object.assign({},this._requestOptions),t),d=Ue(this._apiKey,this.model,c,u);return this._sendPromise=this._sendPromise.then((()=>d)).catch((e=>{throw new Error(Ge)})).then((e=>e.response)).then((e=>{if(e.candidates&&e.candidates.length>0){this._history.push(l);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=Ne(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}})).catch((e=>{e.message!==Ge&&console.error(e)})),d}}class Ke{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=ze(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;const r=Ze(e),a=Object.assign(Object.assign({},this._requestOptions),t);return Fe(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},r),a)}async generateContentStream(e,t={}){var n;const r=Ze(e),a=Object.assign(Object.assign({},this._requestOptions),t);return Ue(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},r),a)}startChat(e){var t;return new Ye(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(t=this.cachedContent)||void 0===t?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const n=function(e,t){var n;let r={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null===(n=null==t?void 0:t.cachedContent)||void 0===n?void 0:n.name,contents:[]};const a=null!=e.generateContentRequest;if(e.contents){if(a)throw new ve("CountTokensRequest must have one of contents or generateContentRequest, not both.");r.contents=e.contents}else if(a)r=Object.assign(Object.assign({},r),e.generateContentRequest);else{const t=Be(e);r.contents=[t]}return{generateContentRequest:r}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),r=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,r){return(await Se(t,Ee.COUNT_TOKENS,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,n,r)}async embedContent(e,t={}){const n="string"==typeof(a=e)||Array.isArray(a)?{content:Be(a)}:a,r=Object.assign(Object.assign({},this._requestOptions),t);var a;return async function(e,t,n,r){return(await Se(t,Ee.EMBED_CONTENT,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,n,r)}async batchEmbedContents(e,t={}){const n=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,r){const a=n.requests.map((e=>Object.assign(Object.assign({},e),{model:t})));return(await Se(t,Ee.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:a}),r)).json()}(this.apiKey,this.model,e,n)}}class Ve{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new be("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Ke(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new ve("Cached content must contain a `name` field.");if(!e.model)throw new ve("Cached content must contain a `model` field.");const r=["model","systemInstruction"];for(const n of r)if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new ve(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}const a=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new Ke(this.apiKey,a,n)}}var Je=n(9583),We=n(2522),Xe=n(1673),Qe=n(8028),et="object"==typeof window?window:{},tt="0123456789abcdef".split(""),nt=[-2147483648,8388608,32768,128],rt=[24,16,8,0],at=[];function st(e){e?(at[0]=at[16]=at[1]=at[2]=at[3]=at[4]=at[5]=at[6]=at[7]=at[8]=at[9]=at[10]=at[11]=at[12]=at[13]=at[14]=at[15]=0,this.blocks=at):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}st.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===et.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,a=0,s=e.length||0,i=this.blocks;a<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)for(r=this.start;a<s&&r<64;++a)i[r>>2]|=e[a]<<rt[3&r++];else for(r=this.start;a<s&&r<64;++a)(n=e.charCodeAt(a))<128?i[r>>2]|=n<<rt[3&r++]:n<2048?(i[r>>2]|=(192|n>>6)<<rt[3&r++],i[r>>2]|=(128|63&n)<<rt[3&r++]):n<55296||n>=57344?(i[r>>2]|=(224|n>>12)<<rt[3&r++],i[r>>2]|=(128|n>>6&63)<<rt[3&r++],i[r>>2]|=(128|63&n)<<rt[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++a)),i[r>>2]|=(240|n>>18)<<rt[3&r++],i[r>>2]|=(128|n>>12&63)<<rt[3&r++],i[r>>2]|=(128|n>>6&63)<<rt[3&r++],i[r>>2]|=(128|63&n)<<rt[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=i[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},st.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=nt[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},st.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,a=this.h2,s=this.h3,i=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r&a|~r&s)+i+1518500249+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|~n&a)+s+1518500249+o[e+1]|0)<<5|s>>>27)+(i&(n=n<<30|n>>>2)|~i&r)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|~s&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(a&(s=s<<30|s>>>2)|~a&i)+n+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r^a^s)+i+1859775393+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^a)+s+1859775393+o[e+1]|0)<<5|s>>>27)+(i^(n=n<<30|n>>>2)^r)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(a^(s=s<<30|s>>>2)^i)+n+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r&a|r&s|a&s)+i-1894007588+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|n&a|r&a)+s-1894007588+o[e+1]|0)<<5|s>>>27)+(i&(n=n<<30|n>>>2)|i&r|n&r)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|s&n|i&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(a&(s=s<<30|s>>>2)|a&i|s&i)+n-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)n=(t=(r=(t=(a=(t=(s=(t=(i=(t=n<<5|n>>>27)+(r^a^s)+i-899497514+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^a)+s-899497514+o[e+1]|0)<<5|s>>>27)+(i^(n=n<<30|n>>>2)^r)+a-899497514+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(a^(s=s<<30|s>>>2)^i)+n-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+a|0,this.h3=this.h3+s|0,this.h4=this.h4+i|0},st.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return tt[e>>28&15]+tt[e>>24&15]+tt[e>>20&15]+tt[e>>16&15]+tt[e>>12&15]+tt[e>>8&15]+tt[e>>4&15]+tt[15&e]+tt[t>>28&15]+tt[t>>24&15]+tt[t>>20&15]+tt[t>>16&15]+tt[t>>12&15]+tt[t>>8&15]+tt[t>>4&15]+tt[15&t]+tt[n>>28&15]+tt[n>>24&15]+tt[n>>20&15]+tt[n>>16&15]+tt[n>>12&15]+tt[n>>8&15]+tt[n>>4&15]+tt[15&n]+tt[r>>28&15]+tt[r>>24&15]+tt[r>>20&15]+tt[r>>16&15]+tt[r>>12&15]+tt[r>>8&15]+tt[r>>4&15]+tt[15&r]+tt[a>>28&15]+tt[a>>24&15]+tt[a>>20&15]+tt[a>>16&15]+tt[a>>12&15]+tt[a>>8&15]+tt[a>>4&15]+tt[15&a]},st.prototype.toString=st.prototype.hex,st.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a]},st.prototype.array=st.prototype.digest,st.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var it=n(6362);const ot=(...e)=>{return t=e.join("_"),new st(!0).update(t).hex();var t};class lt{}const ct=new Map;class ut extends lt{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(ot(e,t))??null)}async update(e,t,n){this.cache.set(ot(e,t),n)}static global(){return new ut(ct)}}var dt=n(5311),ht=n(9624),pt=n(7526),ft=Object.defineProperty;function mt(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let a=0;a<n.length-1;a++){const s=e.slice(n[a].start,n[a+1].end),i=t.get(s.join(","));null!=i&&(null==r||i<r[0])&&(r=[i,a])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var gt,yt,bt=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...a]=t.split(" "),s=Number.parseInt(r,10);return a.forEach(((t,n)=>e[t]=s+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=pt.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),a=bt.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!i.has(e))):n);if(o.size>0){const t=bt.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let l=0;for(;;){let t=null,n=l;for(;a.lastIndex=n,t=a.exec(e),null!=t&&!i.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(l,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?s.push(...mt(e,this.rankMap)):s.push(n)}if(null==t)break;let c=this.specialTokens[t[0]];s.push(c),l=t.index+t[0].length}return s}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const a=e[r],s=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=s&&(t.push(s),n+=s.length)}const r=new Uint8Array(n);let a=0;for(const e of t)r.set(e,a),a+=e.length;return this.textDecoder.decode(r)}},_t=bt;yt=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?ft(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(_t,"symbol"!=typeof(gt="specialTokenRegex")?gt+"":gt,yt);const wt={},vt=new ht.g({});var kt=n(3292);function Ot(e){return!("object"!=typeof e||!e||!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function))}class Et extends kt.YN{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class xt extends Et{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){const{cache:r,...a}=n;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache="object"==typeof r?r:r?ut.global():void 0,this.caller=new ht.g(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in wt||(wt[e]=vt.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new _t(e))).catch((t=>{throw delete wt[e],t}))),await wt[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new dt.HY(e):Array.isArray(e)?new dt.aB(e.map(it.K0)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),a=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return a}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}var At=n(5780),St=n(58),It=n(765);class Tt extends kt.YN{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=(0,It.ZI)(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=(0,It.ZI)(t);let r,a=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,a)if(void 0===r)r=t;else try{r=(0,St.xW)(r,t)}catch{r=void 0,a=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new kt.B2(new kt.ck({steps:e}))}}function Pt(e){return"function"==typeof e?.parse}var Ct=n(5960);class Rt extends xt{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(e,t){const n=Rt._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===Rt.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=Rt._convertInputToPromptValue(e).toChatMessages(),[r,a]=this._separateRunnableConfigFromCallOptionsCompat(t),s={...r.metadata,...this.getLsParams(a)},i=await At.Td.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},l=await(i?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,o,void 0,void 0,r.runName));let c,u;try{for await(const e of this._streamResponseChunks(n,a,l?.[0])){if(null==e.message.id){const t=l?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e,(0,Xe.jm)(e.message)&&void 0!==e.message.usage_metadata&&(u={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((l??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((l??[]).map((e=>e?.handleLLMEnd({generations:[[c]],llmOutput:u}))))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,n){const r=e.map((e=>e.map(Xe.K0))),a={...n.metadata,...this.getLsParams(t)},s=await At.Td.configure(n.callbacks,this.callbacks,n.tags,this.tags,a,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1},o=await(s?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,i,void 0,void 0,n.runName)),l=[],c=[];if(o?.[0].handlers.find(Ct.xL)&&1===r.length&&this._streamResponseChunks!==Rt.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(r[0],t,o?.[0]);let n,a;for await(const t of e){if(null==t.message.id){const e=o?.at(0)?.runId;null!=e&&t.message._updateId(`run-${e}`)}n=void 0===n?t:(0,St.xW)(n,t),(0,Xe.jm)(t.message)&&void 0!==t.message.usage_metadata&&(a={tokenUsage:{promptTokens:t.message.usage_metadata.input_tokens,completionTokens:t.message.usage_metadata.output_tokens,totalTokens:t.message.usage_metadata.total_tokens}})}if(void 0===n)throw new Error("Received empty response from chat model call.");l.push([n]),await(o?.[0].handleLLMEnd({generations:l,llmOutput:a}))}catch(e){throw await(o?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},o?.[n]))));await Promise.all(e.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations){if(null==e.message.id){const t=o?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),l[t]=n.generations,c[t]=n.llmOutput,o?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(o?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})))}const u={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(u,Qe.SP,{value:o?{runIds:o?.map((e=>e.runId))}:void 0,configurable:!0}),u}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:a}){const s=e.map((e=>e.map(Xe.K0))),i={...a.metadata,...this.getLsParams(r)},o=await At.Td.configure(a.callbacks,this.callbacks,a.tags,this.tags,i,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(o?.handleChatModelStart(this.toJSON(),s,a.runId,void 0,l,void 0,void 0,a.runName)),u=[],d=(await Promise.allSettled(s.map((async(e,r)=>{const a=Rt._convertInputToPromptValue(e).toString(),s=await t.lookup(a,n);return null==s&&u.push(r),s})))).map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),h=[];await Promise.all(d.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return h[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const p={generations:h,missingPromptIndices:u};return Object.defineProperty(p,Qe.SP,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),p}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const a=e.map((e=>e.map(Xe.K0))),[s,i]=this._separateRunnableConfigFromCallOptionsCompat(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(a,i,s);const{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:u}=await this._generateCached({messages:a,cache:o,llmStringKey:l,parsedOptions:i,handledOptions:s});let d={};if(u.length>0){const e=await this._generateUncached(u.map((e=>a[e])),i,s);await Promise.all(e.generations.map((async(e,t)=>{const n=u[t];c[n]=e;const r=Rt._convertInputToPromptValue(a[n]).toString();return o.update(r,l,e)}))),d=e.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(Xe.K0)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new Xe.xc(e),a=await this.call([r],t,n);if("string"!=typeof a.content)throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,r=t?.name,a=n.description??"A function available to call.",s=t?.method,i=t?.includeRaw;if("jsonMode"===s)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,l=r??"extract";Pt(n)?o=[{type:"function",function:{name:l,description:a,parameters:(0,We.Ik)(n)}}]:("name"in n&&(l=n.name),o=[{type:"function",function:{name:l,description:a,parameters:n}}]);const c=this.bindTools(o),u=kt.jY.from((e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find((e=>e.name===l));if(!t)throw new Error(`No tool call found with name ${l}.`);return t.args}));if(!i)return c.pipe(u).withConfig({runName:"StructuredOutput"});const d=Tt.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=Tt.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return kt.zZ.from([{raw:c},p]).withConfig({runName:"StructuredOutputRunnable"})}}function Nt(e){if("object"==typeof e&&null!==e){const t={...e};"additionalProperties"in t&&delete t.additionalProperties,"$schema"in t&&delete t.$schema;for(const e in t)e in t&&(Array.isArray(t[e])?t[e]=t[e].map(Nt):"object"==typeof t[e]&&null!==t[e]&&(t[e]=Nt(t[e])));return t}return e}function jt(e){const t=Nt((0,We.Ik)(e)),{$schema:n,...r}=t;return r}function $t(e){const t=Nt(e),{$schema:n,...r}=t;return r}function Mt(e,t){const n="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:(0,We.Ik)(e.schema),...void 0!==n?.strict?{strict:n.strict}:{}}}function Lt(e){return function(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&Pt(e.schema)}(e)||function(e){return void 0!==e&&kt.YN.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)||function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)}function Dt(e,t,n=!1){return e.reduce(((e,r,a)=>{if(!(0,Xe.ny)(r))throw new Error("Unsupported message input");const s=function(e){const t=e._getType();return Xe.cM.isInstance(e)?e.role:"tool"===t?t:e.name??t}(r);if("system"===s&&0!==a)throw new Error("System message should be the first one");const i=function(e){switch(e){case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${e}`)}}(s),o=e.content[e.content.length];if(!e.mergeWithPreviousContent&&o&&o.role===i)throw new Error("Google Generative AI requires alternate messages between authors");const l=function(e,t){if("string"==typeof e.content&&""!==e.content)return[{text:e.content}];let n=[],r=[],a=[];return"tool_calls"in e&&Array.isArray(e.tool_calls)&&e.tool_calls.length>0?n=e.tool_calls.map((e=>({functionCall:{name:e.name,args:e.args}}))):"tool"===e.getType()&&e.name&&e.content?r=[{functionResponse:{name:e.name,response:e.content}}]:Array.isArray(e.content)&&(a=e.content.map((e=>{if("text"===e.type)return{text:e.text};if("executableCode"===e.type)return{executableCode:e.executableCode};if("codeExecutionResult"===e.type)return{codeExecutionResult:e.codeExecutionResult};if("image_url"===e.type){if(!t)throw new Error("This model does not support images");let n;if("string"==typeof e.image_url)n=e.image_url;else{if("object"!=typeof e.image_url||!("url"in e.image_url))throw new Error("Please provide image as base64 encoded data URL");n=e.image_url.url}const[r,a]=n.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[s,i]=r.replace(/^data:/,"").split(";");if("base64"!==i)throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:a,mimeType:s}}}if("media"===e.type)return function(e){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};throw new Error("Invalid media content")}(e);if("tool_use"===e.type)return{functionCall:{name:e.name,args:e.input}};throw new Error(`Unknown content type ${e.type}`)}))),[...a,...n,...r]}(r,t);if(e.mergeWithPreviousContent){const t=e.content[e.content.length-1];if(!t)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return t.parts.push(...l),{mergeWithPreviousContent:!1,content:e.content}}let c=i;("function"===c||"system"===c&&!n)&&(c="user");const u={role:c,parts:l};return{mergeWithPreviousContent:"system"===s&&!n,content:[...e.content,u]}}),{content:[],mergeWithPreviousContent:!1}).content}function Ut(e,t){if(!e.candidates||0===e.candidates.length)return null;const n=e.functionCalls(),[r]=e.candidates,{content:a,...s}=r;let i;a?.parts&&a.parts.every((e=>"text"in e))?i=a.parts.map((e=>e.text)).join(""):a.parts&&(i=a.parts.map((e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e)));let o="";i&&"string"==typeof i?o=i:i&&"object"==typeof i&&"text"in i[0]&&(o=i[0].text);const l=[];return n&&l.push(...n.map((e=>({...e,args:JSON.stringify(e.args),index:t.index,type:"tool_call_chunk"})))),new Qe.Cf({text:o,message:new Xe.H({content:i||"",name:a?a.role:void 0,tool_call_chunks:l,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:s})}kt.YN,kt.YN,kt.fJ;var Ft=n(1368);class zt extends kt.YN{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class Bt extends zt{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class Zt extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");(0,Ft.Y)(this,"OUTPUT_PARSING_FAILURE")}}function Ht(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!Ht(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!Ht(e[r],t[r]))return!1;return!0}return e===t}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");const qt=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function Gt(e){return e.test.bind(e)}Yt.bind(void 0,!1),Gt(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),Gt(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),Gt(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),Gt(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),Gt(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),Gt(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),Gt(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),Gt(/^(?:\/(?:[^~/]|~0|~1)*)*$/),Gt(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),Gt(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/);function Yt(e,t){const n=t.match(qt);if(!n)return!1;const r=+n[1],a=+n[2],s=+n[3],i=!!n[5];return(r<=23&&a<=59&&s<=59||23==r&&59==a&&60==s)&&(!e||i)}Gt(/^\d\d\d\d-[0-1]\d-[0-3]\d$/),Gt(/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i),Gt(/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i),Gt(/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i);var Kt;!function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"}(Kt||(Kt={}));var Vt=n(3490);class Jt extends Bt{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class Wt extends Jt{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const r of e){if("string"!=typeof r&&"string"!=typeof r.content)throw new Error("Cannot handle non-string output.");let e;if((0,Vt.AJ)(r)){if("string"!=typeof r.content)throw new Error("Cannot handle non-string message output.");e=new Qe.Cf({message:r,text:r.content})}else if((0,Vt.ny)(r)){if("string"!=typeof r.content)throw new Error("Cannot handle non-string message output.");e=new Qe.Cf({message:(0,it.ih)(r),text:r.content})}else e=new Qe.mu({text:r});n=void 0===n?e:n.concat(e);const a=await this.parsePartialResult([n]);null==a||Ht(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}class Xt extends Jt{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce(((e,t)=>e+this._messageContentComplexToString(t)),"")}}var Qt=n(4476);class en extends Bt{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Qt.z.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Qt.z.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify((0,We.Ik)(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Zt(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}var tn=n(6150),nn=n(780);class rn extends Wt{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?(0,tn.UD)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,nn.D)(e[0].text)}async parse(e){return(0,nn.D)(e,JSON.parse)}getFormatInstructions(){return""}}class an extends zt{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Zt(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap((e=>{const{message:t}=e;return"tool_calls"in t&&Array.isArray(t.tool_calls)?t.tool_calls:[]}));if(void 0===t[0])throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function sn(e,t){const n=function(e){let t=[];const n=[];e.forEach((e=>{if(Lt(e)){const[n]=function(e){return e.every((e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations)))?e:[{functionDeclarations:e.map((e=>{if(Lt(e)){const t=jt(e.schema);return{name:e.name,description:e.description,parameters:t}}return Ot(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:$t(e.function.parameters)}:e}))}]}([e]);n.functionDeclarations&&t.push(...n.functionDeclarations)}else if(Ot(e)){const{functionDeclarations:n}=function(e){return{functionDeclarations:[{name:e.function.name,description:e.function.description,parameters:Nt(e.function.parameters)}]}}(e);if(!n)throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool");t.push(...n)}else n.push(e)}));return n.find((e=>"functionDeclarations"in e))?n.map((e=>{if(t?.length>0&&"functionDeclarations"in e){const n={functionDeclarations:[...e.functionDeclarations||[],...t]};return t=[],n}return e})):[...n,...t.length>0?[{functionDeclarations:t}]:[]]}(e),r=function(e,t){if(!e.length||!t)return;const{toolChoice:n,allowedFunctionNames:r}=t,a={any:ge.ANY,auto:ge.AUTO,none:ge.NONE};return n&&["any","auto","none"].includes(n)?{functionCallingConfig:{mode:a[n]??"MODE_UNSPECIFIED",allowedFunctionNames:r}}:"string"==typeof n||r?{functionCallingConfig:{mode:ge.ANY,allowedFunctionNames:[...r??[],...n&&"string"==typeof n?[n]:[]]}}:void 0}(n,t);return{tools:n,toolConfig:r}}class on extends Rt{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??(0,Je.Az)("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map((e=>e.category))).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=e?.streaming??this.streaming,this.client=new Ve(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...e?.json?{responseMimeType:"application/json"}:{}}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl}),this.streamUsage=e?.streamUsage??this.streamUsage}useCachedContent(e,t,n){this.apiKey&&(this.client=new Ve(this.apiKey).getGenerativeModelFromCachedContent(e,t,n))}get useSystemInstruction(){return"boolean"==typeof this.convertSystemMessageToHumanContent?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return"gemini-1.0-pro-001"!==this.modelName&&!this.modelName.startsWith("gemini-pro-vision")&&!this.modelName.startsWith("gemini-1.0-pro-vision")&&"gemini-pro"!==this.modelName}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:sn(e)?.tools,...t})}invocationParams(e){const t=e?.tools?.length?sn(e.tools,{toolChoice:e.tool_choice,allowedFunctionNames:e.allowedFunctionNames}):void 0;return{...t?.tools?{tools:t.tools}:{},...t?.toolConfig?{toolConfig:t.toolConfig}:{}}}async _generate(e,t,n){const r=Dt(e,this._isMultimodalModel,this.useSystemInstruction);let a=r;if("system"===r[0].role){const[e]=r;this.client.systemInstruction=e,a=r.slice(1)}const s=this.invocationParams(t);if(this.streaming){const r={},a=this._streamResponseChunks(e,t,n),s={};for await(const e of a){const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const i=Object.entries(s).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t));return{generations:i,llmOutput:{estimatedTokenUsage:r}}}const i=await this.completionWithRetry({...s,contents:a});let o;if("usageMetadata"in i.response){const e=i.response.usageMetadata;o={input_tokens:e.promptTokenCount??0,output_tokens:e.candidatesTokenCount??0,total_tokens:e.totalTokenCount??0}}const l=function(e,t){if(!e.candidates||0===e.candidates.length||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};const n=e.functionCalls(),[r]=e.candidates,{content:a,...s}=r;let i;i=1===a?.parts.length&&a.parts[0].text?a.parts[0].text:a.parts.map((e=>"text"in e?{type:"text",text:e.text}:"executableCode"in e?{type:"executableCode",executableCode:e.executableCode}:"codeExecutionResult"in e?{type:"codeExecutionResult",codeExecutionResult:e.codeExecutionResult}:e));let o="";return"string"==typeof i?o=i:"text"in i[0]&&(o=i[0].text),{generations:[{text:o,message:new Xe.Od({content:i,tool_calls:n?.map((e=>({...e,type:"tool_call"}))),additional_kwargs:{...s},usage_metadata:t?.usageMetadata}),generationInfo:s}]}}(i.response,{usageMetadata:o});return await(n?.handleLLMNewToken(l.generations[0].text??"")),l}async*_streamResponseChunks(e,t,n){const r=Dt(e,this._isMultimodalModel,this.useSystemInstruction);let a=r;if("system"===r[0].role){const[e]=r;this.client.systemInstruction=e,a=r.slice(1)}const s={...this.invocationParams(t),contents:a},i=await this.caller.callWithOptions({signal:t?.signal},(async()=>{const{stream:e}=await this.client.generateContentStream(s);return e}));let o,l=0;for await(const e of i){if("usageMetadata"in e&&!1!==this.streamUsage&&!1!==t.streamUsage){const t=e.usageMetadata;if(o){const e=t.candidatesTokenCount-o.output_tokens;o={input_tokens:0,output_tokens:e,total_tokens:e}}else o={input_tokens:t.promptTokenCount,output_tokens:t.candidatesTokenCount,total_tokens:t.totalTokenCount}}const r=Ut(e,{usageMetadata:o,index:l});l+=1,r&&(yield r,await(n?.handleLLMNewToken(r.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t?.signal},(async()=>{try{return await this.client.generateContent(e)}catch(e){throw e.message?.includes("400 Bad Request")&&(e.status=400),e}}))}withStructuredOutput(e,t){const n=e,r=t?.name,a=t?.method,s=t?.includeRaw;if("jsonMode"===a)throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let i,o,l=r??"extract";if(Pt(n)){const e=jt(n);o=[{functionDeclarations:[{name:l,description:e.description??"A function available to call.",parameters:e}]}],i=new an({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(e=n,l=n.name):e={name:l,description:n.description??"",parameters:n},o=[{functionDeclarations:[e]}],i=new an({returnSingle:!0,keyName:l})}const c=this.bind({tools:o,tool_choice:l});if(!s)return c.pipe(i).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const u=Tt.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),d=Tt.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return kt.zZ.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}const ln="RFC3986",cn={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},un=(Object.prototype.hasOwnProperty,Array.isArray),dn=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),hn=1024;function pn(e,t){if(un(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const fn=Object.prototype.hasOwnProperty,mn={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},gn=Array.isArray,yn=Array.prototype.push,bn=function(e,t){yn.apply(e,gn(t)?t:[t])},_n=Date.prototype.toISOString,wn={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,a)=>{if(0===e.length)return e;let s=e;if("symbol"==typeof e?s=Symbol.prototype.toString.call(e):"string"!=typeof e&&(s=String(e)),"iso-8859-1"===n)return escape(s).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let i="";for(let e=0;e<s.length;e+=hn){const t=s.length>=hn?s.slice(e,e+hn):s,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===a&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=dn[r]:r<2048?n[n.length]=dn[192|r>>6]+dn[128|63&r]:r<55296||r>=57344?n[n.length]=dn[224|r>>12]+dn[128|r>>6&63]+dn[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=dn[240|r>>18]+dn[128|r>>12&63]+dn[128|r>>6&63]+dn[128|63&r])}i+=n.join("")}return i},encodeValuesOnly:!1,format:ln,formatter:cn[ln],indices:!1,serializeDate:e=>_n.call(e),skipNulls:!1,strictNullHandling:!1},vn={};function kn(e,t,n,r,a,s,i,o,l,c,u,d,h,p,f,m,g,y){let b=e,_=y,w=0,v=!1;for(;void 0!==(_=_.get(vn))&&!v;){const t=_.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");v=!0}void 0===_.get(vn)&&(w=0)}if("function"==typeof c?b=c(t,b):b instanceof Date?b=h?.(b):"comma"===n&&gn(b)&&(b=pn(b,(function(e){return e instanceof Date?h?.(e):e}))),null===b){if(s)return l&&!m?l(t,wn.encoder,g,"key",p):t;b=""}if("string"==typeof(k=b)||"number"==typeof k||"boolean"==typeof k||"symbol"==typeof k||"bigint"==typeof k||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(b)){if(l){const e=m?t:l(t,wn.encoder,g,"key",p);return[f?.(e)+"="+f?.(l(b,wn.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(b))]}var k;const O=[];if(void 0===b)return O;let E;if("comma"===n&&gn(b))m&&l&&(b=pn(b,l)),E=[{value:b.length>0?b.join(",")||null:void 0}];else if(gn(c))E=c;else{const e=Object.keys(b);E=u?e.sort(u):e}const x=o?String(t).replace(/\./g,"%2E"):String(t),A=r&&gn(b)&&1===b.length?x+"[]":x;if(a&&gn(b)&&0===b.length)return A+"[]";for(let t=0;t<E.length;++t){const _=E[t],v="object"==typeof _&&void 0!==_.value?_.value:b[_];if(i&&null===v)continue;const k=d&&o?_.replace(/\./g,"%2E"):_,x=gn(b)?"function"==typeof n?n(A,k):A:A+(d?"."+k:"["+k+"]");y.set(e,w);const S=new WeakMap;S.set(vn,y),bn(O,kn(v,x,n,r,a,s,i,o,"comma"===n&&m&&gn(b)?null:l,c,u,d,h,p,f,m,g,S))}return O}const On="4.77.3";let En,xn,An,Sn,In,Tn,Pn,Cn,Rn,Nn=!1,jn=null,$n=null,Mn=null,Ln=null;class Dn{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}En||function(e,t={auto:!1}){if(Nn)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(En)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${En}'\``);Nn=t.auto,En=e.kind,xn=e.fetch,jn=e.Request,$n=e.Response,Mn=e.Headers,An=e.FormData,Ln=e.Blob,Sn=e.File,In=e.ReadableStream,Tn=e.getMultipartRequestOptions,Pn=e.getDefaultAgent,Cn=e.fileFromPath,Rn=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,a,s;try{n=fetch,r=Request,a=Response,s=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:a,Headers:s,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Dn(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class Un extends Error{}class Fn extends Un{constructor(e,t,n,r){super(`${Fn.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"],this.error=t;const a=t;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new Bn({message:n,cause:jr(t)});const a=t?.error;return 400===e?new Hn(e,a,n,r):401===e?new qn(e,a,n,r):403===e?new Gn(e,a,n,r):404===e?new Yn(e,a,n,r):409===e?new Kn(e,a,n,r):422===e?new Vn(e,a,n,r):429===e?new Jn(e,a,n,r):e>=500?new Wn(e,a,n,r):new Fn(e,a,n,r)}}class zn extends Fn{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Bn extends Fn{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Zn extends Bn{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Hn extends Fn{}class qn extends Fn{}class Gn extends Fn{}class Yn extends Fn{}class Kn extends Fn{}class Vn extends Fn{}class Jn extends Fn{}class Wn extends Fn{}class Xn extends Un{constructor(){super("Could not parse response content as the length limit was reached")}}class Qn extends Un{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class er{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=er.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(er.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Un(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Un(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Un("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}er.NEWLINE_CHARS=new Set(["\n","\r"]),er.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class tr{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new tr((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Un("Attempted to iterate over a response with no body");const n=new rr,r=new er,a=ar(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(r=nr(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(a))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!r)if(n.data.startsWith("[DONE]"))r=!0;else if(null===n.event){let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if(e&&e.error)throw new Fn(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("error"==n.event)throw new Fn(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new tr((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new er,n=ar(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new tr((()=>r(e)),this.controller),new tr((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new In({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:a}=await t.next();if(a)return e.close();const s=n.encode(JSON.stringify(r)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function nr(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class rr{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(":");return-1!==n?[e.substring(0,n),":",e.substring(n+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}function ar(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const sr=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,ir=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&or(e),or=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function lr(e,t,n){if(e=await e,ir(e))return e;if(sr(e)){const r=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=or(r)?[await r.arrayBuffer()]:[r];return new Sn(a,t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(or(e))t.push(await e.arrayBuffer());else{if(!ur(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return cr(e.name)||cr(e.filename)||cr(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new Sn(r,t,n)}const cr=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,ur=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],dr=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],hr=async e=>{const t=await pr(e.body);return Tn(t,e)},pr=async e=>{const t=new An;return await Promise.all(Object.entries(e||{}).map((([e,n])=>fr(t,e,n)))),t},fr=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>ir(e)||sr(e)||Rn(e))(n)){const r=await lr(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>fr(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>fr(e,`${t}[${n}]`,r))))}}};var mr;async function gr(e){const{response:t}=e;if(e.options.stream)return Ur("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):tr.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Ur("response",t.status,t.url,t.headers,e),yr(e,t)}const r=await t.text();return Ur("response",t.status,t.url,t.headers,r),r}function yr(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class br extends Promise{constructor(e,t=gr){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new br(this.responsePromise,(async t=>yr(e(await this.parseResponse(t),t),t.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class _r{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:a}){this.baseURL=e,this.maxRetries=Nr("maxRetries",t),this.timeout=Nr("timeout",n),this.httpAgent=r,this.fetch=a??xn}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ir(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Fr()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const r=n&&or(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:r}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:r,query:a,headers:s={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:dr(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),l=this.buildURL(r,a);"timeout"in e&&Nr("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??Pn(l),d=c+1e3;return"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:s,contentLength:o,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const a={};n&&(a["content-length"]=n);const s=this.defaultHeaders(e);return Dr(a,s),Dr(a,t),dr(e.body)&&"node"!==En&&delete a["content-type"],void 0===zr(s,"x-stainless-retry-count")&&void 0===zr(t,"x-stainless-retry-count")&&(a["x-stainless-retry-count"]=String(r)),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return Fn.generate(e,t,n,r)}request(e,t=null){return new br(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:a,url:s,timeout:i}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(a,{url:s,options:n}),Ur("request",s,n,a.headers),n.signal?.aborted)throw new zn;const o=new AbortController,l=await this.fetchWithTimeout(s,a,i,o).catch(jr);if(l instanceof Error){if(n.signal?.aborted)throw new zn;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new Zn;throw new Bn({cause:l})}const c=kr(l.headers);if(!l.ok){if(t&&this.shouldRetry(l))return Ur(`response (error; retrying, ${t} attempts remaining)`,l.status,s,c),this.retryRequest(n,t,c);const e=await l.text().catch((e=>jr(e).message)),r=Tr(e),a=r?void 0:e;throw Ur(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,s,c,a),this.makeStatusError(l.status,r,a,c)}return{response:l,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new vr(this,n,e)}buildURL(e,t){const n=Cr(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Mr(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Un(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:a,...s}=t||{};a&&a.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n),o={signal:r.signal,...s};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally((()=>{clearTimeout(i)}))}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n){let r;const a=n?.["retry-after-ms"];if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const s=n?.["retry-after"];if(s&&!r){const e=parseFloat(s);r=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Rr(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${On}`}}class wr{constructor(e,t,n,r){mr.set(this,void 0),function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===r?a.call(e,n):a?a.value=n:t.set(e,n)}(this,mr,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new Un("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}(this,mr,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(mr=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class vr extends br{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await gr(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const kr=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Or={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Er=e=>"object"==typeof e&&null!==e&&!Mr(e)&&Object.keys(e).every((e=>Lr(Or,e))),xr=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Ar=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Sr;const Ir=()=>Sr??(Sr=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":On,"X-Stainless-OS":Ar(Deno.build.os),"X-Stainless-Arch":xr(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":On,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":On,"X-Stainless-OS":Ar(process.platform),"X-Stainless-Arch":xr(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":On,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":On,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),Tr=e=>{try{return JSON.parse(e)}catch(e){return}},Pr=/^[a-z][a-z0-9+.-]*:/i,Cr=e=>Pr.test(e),Rr=e=>new Promise((t=>setTimeout(t,e))),Nr=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Un(`${e} must be an integer`);if(t<0)throw new Un(`${e} must be a positive integer`);return t},jr=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},$r=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Mr(e){if(!e)return!0;for(const t in e)return!1;return!0}function Lr(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Dr(e,t){for(const n in t){if(!Lr(t,n))continue;const r=n.toLowerCase();if(!r)continue;const a=t[n];null===a?delete e[r]:void 0!==a&&(e[r]=a)}}function Ur(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const Fr=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),zr=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const a of[t,n,t.toUpperCase(),r]){const t=e.get(a);if(t)return t}}for(const[r,a]of Object.entries(e))if(r.toLowerCase()===n)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${t} header, using the first entry.`),a[0]):a};function Br(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class Zr{constructor(e){this._client=e}}class Hr extends Zr{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class qr extends Zr{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}}class Gr extends Zr{constructor(){super(...arguments),this.completions=new qr(this._client)}}Gr.Completions=qr;class Yr extends Zr{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}class Kr extends wr{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Vr extends wr{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Jr extends Zr{create(e,t){return this._client.post("/files",hr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Er(e)?this.list({},e):this._client.getAPIList("/files",Wr,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let s=await this.retrieve(e);for(;!s.status||!r.has(s.status);)if(await Rr(t),s=await this.retrieve(e),Date.now()-a>n)throw new Zn({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return s}}class Wr extends Vr{}Jr.FileObjectsPage=Wr;class Xr extends Zr{createVariation(e,t){return this._client.post("/images/variations",hr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",hr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Qr extends Zr{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}class ea extends Zr{create(e,t){return this._client.post("/audio/transcriptions",hr({body:e,...t}))}}class ta extends Zr{create(e,t){return this._client.post("/audio/translations",hr({body:e,...t}))}}class na extends Zr{constructor(){super(...arguments),this.transcriptions=new ea(this._client),this.translations=new ta(this._client),this.speech=new Qr(this._client)}}na.Transcriptions=ea,na.Translations=ta,na.Speech=Qr;class ra extends Zr{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class aa extends Zr{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",sa,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class sa extends Kr{}aa.ModelsPage=sa;class ia extends Zr{list(e,t={},n){return Er(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,oa,{query:t,...n})}}class oa extends Vr{}ia.FineTuningJobCheckpointsPage=oa;class la extends Zr{constructor(){super(...arguments),this.checkpoints=new ia(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Er(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",ca,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return Er(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,ua,{query:t,...n})}}class ca extends Vr{}class ua extends Vr{}la.FineTuningJobsPage=ca,la.FineTuningJobEventsPage=ua,la.Checkpoints=ia,la.FineTuningJobCheckpointsPage=oa;class da extends Zr{constructor(){super(...arguments),this.jobs=new la(this._client)}}da.Jobs=la,da.FineTuningJobsPage=ca,da.FineTuningJobEventsPage=ua;class ha extends Zr{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Er(e)?this.list({},e):this._client.getAPIList("/assistants",pa,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class pa extends Vr{}function fa(e){return"function"==typeof e.parse}ha.AssistantsPage=pa;const ma=e=>"assistant"===e?.role,ga=e=>"function"===e?.role,ya=e=>"tool"===e?.role;var ba,_a,wa,va,ka,Oa,Ea,xa,Aa,Sa,Ia,Ta,Pa,Ca=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},Ra=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Na{constructor(){ba.add(this),this.controller=new AbortController,_a.set(this,void 0),wa.set(this,(()=>{})),va.set(this,(()=>{})),ka.set(this,void 0),Oa.set(this,(()=>{})),Ea.set(this,(()=>{})),xa.set(this,{}),Aa.set(this,!1),Sa.set(this,!1),Ia.set(this,!1),Ta.set(this,!1),Ca(this,_a,new Promise(((e,t)=>{Ca(this,wa,e,"f"),Ca(this,va,t,"f")})),"f"),Ca(this,ka,new Promise(((e,t)=>{Ca(this,Oa,e,"f"),Ca(this,Ea,t,"f")})),"f"),Ra(this,_a,"f").catch((()=>{})),Ra(this,ka,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Ra(this,ba,"m",Pa).bind(this))}),0)}_connected(){this.ended||(Ra(this,wa,"f").call(this),this._emit("connect"))}get ended(){return Ra(this,Aa,"f")}get errored(){return Ra(this,Sa,"f")}get aborted(){return Ra(this,Ia,"f")}abort(){this.controller.abort()}on(e,t){return(Ra(this,xa,"f")[e]||(Ra(this,xa,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Ra(this,xa,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Ra(this,xa,"f")[e]||(Ra(this,xa,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Ca(this,Ta,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Ca(this,Ta,!0,"f"),await Ra(this,ka,"f")}_emit(e,...t){if(Ra(this,Aa,"f"))return;"end"===e&&(Ca(this,Aa,!0,"f"),Ra(this,Oa,"f").call(this));const n=Ra(this,xa,"f")[e];if(n&&(Ra(this,xa,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Ra(this,Ta,"f")||n?.length||Promise.reject(e),Ra(this,va,"f").call(this,e),Ra(this,Ea,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Ra(this,Ta,"f")||n?.length||Promise.reject(e),Ra(this,va,"f").call(this,e),Ra(this,Ea,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function ja(e){return"auto-parseable-response-format"===e?.$brand}function $a(e){return"auto-parseable-tool"===e?.$brand}function Ma(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new Xn;if("content_filter"===e.finish_reason)throw new Qn;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:$a(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?La(t,e.message.content):null}}}));return{...e,choices:n}}function La(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function Da(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return $a(n)||n?.function.strict||!1}function Ua(e){return!!ja(e.response_format)||(e.tools?.some((e=>$a(e)||"function"===e.type&&!0===e.function.strict))??!1)}_a=new WeakMap,wa=new WeakMap,va=new WeakMap,ka=new WeakMap,Oa=new WeakMap,Ea=new WeakMap,xa=new WeakMap,Aa=new WeakMap,Sa=new WeakMap,Ia=new WeakMap,Ta=new WeakMap,ba=new WeakSet,Pa=function(e){if(Ca(this,Sa,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new zn),e instanceof zn)return Ca(this,Ia,!0,"f"),this._emit("abort",e);if(e instanceof Un)return this._emit("error",e);if(e instanceof Error){const t=new Un(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Un(String(e)))};var Fa,za,Ba,Za,Ha,qa,Ga,Ya,Ka=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Va=10;class Ja extends Na{constructor(){super(...arguments),Fa.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(ga(e)||ya(e))&&e.content)this._emit("functionCallResult",e.content);else if(ma(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(ma(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new Un("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Ka(this,Fa,"m",za).call(this)}async finalMessage(){return await this.done(),Ka(this,Fa,"m",Ba).call(this)}async finalFunctionCall(){return await this.done(),Ka(this,Fa,"m",Za).call(this)}async finalFunctionCallResult(){return await this.done(),Ka(this,Fa,"m",Ha).call(this)}async totalUsage(){return await this.done(),Ka(this,Fa,"m",qa).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=Ka(this,Fa,"m",Ba).call(this);t&&this._emit("finalMessage",t);const n=Ka(this,Fa,"m",za).call(this);n&&this._emit("finalContent",n);const r=Ka(this,Fa,"m",Za).call(this);r&&this._emit("finalFunctionCall",r);const a=Ka(this,Fa,"m",Ha).call(this);null!=a&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",Ka(this,Fa,"m",qa).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Ka(this,Fa,"m",Ga).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Ma(a,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.name,{maxChatCompletions:l=Va}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:a,functions:u,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Un("missing message in ChatCompletion response");if(!s.function_call)return;const{name:l,arguments:d}=s.function_call,h=c[l];if(!h){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:l,content:e});continue}if(o&&o!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:l,content:e});continue}let p;try{p=fa(h)?await h.parse(d):d}catch(e){this._addMessage({role:r,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=Ka(this,Fa,"m",Ya).call(this,f);if(this._addMessage({role:r,name:l,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.function?.name,{maxChatCompletions:l=Va}=n||{},c=t.tools.map((e=>{if($a(e)){if(!e.$callback)throw new Un("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?c.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:a,tools:d,messages:[...this.messages]},n),s=t.choices[0]?.message;if(!s)throw new Un("missing message in ChatCompletion response");if(!s.tool_calls?.length)return;for(const e of s.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:a}=e.function,s=u[n];if(!s){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let i;try{i=fa(s)?await s.parse(a):a}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const l=await s.function(i,this),c=Ka(this,Fa,"m",Ya).call(this,l);if(this._addMessage({role:r,tool_call_id:t,content:c}),o)return}}}}Fa=new WeakSet,za=function(){return Ka(this,Fa,"m",Ba).call(this).content??null},Ba=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(ma(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null,refusal:t.refusal??null};return e&&(r.function_call=e),r}}throw new Un("stream ended without producing a ChatCompletionMessage with role=assistant")},Za=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ma(t)&&t?.function_call)return t.function_call;if(ma(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Ha=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ga(t)&&null!=t.content)return t.content;if(ya(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},qa=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Ga=function(e){if(null!=e.n&&e.n>1)throw new Un("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Ya=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Wa extends Ja{static runFunctions(e,t,n){const r=new Wa,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new Wa,a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}_addMessage(e,t=!0){super._addMessage(e,t),ma(e)&&e.content&&this._emit("content",e.content)}}class Xa extends Error{}class Qa extends Error{}const es=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let r=0;const a=e=>{throw new Xa(`${e} at position ${r}`)},s=e=>{throw new Qa(`${e} at position ${r}`)},i=()=>(d(),r>=n&&a("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?l():"["===e[r]?c():"null"===e.substring(r,r+4)||16&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||32&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||32&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||128&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||256&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||64&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const i=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(i,++r-Number(o)))}catch(e){s(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},l=()=>{r++,d();const s={};try{for(;"}"!==e[r];){if(d(),r>=n&&8&t)return s;const a=o();d(),r++;try{const e=i();Object.defineProperty(s,a,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return s;throw e}d(),","===e[r]&&r++}}catch(e){if(8&t)return s;a("Expected '}' at end of object")}return r++,s},c=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(i()),d(),","===e[r]&&r++}catch(e){if(4&t)return n;a("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}s(String(n))}}const i=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||2&t||a("Unterminated number literal");try{return JSON.parse(e.substring(i,r))}catch(n){"-"===e.substring(i,r)&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){s(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return i()})(e.trim(),t)}(e,509);var ts,ns,rs,as,ss,is,os,ls,cs,us,ds,hs,ps=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n},fs=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class ms extends Ja{constructor(e){super(),ts.add(this),ns.set(this,void 0),rs.set(this,void 0),as.set(this,void 0),ps(this,ns,e,"f"),ps(this,rs,[],"f")}get currentChatCompletionSnapshot(){return fs(this,as,"f")}static fromReadableStream(e){const t=new ms(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new ms(t);return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),fs(this,ts,"m",ss).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of a)fs(this,ts,"m",os).call(this,e);if(a.controller.signal?.aborted)throw new zn;return this._addChatCompletion(fs(this,ts,"m",us).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),fs(this,ts,"m",ss).call(this),this._connected();const r=tr.fromReadableStream(e,this.controller);let a;for await(const e of r)a&&a!==e.id&&this._addChatCompletion(fs(this,ts,"m",us).call(this)),fs(this,ts,"m",os).call(this,e),a=e.id;if(r.controller.signal?.aborted)throw new zn;return this._addChatCompletion(fs(this,ts,"m",us).call(this))}[(ns=new WeakMap,rs=new WeakMap,as=new WeakMap,ts=new WeakSet,ss=function(){this.ended||ps(this,as,void 0,"f")},is=function(e){let t=fs(this,rs,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},fs(this,rs,"f")[e.index]=t,t)},os=function(e){if(this.ended)return;const t=fs(this,ts,"m",hs).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=fs(this,ts,"m",is).call(this,e);e.finish_reason&&(fs(this,ts,"m",cs).call(this,e),null!=r.current_tool_call_index&&fs(this,ts,"m",ls).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(fs(this,ts,"m",cs).call(this,e),null!=r.current_tool_call_index&&fs(this,ts,"m",ls).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&"function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""})}}},ls=function(e,t){if(fs(this,ts,"m",is).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=fs(this,ns,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:$a(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},cs=function(e){const t=fs(this,ts,"m",is).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=fs(this,ts,"m",ds).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},us=function(){if(this.ended)throw new Un("stream has ended, this shouldn't happen");const e=fs(this,as,"f");if(!e)throw new Un("request ended without sending any chunks");return ps(this,as,void 0,"f"),ps(this,rs,[],"f"),function(e,t){const{id:n,choices:r,created:a,model:s,system_fingerprint:i,...o}=e,l={...o,id:n,choices:r.map((({message:t,finish_reason:n,index:r,logprobs:a,...s})=>{if(!n)throw new Un(`missing finish_reason for choice ${r}`);const{content:i=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new Un(`missing role for choice ${r}`);if(o){const{arguments:e,name:l}=o;if(null==e)throw new Un(`missing function_call.arguments for choice ${r}`);if(!l)throw new Un(`missing function_call.name for choice ${r}`);return{...s,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:a}}return l?{...s,index:r,finish_reason:n,logprobs:a,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map(((t,n)=>{const{function:a,type:s,id:i,...o}=t,{arguments:l,name:c,...u}=a||{};if(null==i)throw new Un(`missing choices[${r}].tool_calls[${n}].id\n${gs(e)}`);if(null==s)throw new Un(`missing choices[${r}].tool_calls[${n}].type\n${gs(e)}`);if(null==c)throw new Un(`missing choices[${r}].tool_calls[${n}].function.name\n${gs(e)}`);if(null==l)throw new Un(`missing choices[${r}].tool_calls[${n}].function.arguments\n${gs(e)}`);return{...o,id:i,type:s,function:{...u,name:c,arguments:l}}}))}}:{...s,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:a}})),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Ua(t)?Ma(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(l,t)}(e,fs(this,ns,"f"))},ds=function(){const e=fs(this,ns,"f")?.response_format;return ja(e)?e:null},hs=function(e){var t,n,r,a;let s=fs(this,as,"f");const{choices:i,...o}=e;s?Object.assign(s,o):s=ps(this,as,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:l,logprobs:c=null,...u}of e.choices){let e=s.choices[l];if(e||(e=s.choices[l]={finish_reason:o,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:r,refusal:a,...s}=c;Object.assign(e.logprobs,s),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),a&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...a))}else e.logprobs=Object.assign({},c);if(o&&(e.finish_reason=o,fs(this,ns,"f")&&Ua(fs(this,ns,"f")))){if("length"===o)throw new Xn;if("content_filter"===o)throw new Qn}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...g}=i;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&fs(this,ts,"m",ds).call(this)&&(e.message.parsed=es(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:s,...i}of m){const o=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(o,i),n&&(o.id=n),r&&(o.type=r),s&&(o.function??(o.function={name:s.name??"",arguments:""})),s?.name&&(o.function.name=s.name),s?.arguments&&(o.function.arguments+=s.arguments,Da(fs(this,ns,"f"),o)&&(o.function.parsed_arguments=es(o.function.arguments)))}}}return s},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new tr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function gs(e){return JSON.stringify(e)}class ys extends ms{static fromReadableStream(e){const t=new ys(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new ys(null),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,a))),r}static runTools(e,t,n){const r=new ys(t),a={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,a))),r}}class bs extends Zr{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new Un(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new Un(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>Ma(t,e)))}runFunctions(e,t){return e.stream?ys.runFunctions(this._client,e,t):Wa.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?ys.runTools(this._client,e,t):Wa.runTools(this._client,e,t)}stream(e,t){return ms.createChatCompletion(this._client,e,t)}}class _s extends Zr{constructor(){super(...arguments),this.completions=new bs(this._client)}}!function(e){e.Completions=bs}(_s||(_s={}));var ws,vs,ks,Os,Es,xs,As,Ss,Is,Ts,Ps,Cs,Rs,Ns,js,$s,Ms,Ls,Ds,Us,Fs,zs,Bs,Zs=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},Hs=function(e,t,n,r,a){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?a.call(e,n):a?a.value=n:t.set(e,n),n};class qs extends Na{constructor(){super(...arguments),ws.add(this),vs.set(this,[]),ks.set(this,{}),Os.set(this,{}),Es.set(this,void 0),xs.set(this,void 0),As.set(this,void 0),Ss.set(this,void 0),Is.set(this,void 0),Ts.set(this,void 0),Ps.set(this,void 0),Cs.set(this,void 0),Rs.set(this,void 0)}[(vs=new WeakMap,ks=new WeakMap,Os=new WeakMap,Es=new WeakMap,xs=new WeakMap,As=new WeakMap,Ss=new WeakMap,Is=new WeakMap,Ts=new WeakMap,Ps=new WeakMap,Cs=new WeakMap,Rs=new WeakMap,ws=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0})),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new qs;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=tr.fromReadableStream(e,this.controller);for await(const e of r)Zs(this,ws,"m",Ns).call(this,e);if(r.controller.signal?.aborted)throw new zn;return this._addRun(Zs(this,ws,"m",js).call(this))}toReadableStream(){return new tr(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,a){const s=new qs;return s._run((()=>s._runToolAssistantStream(e,t,n,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}async _createToolAssistantStream(e,t,n,r,a){const s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const i={...r,stream:!0},o=await e.submitToolOutputs(t,n,i,{...a,signal:this.controller.signal});this._connected();for await(const e of o)Zs(this,ws,"m",Ns).call(this,e);if(o.controller.signal?.aborted)throw new zn;return this._addRun(Zs(this,ws,"m",js).call(this))}static createThreadAssistantStream(e,t,n){const r=new qs;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const a=new qs;return a._run((()=>a._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),a}currentEvent(){return Zs(this,Ps,"f")}currentRun(){return Zs(this,Cs,"f")}currentMessageSnapshot(){return Zs(this,Es,"f")}currentRunStepSnapshot(){return Zs(this,Rs,"f")}async finalRunSteps(){return await this.done(),Object.values(Zs(this,ks,"f"))}async finalMessages(){return await this.done(),Object.values(Zs(this,Os,"f"))}async finalRun(){if(await this.done(),!Zs(this,xs,"f"))throw Error("Final run was not received.");return Zs(this,xs,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const a={...t,stream:!0},s=await e.createAndRun(a,{...n,signal:this.controller.signal});this._connected();for await(const e of s)Zs(this,ws,"m",Ns).call(this,e);if(s.controller.signal?.aborted)throw new zn;return this._addRun(Zs(this,ws,"m",js).call(this))}async _createAssistantStream(e,t,n,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const s={...n,stream:!0},i=await e.create(t,s,{...r,signal:this.controller.signal});this._connected();for await(const e of i)Zs(this,ws,"m",Ns).call(this,e);if(i.controller.signal?.aborted)throw new zn;return this._addRun(Zs(this,ws,"m",js).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!Br(t)||!Br(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}for(const e of r){if(!Br(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,a){return await this._createToolAssistantStream(n,e,t,r,a)}}Ns=function(e){if(!this.ended)switch(Hs(this,Ps,e,"f"),Zs(this,ws,"m",Ls).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":Zs(this,ws,"m",zs).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Zs(this,ws,"m",Ms).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":Zs(this,ws,"m",$s).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},js=function(){if(this.ended)throw new Un("stream has ended, this shouldn't happen");if(!Zs(this,xs,"f"))throw Error("Final run has not been received");return Zs(this,xs,"f")},$s=function(e){const[t,n]=Zs(this,ws,"m",Us).call(this,e,Zs(this,Es,"f"));Hs(this,Es,t,"f"),Zs(this,Os,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=Zs(this,As,"f")){if(Zs(this,Ss,"f"))switch(Zs(this,Ss,"f").type){case"text":this._emit("textDone",Zs(this,Ss,"f").text,Zs(this,Es,"f"));break;case"image_file":this._emit("imageFileDone",Zs(this,Ss,"f").image_file,Zs(this,Es,"f"))}Hs(this,As,n.index,"f")}Hs(this,Ss,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==Zs(this,As,"f")){const t=e.data.content[Zs(this,As,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,Zs(this,Es,"f"));break;case"text":this._emit("textDone",t.text,Zs(this,Es,"f"))}}Zs(this,Es,"f")&&this._emit("messageDone",e.data),Hs(this,Es,void 0,"f")}},Ms=function(e){const t=Zs(this,ws,"m",Ds).call(this,e);switch(Hs(this,Rs,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==Zs(this,Is,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(Zs(this,Ts,"f")&&this._emit("toolCallDone",Zs(this,Ts,"f")),Hs(this,Is,e.index,"f"),Hs(this,Ts,t.step_details.tool_calls[e.index],"f"),Zs(this,Ts,"f")&&this._emit("toolCallCreated",Zs(this,Ts,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Hs(this,Rs,void 0,"f"),"tool_calls"==e.data.step_details.type&&Zs(this,Ts,"f")&&(this._emit("toolCallDone",Zs(this,Ts,"f")),Hs(this,Ts,void 0,"f")),this._emit("runStepDone",e.data,t)}},Ls=function(e){Zs(this,vs,"f").push(e),this._emit("event",e)},Ds=function(e){switch(e.event){case"thread.run.step.created":return Zs(this,ks,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=Zs(this,ks,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=qs.accumulateDelta(t,n.delta);Zs(this,ks,"f")[e.data.id]=r}return Zs(this,ks,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":Zs(this,ks,"f")[e.data.id]=e.data}if(Zs(this,ks,"f")[e.data.id])return Zs(this,ks,"f")[e.data.id];throw new Error("No snapshot available")},Us=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=Zs(this,ws,"m",Fs).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Fs=function(e,t){return qs.accumulateDelta(t,e)},zs=function(e){switch(Hs(this,Cs,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Hs(this,xs,e.data,"f"),Zs(this,Ts,"f")&&(this._emit("toolCallDone",Zs(this,Ts,"f")),Hs(this,Ts,void 0,"f"))}};class Gs extends Zr{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return Er(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ys,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Ys extends Vr{}Gs.MessagesPage=Ys;class Ks extends Zr{retrieve(e,t,n,r={},a){return Er(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,n={},r){return Er(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Vs,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Vs extends Vr{}Ks.RunStepsPage=Vs;class Js extends Zr{constructor(){super(...arguments),this.steps=new Ks(this._client)}create(e,t,n){const{include:r,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:a,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return Er(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Ws,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return qs.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Rr(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,n){return qs.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const a=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,a.id,r)}submitToolOutputsStream(e,t,n,r){return qs.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class Ws extends Vr{}Js.RunsPage=Ws,Js.Steps=Ks,Js.RunStepsPage=Vs;class Xs extends Zr{constructor(){super(...arguments),this.runs=new Js(this._client),this.messages=new Gs(this._client)}create(e={},t){return Er(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return qs.createThreadAssistantStream(e,this._client.beta.threads,t)}}Xs.Runs=Js,Xs.RunsPage=Ws,Xs.Messages=Gs,Xs.MessagesPage=Ys;class Qs extends Zr{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return Er(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,ei,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...n,headers:r}).withResponse(),s=a.data;switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Rr(e);break;case"failed":case"completed":return s}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}}class ei extends Vr{}Qs.VectorStoreFilesPage=ei;class ti extends Zr{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return Er(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,ei,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Rr(e);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,s=Math.min(a,t.length),i=this._client,o=t.values(),l=[...n],c=Array(s).fill(o).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},r);l.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(c),await this.createAndPoll(e,{file_ids:l})}}class ni extends Zr{constructor(){super(...arguments),this.files=new Qs(this._client),this.fileBatches=new ti(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Er(e)?this.list({},e):this._client.getAPIList("/vector_stores",ri,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class ri extends Vr{}ni.VectorStoresPage=ri,ni.Files=Qs,ni.VectorStoreFilesPage=ei,ni.FileBatches=ti;class ai extends Zr{constructor(){super(...arguments),this.vectorStores=new ni(this._client),this.chat=new _s(this._client),this.assistants=new ha(this._client),this.threads=new Xs(this._client)}}ai.VectorStores=ni,ai.VectorStoresPage=ri,ai.Assistants=ha,ai.AssistantsPage=pa,ai.Threads=Xs;class si extends Zr{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Er(e)?this.list({},e):this._client.getAPIList("/batches",ii,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class ii extends Vr{}si.BatchesPage=ii;class oi extends Zr{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,hr({body:t,...n}))}}class li extends Zr{constructor(){super(...arguments),this.parts=new oi(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}li.Parts=oi;class ci extends _r{constructor({baseURL:e=$r("OPENAI_BASE_URL"),apiKey:t=$r("OPENAI_API_KEY"),organization:n=$r("OPENAI_ORG_ID")??null,project:r=$r("OPENAI_PROJECT_ID")??null,...a}={}){if(void 0===t)throw new Un("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:n,project:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new Un("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Hr(this),this.chat=new Gr(this),this.embeddings=new Yr(this),this.files=new Jr(this),this.images=new Xr(this),this.audio=new na(this),this.moderations=new ra(this),this.models=new aa(this),this.fineTuning=new da(this),this.beta=new ai(this),this.batches=new si(this),this.uploads=new li(this),this._options=s,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let n=e;const r=function(e=wn){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||wn.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=ln;if(void 0!==e.format){if(!fn.call(cn,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=cn[n];let a,s=wn.filter;if(("function"==typeof e.filter||gn(e.filter))&&(s=e.filter),a=e.arrayFormat&&e.arrayFormat in mn?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":wn.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||wn.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:wn.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:wn.allowEmptyArrays,arrayFormat:a,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:wn.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?wn.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:wn.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:wn.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:wn.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:wn.encodeValuesOnly,filter:s,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:wn.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:wn.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:wn.strictNullHandling}}(t);let a,s;"function"==typeof r.filter?(s=r.filter,n=s("",n)):gn(r.filter)&&(s=r.filter,a=s);const i=[];if("object"!=typeof n||null===n)return"";const o=mn[r.arrayFormat],l="comma"===o&&r.commaRoundTrip;a||(a=Object.keys(n)),r.sort&&a.sort(r.sort);const c=new WeakMap;for(let e=0;e<a.length;++e){const t=a[e];r.skipNulls&&null===n[t]||bn(i,kn(n[t],t,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const u=i.join(r.delimiter);let d=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}(e,{arrayFormat:"brackets"})}}Bs=ci,ci.OpenAI=Bs,ci.DEFAULT_TIMEOUT=6e5,ci.OpenAIError=Un,ci.APIError=Fn,ci.APIConnectionError=Bn,ci.APIConnectionTimeoutError=Zn,ci.APIUserAbortError=zn,ci.NotFoundError=Yn,ci.ConflictError=Kn,ci.RateLimitError=Jn,ci.BadRequestError=Hn,ci.AuthenticationError=qn,ci.InternalServerError=Wn,ci.PermissionDeniedError=Gn,ci.UnprocessableEntityError=Vn,ci.toFile=lr,ci.fileFromPath=Cn,ci.Completions=Hr,ci.Chat=Gr,ci.Embeddings=Yr,ci.Files=Jr,ci.FileObjectsPage=Wr,ci.Images=Xr,ci.Audio=na,ci.Moderations=ra,ci.Models=aa,ci.ModelsPage=sa,ci.FineTuning=da,ci.Beta=ai,ci.Batches=si,ci.BatchesPage=ii,ci.Uploads=li,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations"]);var ui=n(7765);function di(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=(0,nn.d)(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new Zt([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function hi(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function pi(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class fi extends Wt{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const n=e[0].message;let r;if((0,ui.KX)(n)&&n.tool_calls?.length?r=n.tool_calls.map((e=>{const{id:t,...n}=e;return this.returnId?{id:t,...n}:n})):void 0!==n.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map((e=>di(e,{returnId:this.returnId,partial:t})))),!r)return[];const a=[];for(const e of r)if(void 0!==e){const t={type:e.name,args:e.args,id:e.id};a.push(t)}return a}}class mi extends fi{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Zt(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter((e=>e.type===this.keyName));let n=t;if(t.length)return this.returnId||(n=t.map((e=>e.args))),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter((e=>e.type===this.keyName));let n=t;if(!t.length)return;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function gi(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function yi(e,t,n,r,a){e[t]=n,gi(e,t,r,a)}function bi(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>bi(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return _i(e,t)}}const _i=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":yi(n,"minimum",r.value,r.message,t);break;case"max":yi(n,"maximum",r.value,r.message,t)}return n};let wi;const vi={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===wi&&(wi=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),wi),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function ki(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?Oi(e):e}if(e.checks)for(const a of e.checks)switch(a.kind){case"min":yi(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t);break;case"max":yi(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Ei(n,"email",a.message,t);break;case"format:idn-email":Ei(n,"idn-email",a.message,t);break;case"pattern:zod":xi(n,vi.email,a.message,t)}break;case"url":Ei(n,"uri",a.message,t);break;case"uuid":Ei(n,"uuid",a.message,t);break;case"regex":xi(n,a.regex,a.message,t);break;case"cuid":xi(n,vi.cuid,a.message,t);break;case"cuid2":xi(n,vi.cuid2,a.message,t);break;case"startsWith":xi(n,RegExp(`^${r(a.value)}`),a.message,t);break;case"endsWith":xi(n,RegExp(`${r(a.value)}$`),a.message,t);break;case"datetime":Ei(n,"date-time",a.message,t);break;case"date":Ei(n,"date",a.message,t);break;case"time":Ei(n,"time",a.message,t);break;case"duration":Ei(n,"duration",a.message,t);break;case"length":yi(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,a.value):a.value,a.message,t),yi(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,a.value):a.value,a.message,t);break;case"includes":xi(n,RegExp(r(a.value)),a.message,t);break;case"ip":"v6"!==a.version&&Ei(n,"ipv4",a.message,t),"v4"!==a.version&&Ei(n,"ipv6",a.message,t);break;case"emoji":xi(n,vi.emoji,a.message,t);break;case"ulid":xi(n,vi.ulid,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Ei(n,"binary",a.message,t);break;case"contentEncoding:base64":yi(n,"contentEncoding","base64",a.message,t);break;case"pattern:zod":xi(n,vi.base64,a.message,t)}break;case"nanoid":xi(n,vi.nanoid,a.message,t)}return n}const Oi=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),Ei=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):yi(e,"format",t,n,r)},xi=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Ai(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):yi(e,"pattern",Ai(t,r),n,r)},Ai=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),a=n.flags.includes("m"),s=n.flags.includes("s"),i=r?n.source.toLowerCase():n.source;let o="",l=!1,c=!1,u=!1;for(let e=0;e<i.length;e++)if(l)o+=i[e],l=!1;else{if(r)if(c){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(a){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}s&&"."===i[e]?o+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?l=!0:c&&"]"===i[e]?c=!1:c||"["!==i[e]||(c=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function Si(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===Qt.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:Ni(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Ni(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===Qt.kY.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(ki(e.keyType._def,t)).reduce(((e,[t,n])=>"type"===t?e:{...e,[t]:n}),{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===Qt.kY.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Ii={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Ti=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>Ni(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function Pi(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Ni(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Ni(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}const Ci=Symbol("Let zodToJsonSchema decide on which parser to use"),Ri={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Ni(e,t,n=!1){const r=t.seen.get(e);if(t.override){const a=t.override?.(e,t,r,n);if(a!==Ci)return a}if(r&&!n){const e=ji(r,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const s=Mi(e,e.typeName,t,n);return s&&Li(e,t,s),a.jsonSchema=s,s}const ji=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:$i(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},$i=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Mi=(e,t,n,r)=>{switch(t){case Qt.kY.ZodString:return ki(e,n);case Qt.kY.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",gi(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?yi(n,"minimum",r.value,r.message,t):yi(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),yi(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?yi(n,"maximum",r.value,r.message,t):yi(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),yi(n,"maximum",r.value,r.message,t));break;case"multipleOf":yi(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Qt.kY.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const a=Ni(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===a?e:{properties:{...e.properties,[n]:a},required:r.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:Pi(e,t)};return n.required.length||delete n.required,n}(e,n);case Qt.kY.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?yi(n,"minimum",r.value,r.message,t):yi(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),yi(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?yi(n,"maximum",r.value,r.message,t):yi(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),yi(n,"maximum",r.value,r.message,t));break;case"multipleOf":yi(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case Qt.kY.ZodBoolean:return{type:"boolean"};case Qt.kY.ZodDate:return bi(e,n);case Qt.kY.ZodUndefined:return{not:{}};case Qt.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case Qt.kY.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==Qt.kY.ZodAny&&(n.items=Ni(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&yi(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&yi(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(yi(n,"minItems",e.exactLength.value,e.exactLength.message,t),yi(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case Qt.kY.ZodUnion:case Qt.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Ti(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in Ii&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=Ii[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return Ti(e,t)}(e,n);case Qt.kY.ZodIntersection:return function(e,t){const n=[Ni(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Ni(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),a.length?{allOf:a,...r}:void 0}(e,n);case Qt.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>Ni(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:Ni(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>Ni(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case Qt.kY.ZodRecord:return Si(e,n);case Qt.kY.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case Qt.kY.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case Qt.kY.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])),r=n.map((e=>t[e])),a=Array.from(new Set(r.map((e=>typeof e))));return{type:1===a.length?"string"===a[0]?"string":"number":["string","number"],enum:r}}(e);case Qt.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:Ii[e.innerType._def.typeName],nullable:!0}:{type:[Ii[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Ni(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Ni(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case Qt.kY.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Ni(e.innerType._def,t);const n=Ni(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case Qt.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?Si(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Ni(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Ni(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case Qt.kY.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Ni(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&yi(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&yi(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case Qt.kY.ZodLazy:return Ni(e.getter()._def,n);case Qt.kY.ZodPromise:return function(e,t){return Ni(e.type._def,t)}(e,n);case Qt.kY.ZodNaN:case Qt.kY.ZodNever:return{not:{}};case Qt.kY.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?Ni(e.schema._def,t,n):{}}(e,n,r);case Qt.kY.ZodAny:case Qt.kY.ZodUnknown:return{};case Qt.kY.ZodDefault:return function(e,t){return{...Ni(e.innerType._def,t),default:e.defaultValue()}}(e,n);case Qt.kY.ZodBranded:return function(e,t){return Ni(e.type._def,t)}(e,n);case Qt.kY.ZodReadonly:case Qt.kY.ZodCatch:return((e,t)=>Ni(e.innerType._def,t))(e,n);case Qt.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Ni(e.in._def,t);if("output"===t.pipeStrategy)return Ni(e.out._def,t);const n=Ni(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Ni(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case Qt.kY.ZodFunction:case Qt.kY.ZodVoid:case Qt.kY.ZodSymbol:default:return}},Li=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Di=e=>"_def"in e?e._def:e,Ui=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...Ri,basePath:["#"],definitions:{},name:e}:{...Ri,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[Di(n),{def:Di(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}})(t),r="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,a=Ni(e._def,void 0===r?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},s="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(a.title=s);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let r=0;r<500;r++){const r=Object.entries(n.definitions).filter((([e])=>!t.has(e)));if(0===r.length)break;for(const[a,s]of r)e[a]=Ni(Di(s),{...n,currentPath:[...n.basePath,n.definitionPath,a]},!0)??{},t.add(a)}return e})(),o=void 0===r?i?{...a,[n.definitionPath]:i}:a:"duplicate-ref"===n.nameStrategy?{...a,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:a}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Fi(e,t){return Ui(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function zi(e,t,n){return function(t,n){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),r}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:Fi(e,{name:t})}})}function Bi(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function Zi(e){let t;return e.constructor.name===Zn.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===zn.name?(t=new Error(e.message),t.name="AbortError"):t=400===e.status&&e.message.includes("tool_calls")?Bi(e,"INVALID_TOOL_RESULTS"):401===e.status?Bi(e,"MODEL_AUTHENTICATION"):429===e.status?Bi(e,"MODEL_RATE_LIMIT"):404===e.status?Bi(e,"MODEL_NOT_FOUND"):e,t}function Hi(e,t){const n=[];for(const[r,a]of Object.entries(e.properties??{}))a.description&&t<2&&n.push(`// ${a.description}`),e.required?.includes(r)?n.push(`${r}: ${qi(a,t)},`):n.push(`${r}?: ${qi(a,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function qi(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map((e=>qi(e,t))).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Hi(e,t+2),"}"].join("\n");case"array":return e.items?`${qi(e.items,t)}[]`:"any[]";default:return""}}function Gi(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Xe.cM.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function Yi(e,t,n){const r=e.tool_calls;if("assistant"===e.role){const a=[],s=[];for(const e of r??[])try{a.push(di(e,{returnId:!0}))}catch(t){s.push(pi(e,t.message))}const i={function_call:e.function_call,tool_calls:r};void 0!==n&&(i.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new Xe.Od({content:e.content||"",tool_calls:a,invalid_tool_calls:s,additional_kwargs:i,response_metadata:o,id:t.id})}return new Xe.cM(e.content||"",e.role??"unknown")}function Ki(e,t,n,r){const a=e.role??n,s=e.content??"";let i;i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},r&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if("user"===a)return new Xe.a7({content:s,response_metadata:o});if("assistant"===a){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new Xe.H({content:s,tool_call_chunks:n,additional_kwargs:i,id:t.id,response_metadata:o})}return"system"===a?new Xe.uU({content:s,response_metadata:o}):"developer"===a?new Xe.uU({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):"function"===a?new Xe.FK({content:s,additional_kwargs:i,name:e.name,response_metadata:o}):"tool"===a?new Xe.dr({content:s,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new Xe.XU({content:s,role:a,response_metadata:o})}function Vi(e,t){return e.flatMap((e=>{let n=Gi(e);"system"===n&&t?.startsWith("o1")&&(n="developer");const r={role:n,content:e.content};return null!=e.name&&(r.name=e.name),null!=e.additional_kwargs.function_call&&(r.function_call=e.additional_kwargs.function_call,r.content=null),(0,Xe.KX)(e)&&e.tool_calls?.length?(r.tool_calls=e.tool_calls.map(hi),r.content=null):(null!=e.additional_kwargs.tool_calls&&(r.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(r.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio?[r,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:r}))}function Ji(e,t){return Ot(e)?void 0!==t?.strict?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let n;if(Lt(e)){const a=function(e,{parser:t,callback:n}){const r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:n,enumerable:!1}}),r}({type:"function",function:{name:(r={name:e.name,parameters:e.schema,description:e.description}).name,parameters:Fi(r.parameters,{name:r.name}),strict:!0,...r.description?{description:r.description}:void 0}},{callback:r.function,parser:e=>r.parameters.parse(JSON.parse(e))});n=a.function.parameters?{type:a.type,function:{name:a.function.name,description:a.function.description,parameters:a.function.parameters,...void 0!==t?.strict?{strict:t.strict}:{}}}:{type:"function",function:Mt(e,t)}}else n=e;var r;return void 0!==t?.strict&&(n.function.strict=t.strict),n}(e,t)}class Wi extends Rt{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,Je.Az)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,Je.Az)("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,Je.Az)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??(0,Je.Az)("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,Je.Az)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,Je.Az)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,Je.Az)("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??(0,Je.Az)("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){const e=this.azureOpenAIBasePath.split("/openai/deployments/");if(2===e.length){const[,t]=e;this.azureOpenAIApiDeploymentName=t}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},void 0!==e?.supportsStrictToolCalling&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let n;return void 0!==t?.strict?n=t.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this.bind({tools:e.map((e=>Ji(e,{strict:n}))),...t})}createResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&Xi(e.json_schema.schema)?zi(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let n;void 0!==e?.strict?n=e.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling);let r={};void 0!==e?.stream_options?r={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(r={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map((e=>Ji(e,{strict:n}))):void 0,tool_choice:(s=e?.tool_choice,s?"any"===s||"required"===s?"required":"auto"===s?"auto":"none"===s?"none":"string"==typeof s?{type:"function",function:{name:s}}:s:void 0),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...r,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};var s;void 0!==e?.prediction&&(a.prediction=e.prediction);const i=e?.reasoning_effort??this.reasoningEffort;return void 0!==i&&(a.reasoning_effort=i),a}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=Vi(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let s;const i=await this.completionWithRetry(a,t);let o;for await(const e of i){const r=e?.choices?.[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:a}=r;if(!a)continue;const i=Ki(a,e,s,this.__includeRawResponse);s=a.role??s;const l={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...l};null!=r.finish_reason&&(c.finish_reason=r.finish_reason,c.system_fingerprint=e.system_fingerprint,c.model_name=e.model),this.logprobs&&(c.logprobs=r.logprobs);const u=new Qe.Cf({message:i,text:i.content,generationInfo:c});yield u,await(n?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u}))}if(o){const e={...null!==o.prompt_tokens_details?.audio_tokens&&{audio:o.prompt_tokens_details?.audio_tokens},...null!==o.prompt_tokens_details?.cached_tokens&&{cache_read:o.prompt_tokens_details?.cached_tokens}},t={...null!==o.completion_tokens_details?.audio_tokens&&{audio:o.completion_tokens_details?.audio_tokens},...null!==o.completion_tokens_details?.reasoning_tokens&&{reasoning:o.completion_tokens_details?.reasoning_tokens}},n=new Qe.Cf({message:new Xe.H({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield n}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},a=this.invocationParams(t),s=Vi(e,this.model);if(a.stream){const a=this._streamResponseChunks(e,t,n),s={};for await(const e of a){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const i=Object.entries(s).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:l}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,o,l),u=await this.getNumTokensFromGenerations(i);return r.input_tokens=c,r.output_tokens=u,r.total_tokens=c+u,{generations:i,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options});const{completion_tokens:n,prompt_tokens:i,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:c}=e?.usage??{};n&&(r.output_tokens=(r.output_tokens??0)+n),i&&(r.input_tokens=(r.input_tokens??0)+i),o&&(r.total_tokens=(r.total_tokens??0)+o),null===l?.audio_tokens&&null===l?.cached_tokens||(r.input_token_details={...null!==l?.audio_tokens&&{audio:l?.audio_tokens},...null!==l?.cached_tokens&&{cache_read:l?.cached_tokens}}),null===c?.audio_tokens&&null===c?.reasoning_tokens||(r.output_token_details={...null!==c?.audio_tokens&&{audio:c?.audio_tokens},...null!==c?.reasoning_tokens&&{reasoning:c?.reasoning_tokens}});const u=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:Yi(t.message??{role:"assistant"},e,this.__includeRawResponse)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,Xe.KX)(n.message)&&(n.message.usage_metadata=r),n.message=new Xe.Od(Object.fromEntries(Object.entries(n.message).filter((([e])=>!e.startsWith("lc_"))))),u.push(n)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(Hi(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const a=await Promise.all(e.map((async e=>{const a=await this.getNumTokens(e.content),s=await this.getNumTokens(Gi(e)),i=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=a+n+s+i;const l=e;if("function"===l._getType()&&(o-=2),l.additional_kwargs?.function_call&&(o+=3),l?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(l.additional_kwargs.function_call?.name)),l.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(l.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(l.additional_kwargs.function_call)),o+=await this.getNumTokens(l.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){throw Zi(e)}}))}async betaParsedCompletionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.beta.chat.completions.parse(e,n)}catch(e){throw Zi(e)}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=e;if((r||i)&&a&&t)return`${a}/${t}`;if((r||i)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return s}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new ci(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,a,s;var i;let o,l;if(void 0!==(i=e)&&"object"==typeof i.schema?(n=e.schema,r=e.name,a=e.method,s=e.includeRaw):(n=e,r=t?.name,a=t?.method,s=t?.includeRaw),void 0!==t?.strict&&"jsonMode"===a)throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if("jsonMode"===a)o=this.bind({response_format:{type:"json_object"}}),l=Xi(n)?en.fromZodSchema(n):new rn;else if("jsonSchema"===a)o=this.bind({response_format:{type:"json_schema",json_schema:{name:r??"extract",description:n.description,schema:n,strict:t?.strict}}}),l=Xi(n)?en.fromZodSchema(n):new rn;else{let e=r??"extract";if(Xi(n)){const r=(0,We.Ik)(n);o=this.bind({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),l=new mi({returnSingle:!0,keyName:e,zodSchema:n})}else{let r;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(r=n,e=n.name):(e=n.title??e,r={name:e,description:n.description??"",parameters:n}),o=this.bind({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),l=new mi({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(l);const c=Tt.assign({parsed:(e,t)=>l.invoke(e.raw,t)}),u=Tt.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[u]});return kt.zZ.from([{raw:o},d])}}function Xi(e){return"function"==typeof e?.parse}var Qi=n(8009),eo=(n(4350),n(199));class to extends Et{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let n,r,a=(0,It.ZI)(t);return(0,eo.K)(e)?(n=e.id,r=e.args,a={...a,toolCall:e,configurable:{...a.configurable,tool_call_id:n}}):r=e,this.call(r,a)}async call(e,t,n){let r;try{r=await this.schema.parseAsync(e)}catch(t){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.message}`),new eo.q(n,JSON.stringify(e))}const a=(0,At.H_)(t),s=At.Td.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),i=await(s?.handleToolStart(this.toJSON(),"string"==typeof r?r:JSON.stringify(r),a.runId,void 0,void 0,void 0,a.runName));let o,l,c,u;delete a.runId;try{o=await this._call(r,i,a)}catch(e){throw await(i?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(o)||2!==o.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(o)}`);[l,c]=o}else l=o;a&&"configurable"in a&&(u=a.configurable.tool_call_id);const d=function(e){const{content:t,artifact:n,toolCallId:r}=e;return r&&!(0,Qi.fK)(t)?"string"==typeof t||Array.isArray(t)&&t.every((e=>"object"==typeof e))?new Qi.uf({content:t,artifact:n,tool_call_id:r,name:e.name}):new Qi.uf({content:ro(t),artifact:n,tool_call_id:r,name:e.name}):t}({content:l,artifact:c,toolCallId:u,name:this.name});return await(i?.handleToolEnd(d)),d}}class no extends to{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Qt.z.object({input:Qt.z.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function ro(e){try{return JSON.stringify(e,null,2)}catch(t){return`${e}`}}Object.defineProperty(class extends no{static lc_name(){return"DallEAPIWrapper"}constructor(e){void 0!==e?.responseFormat&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??(0,Je.Az)("OPENAI_API_KEY"),organization:e?.organization??(0,Je.Az)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new ci(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap((e=>e.data.flatMap((e=>e.url?{type:"image_url",image_url:e.url}:[])).filter((e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)))):e.flatMap((e=>e.data.flatMap((e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[])).filter((e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))))}async _call(e){const t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){const e=await Promise.all(Array.from({length:this.n}).map((()=>this.client.images.generate(t))));return this.processMultipleGeneratedUrls(e)}const n=await this.client.images.generate(t);let r="";return"url"===this.dallEResponseFormat?[r]=n.data.map((e=>e.url)).filter((e=>"undefined"!==e)):[r]=n.data.map((e=>e.b64_json)).filter((e=>"undefined"!==e)),r}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var ao=n(6993),so=n(3766);n(2771),ao.m,n(3650),n(329),n(9849),n(6279),so.RZ;var io=(new(0,n(6445).ij)("AIzaSyBkLwxYev4XNsZ4KjZZR4iZZVPVNKIQwSY"),[]);chrome.runtime.onMessage.addListener((function(e,t,n){if(console.log(t.tab?"from a background:"+t.tab.url:"from the extension"),"user-query"===e.type)return console.log("received"),console.log(e.query),function(e,t,n,r,a,s){var i,o,l,c;void 0===t&&(t="gemini-1.5-flash"),void 0===n&&(n="AIzaSyBkLwxYev4XNsZ4KjZZR4iZZVPVNKIQwSY"),i=this,o=void 0,c=function(){var i,o,l;return function(e,t){var n,r,a,s,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!((a=(a=i.trys).length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}(this,(function(c){switch(c.label){case 0:return i="Gemini"===e?new on({model:t,temperature:0,apiKey:n}):new Wi({model:t,temperature:0,apiKey:n}),[4,so.RZ.fromMessages([["system","\n\t\tYou are a helpful AI assistant that improves the user's experience in web browsing.\n\t\tUsers will select texts from a website, that user needs help on. Like explaining it more,\n\t\tor summarizing it or other tasks the user needs. Your job is to follow the user instruction,\n\t\tbe helpful and make the user life easier.\n\n\t\tThe texts from the website: {context}\n\t\t"],new so.GL("chat_history"),["human","User instruction: {query}"]]).pipe(i).pipe(new Xt).invoke({context:a,chat_history:io,query:r})];case 1:return o=c.sent(),io.push(new Xe.xc(r)),io.push(o),console.log(io),l=se.parse(o),s({md:l}),[2]}}))},new((l=void 0)||(l=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function r(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):function(e){return e instanceof l?e:new l((function(t){t(e)}))}(t.value).then(n,r)}a((c=c.apply(i,o||[])).next())}))}(e.modelType,e.model,e.apiKey,e.query,e.kb,n),!0})),chrome.tabs.onUpdated.addListener((function(e,t,n){"complete"===t.status&&n.active&&(io=[])}))})()})();